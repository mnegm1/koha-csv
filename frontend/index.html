<!DOCTYPE html>
<html lang="ar" dir="auto">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ECSSR AI Assistant</title>
<style>
  :root{
    --brand:#BF9849;
    --logo-url:url("https://assets.almanhal.com/platform/shared/Product/ECSSR/middlelogo.png");
    --fab-size:56px;
  }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#F3EFED;margin:0;padding:2rem}
  
  .fab-wrap{position:fixed;right:18px;bottom:18px;z-index:9999}
  .fab{width:var(--fab-size);height:var(--fab-size);background:#fff var(--logo-url) center/130% no-repeat;
    border:4px solid #BF9849;border-radius:50%;cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,.25)}
  
  .box{position:fixed;right:18px;bottom:calc(18px + var(--fab-size) + 12px);
    width:min(620px,94vw);max-height:85vh;background:#fff;border-radius:14px;
    box-shadow:0 16px 40px rgba(0,0,0,.25);display:none;flex-direction:column;overflow:hidden;z-index:9999}
  
  .head{background:linear-gradient(135deg,#BF9849,#D4AB5E);color:#fff;padding:12px 16px;font-weight:600;
    display:flex;justify-content:space-between;align-items:center}
  .close{background:none;border:none;color:#fff;font-size:20px;cursor:pointer}
  
  .status{font-size:12px;padding:8px 12px;background:#fafafa;border-bottom:1px solid #e8eef3}
  .body{padding:10px;overflow:auto;flex:1}
  
  .mode-toggle{display:flex;gap:6px;padding:8px;background:#fff;border-bottom:1px solid #e8eef3}
  .mode-btn{flex:1;padding:8px;border:none;background:transparent;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s;color:#666}
  .mode-btn.active{background:#BF9849;color:#fff}
  
  .row{background:#f6f9fc;border:1px solid #e7edf4;border-radius:12px;padding:12px;margin:10px 0;position:relative}
  .row:hover{box-shadow:0 4px 12px rgba(0,0,0,0.08);border-color:#BF9849}
  .meta{opacity:.85;font-size:12px;margin-top:6px}
  
  .translate-icon{position:absolute;top:12px;right:12px;background:#fff;border:1px solid #e0e0e0;
    border-radius:6px;padding:4px 8px;font-size:11px;cursor:pointer;transition:all 0.2s}
  .translate-icon:hover{background:#BF9849;color:#fff;border-color:#BF9849}
  .translated{background:#e8f4f8;padding:8px;margin-top:8px;border-radius:6px;font-size:13px;border-left:3px solid #BF9849}
  
  .input-wrap{padding:10px;background:#fafafa;border-top:1px solid #e8eef3}
  .input{display:flex;gap:8px}
  .input input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #cfd9e3}
  .input button{background:#BF9849;color:#fff;border:none;border-radius:10px;padding:10px 16px;
    font-weight:600;cursor:pointer}
  .input button:disabled{opacity:.5}
  
  .btn{background:#BF9849;color:#fff;padding:6px 12px;border-radius:8px;text-decoration:none;
    font-weight:600;font-size:12px;display:inline-block}
  .btn:hover{background:#D4AB5E}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  
  .info{background:#e8f4f8;border-left:4px solid #BF9849;padding:10px;margin:10px 0;border-radius:8px;font-size:13px}
  .message{margin:12px 0;display:flex;gap:10px}
  .message.user{flex-direction:row-reverse}
  .message-avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px}
  .message.user .message-avatar{background:linear-gradient(135deg,#BF9849,#D4AB5E);color:#fff}
  .message.ai .message-avatar{background:#f0f0f0;color:#666}
  .message-content{max-width:80%;padding:10px 14px;border-radius:12px;line-height:1.5;font-size:14px}
  .message.user .message-content{background:#BF9849;color:#fff;border-bottom-right-radius:4px}
  .message.ai .message-content{background:#f6f9fc;color:#333;border-bottom-left-radius:4px}
</style>
</head>
<body>
  <div class="fab-wrap">
    <button class="fab" id="fab"></button>
  </div>

  <div class="box" id="box">
    <div class="head">
      <div>ECSSR AI Assistant</div>
      <button class="close" id="close">Ã—</button>
    </div>
    
    <div class="mode-toggle">
      <button class="mode-btn" data-mode="chat">ğŸ’¬ Ask Library</button>
      <button class="mode-btn active" data-mode="search">ğŸ” Search</button>
    </div>
    
    <div class="status" id="status">Loading...</div>
    <div class="body" id="body"></div>
    
    <div class="input-wrap">
      <div class="input">
        <input id="q" type="text" placeholder="Ø§Ø¨Ø­Ø«: Ù…Ø¤Ù„ÙØŒ Ø¹Ù†ÙˆØ§Ù†ØŒ Ù…ÙˆØ¶ÙˆØ¹ / Search: author, title, subject" dir="auto">
        <button id="go">Send</button>
      </div>
    </div>
  </div>

<script>
const DATA_URL = "./opac-catalog.tab";
let INDEX = [];
let LOADED = false;
let CURRENT_MODE = 'search';
let CHAT_FAQS = []; // Will hold FAQs later

const fab = document.getElementById("fab");
const box = document.getElementById("box");
const close = document.getElementById("close");
const body = document.getElementById("body");
const status = document.getElementById("status");
const q = document.getElementById("q");
const go = document.getElementById("go");

// Mode switching
document.querySelectorAll('.mode-btn').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    CURRENT_MODE = btn.dataset.mode;
    body.innerHTML = "";
    
    if(CURRENT_MODE === 'chat') {
      q.placeholder = "Ø§Ø³Ø£Ù„ Ø£ÙŠ Ø³Ø¤Ø§Ù„ / Ask any question...";
      showChatWelcome();
    } else {
      q.placeholder = "Ø§Ø¨Ø­Ø«: Ù…Ø¤Ù„ÙØŒ Ø¹Ù†ÙˆØ§Ù†ØŒ Ù…ÙˆØ¶ÙˆØ¹ / Search: author, title, subject";
    }
  };
});

fab.onclick = () => { 
  box.style.display = box.style.display === "flex" ? "none" : "flex";
  if(box.style.display === "flex") {
    ensureLoaded();
    setTimeout(() => q.focus(), 50);
  }
};
close.onclick = () => box.style.display = "none";

function setBusy(busy) {
  go.disabled = busy;
  q.disabled = busy;
  status.textContent = busy ? "Searching..." : `âœ… ${INDEX.length} books loaded`;
}

// Arabic normalization (IMPROVED)
function norm(s){
  if(!s) return "";
  s = String(s).toLowerCase().trim();
  
  // Remove BOM and control characters
  s = s.replace(/^\uFEFF/, "").replace(/[\u200E\u200F\u202A-\u202E]/g, "");
  
  try{s=s.normalize("NFKD");}catch(e){}
  
  // Arabic normalization
  s = s
    .replace(/[Ø¥Ø£Ø¢Ù±]/g,"Ø§")
    .replace(/[Ù‰ÛŒØ¦]/g,"ÙŠ")
    .replace(/Ø©/g,"Ù‡")
    .replace(/Ú©/g,"Ùƒ")
    .replace(/Ø¤/g,"Ùˆ")
    .replace(/\bØ¹Ø¨Ø¯\s+Ø§Ù„/g,"Ø¹Ø¨Ø¯Ø§Ù„")
    .replace(/[\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06ED\u0640]/g,"") // Remove diacritics
    .replace(/[\u0660-\u0669]/g,d=>String(d.charCodeAt(0)-0x0660)) // Arabic to Western digits
    .replace(/[\u06F0-\u06F9]/g,d=>String(d.charCodeAt(0)-0x06F0)) // Persian to Western digits
    .replace(/[^\p{L}\p{N}\s]/gu," ") // Keep only letters, numbers, spaces
    .replace(/\s+/g," ") // Normalize spaces
    .trim();
  
  return s;
}

function isArabic(s){ return /[\u0600-\u06FF]/.test(s||""); }

// Load catalog (FIXED - correct counting)
async function ensureLoaded(){
  if(LOADED) return;
  try{
    setBusy(true);
    const resp = await fetch(DATA_URL);
    if(!resp.ok) throw new Error(`Error ${resp.status}`);
    const text = await resp.text();
    
    const lines = text.split(/\r?\n/).filter(line => line.trim()); // FIXED: Filter empty lines
    if(lines.length < 2) throw new Error("Empty catalog");
    
    const headers = lines[0].split("\t").map(h => h.toLowerCase().trim());
    
    // FIXED: Start from 1, not 0 (skip header)
    for(let i=1; i<lines.length; i++){
      const cols = lines[i].split("\t");
      if(cols.length < 2) continue; // Skip invalid rows
      
      const rec = {};
      headers.forEach((h, idx) => {
        rec[h] = (cols[idx] || "").trim();
      });
      
      // Extract fields
      const title = rec["full title"] || rec["title"] || rec["Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"] || "";
      const author = rec["author"] || rec["Ø§Ù„Ù…Ø¤Ù„Ù"] || "";
      const otherAuthor = rec["other author"] || rec["Ø§Ù„Ù…Ø¤Ù„Ù Ø§Ù„Ø¢Ø®Ø±"] || "";
      const corporate = rec["corporate name"] || rec["Ø¬Ù‡Ø© Ù…Ø¤Ø³Ø³ÙŠØ©"] || "";
      const subject = rec["subjects"] || rec["subject"] || rec["Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹Ø§Øª"] || "";
      const summary = rec["abstract"] || rec["summary"] || rec["Ø§Ù„Ù…Ù„Ø®Øµ"] || "";
      const content = rec["content"] || rec["contents"] || rec["Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª"] || "";
      const pubData = rec["publications data"] || rec["Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø±"] || "";
      const bookUrl = rec["book_url"] || rec["book url"] || rec["Ø±Ø§Ø¨Ø· Ø§Ù„ÙƒØªØ§Ø¨"] || "";
      const year = rec["year"] || rec["Ø§Ù„Ø³Ù†Ø©"] || (pubData.match(/(19|20)\d{2}/)||[""])[0];
      const publisher = pubData.replace(/\b(19|20)\d{2}\b/g,"").replace(/[ØŒ,:-]\s*$/,"").trim();
      
      INDEX.push({
        id: INDEX.length, // FIXED: Use INDEX.length, not i-1
        title,
        author,
        otherAuthor,
        corporate,
        subject,
        summary,
        content,
        publisher,
        year,
        bookUrl,
        // Normalized for search
        nTitle: norm(title),
        nAuthor: norm(author + " " + otherAuthor + " " + corporate),
        nSubject: norm(subject),
        nSummary: norm(summary + " " + content),
        nYear: norm(year),
        nPublisher: norm(publisher)
      });
    }
    
    LOADED = true;
    status.textContent = `âœ… ${INDEX.length} books loaded`;
  }catch(e){
    status.textContent = `âŒ Error: ${e.message}`;
    console.error(e);
  }finally{
    setBusy(false);
  }
}

// Translation function (free API)
async function translateText(text, targetLang) {
  try {
    const sourceLang = isArabic(text) ? 'ar' : 'en';
    if(sourceLang === targetLang) return text; // No need to translate
    
    const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${sourceLang}|${targetLang}`;
    const response = await fetch(url);
    const data = await response.json();
    
    if(data.responseData && data.responseData.translatedText) {
      return data.responseData.translatedText;
    }
    throw new Error("Translation failed");
  } catch(error) {
    console.error("Translation error:", error);
    return null;
  }
}

// Add translate button to each record
async function translateRecord(recordId, field, button) {
  const book = INDEX.find(b => b.id === recordId);
  if(!book) return;
  
  const text = book[field];
  if(!text) return;
  
  button.textContent = "â³ Translating...";
  button.disabled = true;
  
  const targetLang = isArabic(text) ? 'en' : 'ar';
  const translated = await translateText(text, targetLang);
  
  if(translated) {
    const translatedDiv = document.createElement('div');
    translatedDiv.className = 'translated';
    translatedDiv.innerHTML = `<strong>${isArabic(translated) ? 'Ø§Ù„ØªØ±Ø¬Ù…Ø©:' : 'Translation:'}</strong> ${translated}`;
    button.parentElement.appendChild(translatedDiv);
    button.remove();
  } else {
    button.textContent = "ğŸŒ Translate";
    button.disabled = false;
    alert("Translation failed. Please try again.");
  }
}

// Show chat welcome (for FAQs feature)
function showChatWelcome() {
  body.innerHTML = `
    <div class="message ai">
      <div class="message-avatar">ğŸ¤–</div>
      <div class="message-content">
        Ù…Ø±Ø­Ø¨Ø§Ù‹! ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ:<br>
        â€¢ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒØªØ¨<br>
        â€¢ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©<br>
        â€¢ ØªÙ‚Ø¯ÙŠÙ… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ù…ÙƒØªØ¨Ø©<br><br>
        Hello! I can help you with:<br>
        â€¢ Finding books<br>
        â€¢ Answering FAQs<br>
        â€¢ Library information
      </div>
    </div>
  `;
}

// Search function (IMPROVED)
function search(query){
  body.innerHTML = "";
  setBusy(true);
  
  const nq = norm(query);
  if(!nq){
    setBusy(false);
    return;
  }
  
  console.log("Normalized query:", nq); // Debug
  
  // Search ALL books with improved matching
  const results = [];
  for(const book of INDEX){
    let score = 0;
    
    // Exact match = higher score
    if(book.nTitle === nq) score += 200;
    else if(book.nTitle.includes(nq)) score += 100;
    
    if(book.nAuthor === nq) score += 160;
    else if(book.nAuthor.includes(nq)) score += 80;
    
    if(book.nSubject.includes(nq)) score += 60;
    if(book.nSummary.includes(nq)) score += 40;
    if(book.nYear === nq) score += 50;
    if(book.nPublisher.includes(nq)) score += 30;
    
    if(score > 0) results.push({score, book});
  }
  
  results.sort((a,b) => b.score - a.score);
  
  console.log("Found results:", results.length); // Debug
  
  // Show results
  if(results.length === 0){
    const div = document.createElement("div");
    div.className = "info";
    div.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ / No results found";
    body.appendChild(div);
  } else {
    const info = document.createElement("div");
    info.className = "info";
    info.textContent = `ÙˆØ¬Ø¯Øª ${results.length} Ù†ØªÙŠØ¬Ø© / Found ${results.length} results`;
    body.appendChild(info);
    
    results.slice(0, 50).forEach(r => {
      const b = r.book;
      const div = document.createElement("div");
      div.className = "row";
      div.dir = isArabic(b.title || b.author) ? "rtl" : "ltr";
      
      const authors = [b.author, b.otherAuthor, b.corporate].filter(Boolean).join(" â€¢ ");
      const pubLine = [b.publisher, b.year].filter(Boolean).join(" â€¢ ");
      
      // Determine what to translate
      const mainText = b.title || b.summary;
      const translateTo = isArabic(mainText) ? 'EN' : 'AR';
      
      div.innerHTML = `
        <button class="translate-icon" onclick="translateRecord(${b.id}, 'title', this)" title="Translate to ${translateTo}">
          ğŸŒ ${translateTo}
        </button>
        <div style="display:flex;justify-content:space-between;gap:8px;align-items:flex-start;padding-right:60px;">
          <b style="font-size:15px;line-height:1.4">${b.title || "(No title)"}</b>
          ${b.bookUrl ? `<a class="btn" href="${b.bookUrl}" target="_blank">Open</a>` : `<button class="btn" disabled>No URL</button>`}
        </div>
        ${authors ? `<div class="meta">${isArabic(authors)?'Ø§Ù„Ù…Ø¤Ù„Ù: ':'Author: '}${authors}</div>` : ""}
        ${b.subject ? `<div class="meta">${isArabic(b.subject)?'Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: ':'Subject: '}${b.subject}</div>` : ""}
        ${pubLine ? `<div class="meta">${pubLine}</div>` : ""}
        ${b.summary ? `<div style="margin-top:6px;font-size:13px">${b.summary.length>300 ? b.summary.slice(0,297)+'â€¦' : b.summary}</div>` : ""}
      `;
      body.appendChild(div);
    });
    
    if(results.length > 50){
      const more = document.createElement("div");
      more.className = "info";
      more.textContent = `Ø¹Ø±Ø¶ 50 Ù…Ù† ${results.length} â€¢ Showing 50 of ${results.length}`;
      body.appendChild(more);
    }
  }
  
  setBusy(false);
}

// Handle chat mode
function handleChat(query) {
  // Add user message
  const userMsg = document.createElement('div');
  userMsg.className = 'message user';
  userMsg.innerHTML = `
    <div class="message-avatar">ğŸ‘¤</div>
    <div class="message-content">${query}</div>
  `;
  body.appendChild(userMsg);
  
  // Simple FAQ matching (you'll add FAQs later)
  const aiMsg = document.createElement('div');
  aiMsg.className = 'message ai';
  aiMsg.innerHTML = `
    <div class="message-avatar">ğŸ¤–</div>
    <div class="message-content">
      Ø´ÙƒØ±Ø§Ù‹ Ù„Ø³Ø¤Ø§Ù„Ùƒ. Ø­Ø§Ù„ÙŠØ§Ù‹ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒØªØ¨. Ø§Ø³ØªØ®Ø¯Ù… ØªØ¨ÙˆÙŠØ¨ "ğŸ” Search" Ù„Ù„Ø¨Ø­Ø« ÙÙŠ ${INDEX.length} ÙƒØªØ§Ø¨.<br><br>
      Thank you for your question. Currently I can help you search for books. Use the "ğŸ” Search" tab to search ${INDEX.length} books.<br><br>
      <em>(FAQs feature coming soon - you can add FAQ file later)</em>
    </div>
  `;
  body.appendChild(aiMsg);
  body.scrollTop = body.scrollHeight;
}

// Main handler
go.onclick = () => {
  const query = q.value.trim();
  if(!query) return;
  
  if(CURRENT_MODE === 'search') {
    search(query);
  } else if(CURRENT_MODE === 'chat') {
    handleChat(query);
  }
  
  q.value = '';
};

q.onkeydown = (e) => { 
  if(e.key === "Enter") go.onclick(); 
};

// Make translateRecord global
window.translateRecord = translateRecord;

ensureLoaded();
</script>
</body>
</html>
