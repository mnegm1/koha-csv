<!DOCTYPE html>
<html lang="ar" dir="auto">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ECSSR AI Assistant - Enhanced</title>
<style>
  :root{
    --brand:#BF9849; --brandText:#fff;
    --logo-url:url("https://assets.almanhal.com/platform/shared/Product/ECSSR/middlelogo.png");
    --logo-size:130%; --fab-size:56px;
    --box-width:620px; --box-max-h:85vh;
  }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#F3EFED;margin:0;padding:2rem}
  
  .fab-wrap{position:fixed; right:18px; bottom:18px; z-index:9999; width:var(--fab-size); height:calc(var(--fab-size)+36px)}
  .fab-label{position:absolute; left:50%; bottom:calc(var(--fab-size)+4px); transform:translateX(-50%);
    width:calc(var(--fab-size)+36px); height:34px; pointer-events:none;
    filter:drop-shadow(0 1px 0 rgba(255,255,255,.65))}
  .fab-label text{ fill:var(--brand); font-weight:700; font-size:12px; letter-spacing:.5px }
  .fab{position:absolute; left:0; bottom:0; width:var(--fab-size); height:var(--fab-size);
    background:#fff var(--logo-url) center/var(--logo-size) no-repeat; border:4px solid #BF9849;
    border-radius:50%; cursor:pointer; box-shadow:0 8px 20px rgba(0,0,0,.25); transition:transform 0.2s}
  .fab:hover{transform:scale(1.05)}
  
  .box{position:fixed; right:18px; bottom:calc(18px + var(--fab-size) + 12px);
    width:min(var(--box-width),94vw); max-height:var(--box-max-h);
    background:#fff; border-radius:14px; border:1px solid #e8eef3;
    box-shadow:0 16px 40px rgba(0,0,0,.25); display:none; flex-direction:column; overflow:hidden; z-index:9999}
  
  .head{background:linear-gradient(135deg, #BF9849 0%, #D4AB5E 100%);color:#fff;padding:12px 16px;font-weight:600;display:flex;justify-content:space-between;align-items:center}
  .head-title{display:flex;align-items:center;gap:8px}
  .ai-badge{background:rgba(255,255,255,0.2);padding:2px 8px;border-radius:12px;font-size:10px;font-weight:700;letter-spacing:0.5px}
  
  .status{font-size:12px;opacity:.85;padding:8px 12px;background:#fafafa;border-bottom:1px solid #e8eef3}
  .body{padding:10px;overflow:auto;max-height:calc(var(--box-max-h) - 200px);font-size:14px}
  
  .message{margin:12px 0;display:flex;gap:10px;animation:fadeIn 0.3s}
  .message.user{flex-direction:row-reverse}
  .message.ai{flex-direction:row}
  .message-avatar{width:32px;height:32px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:16px}
  .message.user .message-avatar{background:linear-gradient(135deg,#BF9849,#D4AB5E);color:#fff}
  .message.ai .message-avatar{background:#f0f0f0;color:#666}
  .message-content{max-width:80%;padding:10px 14px;border-radius:12px;line-height:1.5}
  .message.user .message-content{background:#BF9849;color:#fff;border-bottom-right-radius:4px}
  .message.ai .message-content{background:#f6f9fc;color:#333;border-bottom-left-radius:4px}
  
  .row{background:#f6f9fc;border:1px solid #e7edf4;border-radius:12px;padding:12px;margin:10px 0;transition:all 0.2s}
  .row:hover{box-shadow:0 4px 12px rgba(0,0,0,0.08);border-color:#BF9849}
  .meta{opacity:.85;font-size:12px;margin-top:6px}
  
  .input-wrap{background:#fafafa;border-top:1px solid #e8eef3;padding:10px}
  .mode-toggle{display:flex;gap:6px;margin-bottom:8px;padding:4px;background:#fff;border-radius:8px}
  .mode-btn{flex:1;padding:6px;border:none;background:transparent;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;transition:all 0.2s;color:#666}
  .mode-btn.active{background:#BF9849;color:#fff}
  .input{display:flex;gap:8px}
  .input input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #cfd9e3;font-size:14px}
  .input button{background:#BF9849;color:#fff;border:none;border-radius:10px;padding:10px 16px;font-weight:600;cursor:pointer;transition:all 0.2s}
  .input button:hover:not(:disabled){background:#D4AB5E;transform:translateY(-1px)}
  .input button:disabled{opacity:.5;cursor:not-allowed}
  
  .suggestions{display:none;background:#fff;border:1px solid #e8eef3;border-radius:8px;margin-top:6px;padding:4px;max-height:150px;overflow-y:auto}
  .suggestion-item{padding:8px 10px;cursor:pointer;border-radius:6px;font-size:13px;transition:background 0.2s}
  .suggestion-item:hover{background:#f6f9fc}
  
  .btn{flex:0 0 auto;background:#BF9849;color:#fff;padding:6px 12px;border-radius:8px;text-decoration:none;font-weight:600;font-size:12px;transition:all 0.2s;display:inline-block}
  .btn:hover{background:#D4AB5E;transform:translateY(-1px)}
  .btn[disabled]{opacity:.5; cursor:not-allowed;transform:none}
  
  .error{background:#fff0f0;border:1px solid #f5b5b5;color:#900;padding:10px;border-radius:8px;margin:10px 0}
  
  .busybar{display:none; align-items:center; gap:10px; padding:8px 12px; background:#fff; border-bottom:1px solid #e8eef3}
  .box.busy .busybar{display:flex}
  .spinner{
    width:32px;height:32px;border-radius:50%;
    background:#fff var(--logo-url) center/90% no-repeat;
    border:3px solid rgba(0,0,0,.06); box-shadow:0 2px 8px rgba(0,0,0,.12);
    animation:ka-spin 1s linear infinite
  }
  @keyframes ka-spin{to{transform:rotate(360deg)}}
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  .busytext{font-weight:600;color:#555}
  
  .ai-note{background:linear-gradient(135deg,#f6f9fc,#e8f4f8);border-left:4px solid #BF9849;padding:10px;margin:10px 0;border-radius:8px;font-size:13px}
  .ai-note::before{content:"ü§ñ ";margin-right:4px}
  
  .typing-indicator{display:flex;gap:4px;padding:10px}
  .typing-dot{width:8px;height:8px;border-radius:50%;background:#BF9849;animation:typing 1.4s infinite}
  .typing-dot:nth-child(2){animation-delay:0.2s}
  .typing-dot:nth-child(3){animation-delay:0.4s}
  @keyframes typing{0%,60%,100%{opacity:0.3}30%{opacity:1}}
</style>
</head>
<body>
  <div class="fab-wrap">
    <svg class="fab-label" viewBox="0 0 120 40"><defs><path id="ka-arc" d="M 10,34 A 50,50 0 0 1 110,34"/></defs>
      <text text-anchor="middle"><textPath href="#ka-arc" startOffset="50%">AI Assist</textPath></text>
    </svg>
    <button class="fab" aria-label="AI Assistant" id="fab"></button>
  </div>

  <div class="box" id="box">
    <div class="head">
      <div class="head-title">
        <div>ECSSR AI Assistant</div>
        <div class="ai-badge">ENHANCED</div>
      </div>
      <button id="x" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;padding:0 4px" title="Close">√ó</button>
    </div>

    <div class="busybar" id="busybar" aria-live="polite">
      <div class="spinner" title="Working‚Ä¶"></div>
      <div class="busytext" id="busytext">Loading‚Ä¶</div>
    </div>

    <div class="status" id="status">Loading catalog...</div>
    <div class="body" id="body"></div>
    
    <div class="input-wrap">
      <div class="mode-toggle">
        <button class="mode-btn active" data-mode="chat">üí¨ Chat</button>
        <button class="mode-btn" data-mode="search">üîç Search</button>
      </div>
      <div class="suggestions" id="suggestions"></div>
      <div class="input">
        <input id="q" type="text" placeholder="ÿßÿ≥ÿ£ŸÑ ÿ£Ÿä ÿ≥ÿ§ÿßŸÑ ÿπŸÜ ÿßŸÑŸÖŸÉÿ™ÿ®ÿ©... / Ask anything about the catalog..." dir="auto">
        <button id="go">Send</button>
      </div>
    </div>
  </div>

<script>
/* ====== CONFIG ====== */
const DATA_URL = "./opac-catalog.tab?delim=tab";
const BACKEND_URL = "https://ecssr-ai-assistant.onrender.com/api";

/* ====== State ====== */
let INDEX = [];
let HEADERS = [];
let LOADED = false;
let CONVERSATION_HISTORY = [];
let CURRENT_MODE = 'chat';

/* ====== UI Elements ====== */
const fab = document.getElementById("fab");
const box = document.getElementById("box");
const closeBtn = document.getElementById("x");
const B = document.getElementById("body");
const STATUS = document.getElementById("status");
const Q = document.getElementById("q");
const goBtn = document.getElementById("go");
const suggestionsEl = document.getElementById("suggestions");

/* ====== Busy indicator ====== */
function setBusy(on, label){
  const bar = document.getElementById('busybar');
  const txt = document.getElementById('busytext');
  if(label) txt.textContent = label;
  if(on){ 
    box.classList.add('busy'); 
    bar.style.display='flex'; 
    goBtn.disabled = true; 
    Q.disabled = true; 
  } else { 
    box.classList.remove('busy'); 
    bar.style.display='none'; 
    goBtn.disabled = false; 
    Q.disabled = false; 
  }
}

/* ====== Error handling ====== */
addEventListener("error", e => showError("JS error: " + (e.message||e)));
addEventListener("unhandledrejection", e => showError("Promise error: " + (e.reason?.message||e.reason)));

function showError(msg){
  const div = document.createElement("div");
  div.className = "error";
  div.textContent = String(msg||"Unknown error");
  B.appendChild(div);
}

/* ====== UI Controls ====== */
fab.onclick = () => { 
  box.style.display = (box.style.display==="flex"?"none":"flex"); 
  if(box.style.display==="flex"){ 
    setBusy(true,"Initializing‚Ä¶"); 
    ensureLoaded().then(()=>setBusy(false)); 
    setTimeout(()=>Q.focus(),50); 
  }
};
closeBtn.onclick = () => { box.style.display="none"; };

document.querySelectorAll('.mode-btn').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    CURRENT_MODE = btn.dataset.mode;
    
    const placeholders = {
      chat: "ÿßÿ≥ÿ£ŸÑ ÿ£Ÿä ÿ≥ÿ§ÿßŸÑ ÿπŸÜ ÿßŸÑŸÖŸÉÿ™ÿ®ÿ©... / Ask anything about the catalog...",
      search: "ÿßÿ®ÿ≠ÿ´ ÿπŸÜ: ŸÖÿ§ŸÑŸÅÿå ÿπŸÜŸàÿßŸÜÿå ŸÖŸàÿ∂Ÿàÿπ... / Search: author, title, subject..."
    };
    Q.placeholder = placeholders[CURRENT_MODE];
  };
});

/* ====== Arabic normalization ====== */
function stripBidi(s){ return String(s||"").replace(/[\u200E\u200F\u202A-\u202E]/g,""); }
function clean(s){ return stripBidi(String(s||"").replace(/^\uFEFF/,"")); }
function canonHeader(h){ return clean(h).toLowerCase().replace(/\s+/g," ").trim(); }
function norm(s){
  if(!s) return "";
  s = clean(s).toLowerCase();
  try{s=s.normalize("NFKD");}catch(e){}
  s = s
    .replace(/[ÿ•ÿ£ÿ¢Ÿ±]/g,"ÿß").replace(/[Ÿâ€å]/g,"Ÿä").replace(/ÿ©/g,"Ÿá").replace(/⁄©/g,"ŸÉ")
    .replace(/\bÿπÿ®ÿØ\s+ÿßŸÑ/g,"ÿπÿ®ÿØÿßŸÑ")
    .replace(/[\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06ED\u0640]/g,"")
    .replace(/[\u0660-\u0669]/g,d=>d.charCodeAt(0)-0x0660)
    .replace(/[\u06F0-\u06F9]/g,d=>d.charCodeAt(0)-0x06F0)
    .replace(/[^\p{L}\p{N}\s]/gu," ")
    .replace(/\s+/g," ").trim();
  return s;
}
function isArabic(s){ return /[\u0600-\u06FF]/.test(s||""); }

/* ====== UTF-8 decoder ====== */
function countArabic(s){ return (s.match(/[\u0600-\u06FF]/g)||[]).length; }
function hasLikelyHeaders(s){
  const h = s.slice(0, 4096).toLowerCase();
  return /full title|author|abstract|subjects|publication|book[_\s]?url|ÿßŸÑÿπŸÜŸàÿßŸÜ|ÿßŸÑŸÖÿ§ŸÑŸÅ|ÿßŸÑŸÖŸÑÿÆÿµ|ÿßŸÑŸÖŸàÿ∂Ÿàÿπ|ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÜÿ¥ÿ±/.test(h);
}
async function autoDecode(arrayBuf){
  const tryEnc = (label) => {
    try {
      const td = new TextDecoder(label, { fatal:false });
      const u8 = new Uint8Array(arrayBuf);
      const step = 1024*1024;
      let out = "", pos = 0;
      while (pos < u8.length){
        const end = Math.min(pos+step, u8.length);
        out += td.decode(u8.subarray(pos, end), {stream: end < u8.length});
        pos = end;
      }
      out += td.decode();
      const bad = (out.match(/\uFFFD/g)||[]).length;
      return { text: out, bad };
    } catch { return { text:"", bad: 1e9 }; }
  };

  const u8 = new Uint8Array(arrayBuf);
  if (u8.length >= 3 && u8[0]===0xEF && u8[1]===0xBB && u8[2]===0xBF){
    const {text} = tryEnc("utf-8");
    return { text, enc:"utf-8" };
  }

  const utf8 = tryEnc("utf-8");
  const utf8Ar = countArabic(utf8.text);
  const utf8Hdr = hasLikelyHeaders(utf8.text);

  if (utf8.bad === 0 || utf8Ar >= 10 || utf8Hdr){
    return { text:utf8.text, enc:"utf-8" };
  }

  const candLabels = ["windows-1256","iso-8859-6","utf-16le"];
  let best = {score:-1e15, text:"", enc:""};
  for (const lab of candLabels){
    const r = tryEnc(lab);
    const ar = countArabic(r.text);
    const hdr = hasLikelyHeaders(r.text);
    const score = (-r.bad*1e6) + (ar*5) + (hdr?800:0) + (lab==="windows-1256"?30:0);
    if (score > best.score) best = {score, text:r.text, enc:lab};
  }

  const utf8Score = (-utf8.bad*1e6) + (utf8Ar*5) + (utf8Hdr?800:0) + 200;
  if (utf8Score >= best.score) return { text:utf8.text, enc:"utf-8" };
  return { text:best.text, enc:best.enc };
}

/* ====== Parser ====== */
function parseTSV(text){
  text = clean(String(text||"")).replace(/\r\n?/g,"\n");
  if(!text.trim()) return {headers:[], rows:[], delim:"\t"};

  let override = null;
  try{
    const u = new URL(DATA_URL, location.href);
    const d = (u.searchParams.get("delim")||"").toLowerCase();
    if(d==="tab") override="\t"; if(d==="pipe") override="|";
    if(d==="semicolon") override=";"; if(d==="comma") override=",";
  }catch(_){}
  const candidates = override ? [override] : ["\t","|",";",","];

  const firstNL = text.indexOf("\n");
  const headerLine = firstNL>=0 ? text.slice(0,firstNL) : text;
  let bestDelim = "\t", bestScore = -1;
  for(const d of candidates){ const s=(headerLine.split(d).length-1); if(s>bestScore){bestScore=s;bestDelim=d;} }
  const DELIM = bestDelim;

  if (DELIM === "\t"){
    const lines = text.split("\n");
    const rows = lines.map(l => l.split("\t"));
    if(!rows.length) return {headers:[], rows:[], delim:DELIM};
    const headers = rows[0].map(canonHeader);
    const out=[];
    for(let r=1;r<rows.length;r++){
      const rec={}; const cols=rows[r];
      if(cols.length===1 && cols[0]==="") continue;
      for(let c=0;c<headers.length;c++){
        const key = headers[c] || ("col"+c);
        rec[key] = clean(cols[c] ?? "");
      }
      out.push(rec);
    }
    return {headers, rows:out, delim:DELIM};
  }

  const rows=[]; let i=0, field="", row=[], inQuotes=false;
  while(i<text.length){
    const ch=text[i];
    if(inQuotes){
      if(ch==="\""){
        if(i+1<text.length && text[i+1]==="\""){ field+="\""; i+=2; continue; }
        inQuotes=false; i++; continue;
      } else { field+=ch; i++; continue; }
    } else {
      if(ch==="\""){ inQuotes=true; i++; continue; }
