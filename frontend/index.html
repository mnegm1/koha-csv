<!DOCTYPE html>
<html lang="ar" dir="auto">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ECSSR Search - Simple & Accurate</title>
<style>
  :root{
    --brand:#BF9849;
    --logo-url:url("https://assets.almanhal.com/platform/shared/Product/ECSSR/middlelogo.png");
    --fab-size:56px;
  }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#F3EFED;margin:0;padding:2rem}
  
  .fab-wrap{position:fixed;right:18px;bottom:18px;z-index:9999}
  .fab{width:var(--fab-size);height:var(--fab-size);background:#fff var(--logo-url) center/130% no-repeat;
    border:4px solid #BF9849;border-radius:50%;cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,.25)}
  
  .box{position:fixed;right:18px;bottom:calc(18px + var(--fab-size) + 12px);
    width:min(620px,94vw);max-height:85vh;background:#fff;border-radius:14px;
    box-shadow:0 16px 40px rgba(0,0,0,.25);display:none;flex-direction:column;overflow:hidden;z-index:9999}
  
  .head{background:linear-gradient(135deg,#BF9849,#D4AB5E);color:#fff;padding:12px 16px;font-weight:600;
    display:flex;justify-content:space-between;align-items:center}
  .close{background:none;border:none;color:#fff;font-size:20px;cursor:pointer}
  
  .status{font-size:12px;padding:8px 12px;background:#fafafa;border-bottom:1px solid #e8eef3}
  .body{padding:10px;overflow:auto;flex:1}
  
  .row{background:#f6f9fc;border:1px solid #e7edf4;border-radius:12px;padding:12px;margin:10px 0}
  .row:hover{box-shadow:0 4px 12px rgba(0,0,0,0.08);border-color:#BF9849}
  .meta{opacity:.85;font-size:12px;margin-top:6px}
  
  .input-wrap{padding:10px;background:#fafafa;border-top:1px solid #e8eef3}
  .translate-row{display:flex;gap:8px;margin-bottom:8px;align-items:center}
  .translate-btn{padding:6px 12px;background:#fff;border:1px solid #cfd9e3;border-radius:8px;cursor:pointer;font-size:12px;transition:all 0.2s}
  .translate-btn:hover{background:#f0f0f0}
  .translate-btn.active{background:#BF9849;color:#fff;border-color:#BF9849}
  .translate-note{flex:1;font-size:11px;color:#666;text-align:right}
  .input{display:flex;gap:8px}
  .input input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #cfd9e3}
  .input button{background:#BF9849;color:#fff;border:none;border-radius:10px;padding:10px 16px;
    font-weight:600;cursor:pointer}
  .input button:disabled{opacity:.5}
  
  .btn{background:#BF9849;color:#fff;padding:6px 12px;border-radius:8px;text-decoration:none;
    font-weight:600;font-size:12px}
  .btn:hover{background:#D4AB5E}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  
  .info{background:#e8f4f8;border-left:4px solid #BF9849;padding:10px;margin:10px 0;border-radius:8px;font-size:13px}
</style>
</head>
<body>
  <div class="fab-wrap">
    <button class="fab" id="fab"></button>
  </div>

  <div class="box" id="box">
    <div class="head">
      <div>ECSSR Catalog Search</div>
      <button class="close" id="close">√ó</button>
    </div>
    <div class="status" id="status">Loading...</div>
    <div class="body" id="body"></div>
    <div class="input-wrap">
      <div class="translate-row">
        <button class="translate-btn" id="translateBtn" title="Translate query">üåê Translate</button>
        <select id="translateLang" style="padding:6px;border:1px solid #cfd9e3;border-radius:8px;font-size:12px">
          <option value="">Select language...</option>
          <option value="ar">Arabic (ÿßŸÑÿπÿ±ÿ®Ÿäÿ©)</option>
          <option value="en">English</option>
          <option value="fr">French</option>
          <option value="es">Spanish</option>
        </select>
        <span class="translate-note" id="translateNote"></span>
      </div>
      <div class="input">
        <input id="q" type="text" placeholder="ÿßÿ®ÿ≠ÿ´: ŸÖÿ§ŸÑŸÅÿå ÿπŸÜŸàÿßŸÜÿå ŸÖŸàÿ∂Ÿàÿπ / Search: author, title, subject" dir="auto">
        <button id="go">Search</button>
      </div>
    </div>
  </div>

<script>
const DATA_URL = "./opac-catalog.tab";
let INDEX = [];
let LOADED = false;

const fab = document.getElementById("fab");
const box = document.getElementById("box");
const close = document.getElementById("close");
const body = document.getElementById("body");
const status = document.getElementById("status");
const q = document.getElementById("q");
const go = document.getElementById("go");
const translateBtn = document.getElementById("translateBtn");
const translateLang = document.getElementById("translateLang");
const translateNote = document.getElementById("translateNote");

fab.onclick = () => { 
  box.style.display = box.style.display === "flex" ? "none" : "flex";
  if(box.style.display === "flex") {
    ensureLoaded();
    setTimeout(() => q.focus(), 50);
  }
};
close.onclick = () => box.style.display = "none";

function setBusy(busy) {
  go.disabled = busy;
  q.disabled = busy;
  translateBtn.disabled = busy;
  status.textContent = busy ? "Searching..." : `${INDEX.length} books loaded`;
}

// Translation using MyMemory API (free, no key needed)
async function translateText(text, targetLang) {
  if(!text || !targetLang) return null;
  
  try {
    translateNote.textContent = "Translating...";
    translateBtn.disabled = true;
    
    // Detect source language
    const sourceLang = /[\u0600-\u06FF]/.test(text) ? 'ar' : 'en';
    
    // Use MyMemory Translation API (free, no registration)
    const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${sourceLang}|${targetLang}`;
    
    const response = await fetch(url);
    const data = await response.json();
    
    if(data.responseStatus === 200 || data.responseData.translatedText) {
      const translated = data.responseData.translatedText;
      translateNote.textContent = `‚úì Translated from ${sourceLang.toUpperCase()} to ${targetLang.toUpperCase()}`;
      translateBtn.disabled = false;
      return translated;
    } else {
      throw new Error("Translation failed");
    }
  } catch(error) {
    translateNote.textContent = "‚ùå Translation failed";
    translateBtn.disabled = false;
    console.error("Translation error:", error);
    return null;
  }
}

// Translate button click
translateBtn.onclick = async () => {
  const text = q.value.trim();
  const targetLang = translateLang.value;
  
  if(!text) {
    alert("ÿßŸÉÿ™ÿ® ŸÜÿµ ÿ£ŸàŸÑÿßŸã / Enter text first");
    return;
  }
  
  if(!targetLang) {
    alert("ÿßÿÆÿ™ÿ± ÿßŸÑŸÑÿ∫ÿ© / Select language");
    return;
  }
  
  const translated = await translateText(text, targetLang);
  if(translated) {
    q.value = translated;
    translateNote.textContent += " - Click Search to find books";
  }
};

// Arabic normalization
function norm(s){
  if(!s) return "";
  s = String(s).toLowerCase();
  try{s=s.normalize("NFKD");}catch(e){}
  return s
    .replace(/[ÿ•ÿ£ÿ¢Ÿ±]/g,"ÿß")
    .replace(/[Ÿâ€å]/g,"Ÿä")
    .replace(/ÿ©/g,"Ÿá")
    .replace(/⁄©/g,"ŸÉ")
    .replace(/[\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06ED\u0640]/g,"")
    .replace(/[\u0660-\u0669]/g,d=>d.charCodeAt(0)-0x0660)
    .replace(/[\u06F0-\u06F9]/g,d=>d.charCodeAt(0)-0x06F0)
    .replace(/[^\p{L}\p{N}\s]/gu," ")
    .replace(/\s+/g," ").trim();
}

function isArabic(s){ return /[\u0600-\u06FF]/.test(s||""); }

// Load catalog
async function ensureLoaded(){
  if(LOADED) return;
  try{
    setBusy(true);
    const resp = await fetch(DATA_URL);
    if(!resp.ok) throw new Error(`Error ${resp.status}`);
    const text = await resp.text();
    
    const lines = text.split("\n");
    const headers = lines[0].split("\t").map(h => h.toLowerCase().trim());
    
    for(let i=1; i<lines.length; i++){
      const cols = lines[i].split("\t");
      if(cols.length < 2) continue;
      
      const rec = {};
      headers.forEach((h, idx) => {
        rec[h] = cols[idx] || "";
      });
      
      // Extract fields
      const title = rec["full title"] || rec["title"] || rec["ÿßŸÑÿπŸÜŸàÿßŸÜ"] || "";
      const author = rec["author"] || rec["ÿßŸÑŸÖÿ§ŸÑŸÅ"] || "";
      const otherAuthor = rec["other author"] || rec["ÿßŸÑŸÖÿ§ŸÑŸÅ ÿßŸÑÿ¢ÿÆÿ±"] || "";
      const corporate = rec["corporate name"] || rec["ÿ¨Ÿáÿ© ŸÖÿ§ÿ≥ÿ≥Ÿäÿ©"] || "";
      const subject = rec["subjects"] || rec["subject"] || rec["ÿßŸÑŸÖŸàÿ∂Ÿàÿπÿßÿ™"] || "";
      const summary = rec["abstract"] || rec["summary"] || rec["ÿßŸÑŸÖŸÑÿÆÿµ"] || "";
      const pubData = rec["publications data"] || rec["ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÜÿ¥ÿ±"] || "";
      const bookUrl = rec["book_url"] || rec["book url"] || rec["ÿ±ÿßÿ®ÿ∑ ÿßŸÑŸÉÿ™ÿßÿ®"] || "";
      const year = rec["year"] || rec["ÿßŸÑÿ≥ŸÜÿ©"] || (pubData.match(/(19|20)\d{2}/)||[""])[0];
      const publisher = pubData.replace(/\b(19|20)\d{2}\b/g,"").replace(/[ÿå,:-]\s*$/,"").trim();
      
      INDEX.push({
        id: i-1,
        title,
        author,
        otherAuthor,
        corporate,
        subject,
        summary,
        publisher,
        year,
        bookUrl,
        // Normalized for search
        nTitle: norm(title),
        nAuthor: norm(author + " " + otherAuthor + " " + corporate),
        nSubject: norm(subject),
        nSummary: norm(summary),
        nYear: norm(year)
      });
    }
    
    LOADED = true;
    status.textContent = `‚úÖ ${INDEX.length} books loaded - Ready to search`;
  }catch(e){
    status.textContent = `‚ùå Error: ${e.message}`;
  }finally{
    setBusy(false);
  }
}

// Simple accurate search
function search(query){
  body.innerHTML = "";
  setBusy(true);
  
  const nq = norm(query);
  if(!nq){
    setBusy(false);
    return;
  }
  
  // Search ALL books
  const results = [];
  for(const book of INDEX){
    let score = 0;
    if(book.nTitle.includes(nq)) score += 100;
    if(book.nAuthor.includes(nq)) score += 80;
    if(book.nSubject.includes(nq)) score += 60;
    if(book.nSummary.includes(nq)) score += 40;
    if(book.nYear.includes(nq)) score += 20;
    
    if(score > 0) results.push({score, book});
  }
  
  results.sort((a,b) => b.score - a.score);
  
  // Show results
  if(results.length === 0){
    const div = document.createElement("div");
    div.className = "info";
    div.textContent = "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨ / No results found";
    body.appendChild(div);
  } else {
    const info = document.createElement("div");
    info.className = "info";
    info.textContent = `Ÿàÿ¨ÿØÿ™ ${results.length} ŸÜÿ™Ÿäÿ¨ÿ© / Found ${results.length} results`;
    body.appendChild(info);
    
    results.slice(0, 50).forEach(r => {
      const b = r.book;
      const div = document.createElement("div");
      div.className = "row";
      div.dir = isArabic(b.title || b.author) ? "rtl" : "ltr";
      
      const authors = [b.author, b.otherAuthor, b.corporate].filter(Boolean).join(" ‚Ä¢ ");
      const pubLine = [b.publisher, b.year].filter(Boolean).join(" ‚Ä¢ ");
      
      div.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:8px;align-items:flex-start;">
          <b style="font-size:15px;line-height:1.4">${b.title || "(No title)"}</b>
          ${b.bookUrl ? `<a class="btn" href="${b.bookUrl}" target="_blank">Open</a>` : `<button class="btn" disabled>No URL</button>`}
        </div>
        ${authors ? `<div class="meta">${isArabic(authors)?'ÿßŸÑŸÖÿ§ŸÑŸÅ: ':'Author: '}${authors}</div>` : ""}
        ${b.subject ? `<div class="meta">${isArabic(b.subject)?'ÿßŸÑŸÖŸàÿ∂Ÿàÿπ: ':'Subject: '}${b.subject}</div>` : ""}
        ${pubLine ? `<div class="meta">${pubLine}</div>` : ""}
        ${b.summary ? `<div style="margin-top:6px;font-size:13px">${b.summary.length>300 ? b.summary.slice(0,297)+'‚Ä¶' : b.summary}</div>` : ""}
      `;
      body.appendChild(div);
    });
    
    if(results.length > 50){
      const more = document.createElement("div");
      more.className = "info";
      more.textContent = `ÿπÿ±ÿ∂ 50 ŸÖŸÜ ${results.length} ‚Ä¢ Showing 50 of ${results.length}`;
      body.appendChild(more);
    }
  }
  
  setBusy(false);
}

go.onclick = () => search(q.value);
q.onkeydown = (e) => { if(e.key === "Enter") search(q.value); };

ensureLoaded();
</script>
</body>
</html>
