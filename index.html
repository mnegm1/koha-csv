<!DOCTYPE html>
<html lang="ar" dir="auto">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ECSSR AI Assistant</title>
<style>
  :root{
    --brand:#BF9849;
    --logo-url:url("https://assets.almanhal.com/platform/shared/Product/ECSSR/middlelogo.png");
    --fab-size:70px;
  }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#F3EFED;margin:0;padding:2rem}
  .fab-wrap{position:fixed;right:18px;bottom:18px;z-index:9999;width:var(--fab-size);height:calc(var(--fab-size)+36px)}
  .fab-label{position:absolute;left:50%;bottom:calc(var(--fab-size)+4px);transform:translateX(-50%);width:calc(var(--fab-size)+36px);height:34px;pointer-events:none;filter:drop-shadow(0 1px 0 rgba(255,255,255,.65))}
  .fab-label text{fill:var(--brand);font-weight:700;font-size:12px;letter-spacing:.5px}
  .fab{position:absolute;left:0;bottom:0;width:var(--fab-size);height:var(--fab-size);background:#fff var(--logo-url) center/145% no-repeat;border:5px solid #BF9849;border-radius:50%;cursor:pointer;box-shadow:0 10px 30px rgba(191,152,73,0.4);transition:transform 0.3s ease, box-shadow 0.3s ease}
  .fab:hover{transform:scale(1.08);box-shadow:0 15px 40px rgba(191,152,73,0.6)}
  .slide-banner{position:fixed;right:calc(var(--fab-size) + 30px);bottom:calc(18px + (var(--fab-size) / 2) - 22px);background:linear-gradient(135deg,#BF9849,#D4AB5E);color:#fff;padding:14px 28px;border-radius:30px;font-weight:700;font-size:15px;box-shadow:0 8px 24px rgba(191,152,73,0.5);white-space:nowrap;z-index:9998;animation:slideFromBottom 7s ease-in-out forwards;opacity:0;letter-spacing:0.3px}
  @keyframes slideFromBottom{0%{transform:translateY(200px);opacity:0}15%{transform:translateY(0);opacity:1}85%{transform:translateY(0);opacity:1}100%{transform:translateY(200px);opacity:0}}
  .box{position:fixed;right:18px;bottom:calc(18px + var(--fab-size) + 12px);width:min(620px,94vw);max-height:85vh;background:#fff;border-radius:14px;box-shadow:0 16px 40px rgba(0,0,0,.25);display:none;flex-direction:column;overflow:hidden;z-index:9999}
  .head{background:linear-gradient(135deg,#BF9849,#D4AB5E);color:#fff;padding:12px 16px;font-weight:600;display:flex;justify-content:space-between;align-items:center}
  .close{background:none;border:none;color:#fff;font-size:20px;cursor:pointer}
  .status{font-size:12px;padding:8px 12px;background:#fafafa;border-bottom:1px solid #e8eef3}
  .body{padding:10px;overflow:auto;flex:1}
  .row{background:#f6f9fc;border:1px solid #e7edf4;border-radius:12px;padding:12px;margin:10px 0;position:relative}
  .row:hover{box-shadow:0 4px 12px rgba(0,0,0,0.08);border-color:#BF9849}
  .meta{opacity:.85;font-size:12px;margin-top:6px}
  .translate-icon{position:absolute;top:12px;left:12px;background:#fff;border:1px solid #e0e0e0;border-radius:6px;padding:4px 8px;font-size:11px;cursor:pointer;transition:all 0.2s;z-index:10}
  .translate-icon:hover{background:#BF9849;color:#fff;border-color:#BF9849}
  .translated{background:#e8f4f8;padding:8px;margin-top:8px;border-radius:6px;font-size:13px;border-left:3px solid #BF9849}
  .ai-summary{background:linear-gradient(135deg,#e8f4f8,#f0f8ff);border-left:4px solid #BF9849;padding:12px;margin:10px 0;border-radius:8px;font-size:13px;line-height:1.6}
  .ai-summary::before{content:"ü§ñ ";margin-right:4px}
  .input-wrap{padding:10px;background:#fafafa;border-top:1px solid #e8eef3}
  .input{display:flex;gap:8px}
  .input input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #cfd9e3}
  .input button{background:#BF9849;color:#fff;border:none;border-radius:10px;padding:10px 16px;font-weight:600;cursor:pointer}
  .input button:disabled{opacity:.5}
  .btn{background:#BF9849;color:#fff;padding:6px 12px;border-radius:8px;text-decoration:none;font-weight:600;font-size:12px;display:inline-block;white-space:nowrap}
  .btn:hover{background:#D4AB5E}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .info{background:#e8f4f8;border-left:4px solid #BF9849;padding:10px;margin:10px 0;border-radius:8px;font-size:13px}
  .more-row{display:flex;justify-content:center;margin-top:10px}
  .more-row button{background:#BF9849;color:#fff;border:none;border-radius:10px;padding:8px 14px;font-weight:700;cursor:pointer}
  .busybar{display:none;align-items:center;gap:10px;padding:8px 12px;background:#fff;border-bottom:1px solid #e8eef3}
  .box.busy .busybar{display:flex}
  .spinner{width:32px;height:32px;border-radius:50%;background:#fff var(--logo-url) center/90% no-repeat;border:3px solid rgba(0,0,0,.06);box-shadow:0 2px 8px rgba(0,0,0,.12);animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .busytext{font-weight:600;color:#555}
</style>
</head>
<body>
<div class="slide-banner" id="slideBanner">UAE Federation Library AI Assistant</div>
<div class="fab-wrap"><svg class="fab-label" viewBox="0 0 120 40"><defs><path id="arc" d="M 10,34 A 50,50 0 0 1 110,34"/></defs><text text-anchor="middle"><textPath href="#arc" startOffset="50%">AI Assist</textPath></text></svg><button class="fab" id="fab"></button></div>
<div class="box" id="box"><div class="head"><div>ECSSR AI Search</div><button class="close" id="close">√ó</button></div><div class="busybar" id="busybar"><div class="spinner"></div><div class="busytext" id="busytext">Loading...</div></div><div class="status" id="status">Ready</div><div class="body" id="body"></div><div class="input-wrap"><div class="input"><input id="q" type="text" placeholder="ÿßŸÉÿ™ÿ®: ÿßÿ≥ŸÖ ŸÖÿ§ŸÑŸÅ / ÿπŸÜŸàÿßŸÜ / ŸÖŸàÿ∂Ÿàÿπ / ÿ≥ŸÜÿ©" dir="auto"><button id="go">Search</button></div></div></div>
<script>
const DATA_URL="./opac-catalog.tab?delim=tab",PAGE_SIZE=12,BACKEND_URL="https://ecssr-ai-assistant.onrender.com/api";
let INDEX=[],HEADERS=[],LOADED=!1,MATCH_NOTE="",LAST={items:[],shown:0,field:""};
const fab=document.getElementById("fab"),box=document.getElementById("box"),close=document.getElementById("close"),body=document.getElementById("body"),status=document.getElementById("status"),q=document.getElementById("q"),go=document.getElementById("go");
setTimeout(()=>{const e=document.getElementById("slideBanner");e&&e.remove()},7500);
fab.onclick=()=>{box.style.display="flex"===box.style.display?"none":"flex","flex"===box.style.display&&(LOADED||(setBusy(!0,"Initializing‚Ä¶"),ensureLoaded().then(()=>setBusy(!1))),setTimeout(()=>q.focus(),50))};
close.onclick=()=>box.style.display="none";
function setBusy(e,t){const n=document.getElementById("busybar"),o=document.getElementById("busytext");t&&(o.textContent=t),e?(box.classList.add("busy"),go.disabled=!0,q.disabled=!0):(box.classList.remove("busy"),go.disabled=!1,q.disabled=!1)}
function stripBidi(e){return String(e||"").replace(/[\u200E\u200F\u202A-\u202E]/g,"")}
function clean(e){return stripBidi(String(e||"").replace(/^\uFEFF/,""))}
function canonHeader(e){return clean(e).toLowerCase().replace(/\s+/g," ").trim()}
function norm(e){if(!e)return"";try{e=(e=clean(e).toLowerCase()).normalize("NFKD")}catch(e){}return e.replace(/[ÿ•ÿ£ÿ¢Ÿ±]/g,"ÿß").replace(/[Ÿâ€å]/g,"Ÿä").replace(/ÿ©/g,"Ÿá").replace(/⁄©/g,"ŸÉ").replace(/\bÿπÿ®ÿØ\s+ÿßŸÑ/g,"ÿπÿ®ÿØÿßŸÑ").replace(/[\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06ED\u0640]/g,"").replace(/[\u0660-\u0669]/g,e=>e.charCodeAt(0)-1632).replace(/[\u06F0-\u06F9]/g,e=>e.charCodeAt(0)-1776).replace(/[^\p{L}\p{N}\s]/gu," ").replace(/\s+/g," ").trim()}
function isArabic(e){return/[\u0600-\u06FF]/.test(e||"")}
const FAMOUS_PEOPLE=new Set(["ŸÖÿ≠ŸÖÿØ ÿ®ŸÜ ÿ≤ÿßŸäÿØ","ŸÖÿ≠ŸÖÿØ ÿ®ŸÜ ÿ±ÿßÿ¥ÿØ","ÿÆŸÑŸäŸÅÿ© ÿ®ŸÜ ÿ≤ÿßŸäÿØ","ÿ≤ÿßŸäÿØ ÿ®ŸÜ ÿ≥ŸÑÿ∑ÿßŸÜ","ŸÖÿ≠ŸÖÿØ ÿ®ŸÜ ÿ≤ÿßŸäÿØ ÿ¢ŸÑ ŸÜŸáŸäÿßŸÜ","sheikh mohamed","sheikh mohammed","sheikh khalifa","sheikh zayed","ÿßŸÑÿ¥ŸäÿÆ ŸÖÿ≠ŸÖÿØ","ÿßŸÑÿ¥ŸäÿÆ ÿÆŸÑŸäŸÅÿ©","ÿßŸÑÿ¥ŸäÿÆ ÿ≤ÿßŸäÿØ"]);
function looksLikeYear(e){return/^\d{4}$/.test(e.trim())}
function isFamousPerson(e){const t=norm(e);for(const e of FAMOUS_PEOPLE)if(t.includes(norm(e)))return!0;return/\b(president|ÿ±ÿ¶Ÿäÿ≥|ÿ≥ŸÖŸà|ÿµÿßÿ≠ÿ® ÿßŸÑÿ≥ŸÖŸà)\b/i.test(e)}
function chooseField(e){const t=e.trim(),n=norm(e);if(looksLikeYear(t))return"year";if(/^(what|how|why|when|where|who|which|ŸÖÿß|ŸÉŸäŸÅ|ŸÑŸÖÿßÿ∞ÿß|ŸÖÿ™Ÿâ|ÿ£ŸäŸÜ|ŸÖŸÜ|ŸÖÿßÿ∞ÿß|ŸÉŸäŸÅŸäÿ©|ŸáŸÑ)\b/i.test(t))return MATCH_NOTE="Question ‚Üí searching in Abstract & Contents","summary";if(isFamousPerson(t))return MATCH_NOTE="Famous person ‚Üí searching in Subject & Title","subject";if(/(ÿßŸÑÿ™ÿ±ÿßÿ´|ÿßŸÑÿ´ŸÇÿßŸÅÿ©|ÿßŸÑÿ™ÿßÿ±ŸäÿÆ|ÿßŸÑŸÅŸÜ|ÿßŸÑÿπŸÑŸàŸÖ|ÿßŸÑÿ£ÿØÿ®|ÿßŸÑÿ¥ÿπÿ±|ÿßŸÑÿ≥Ÿäÿßÿ≥ÿ©|ÿßŸÑÿßŸÇÿ™ÿµÿßÿØ|ÿßŸÑÿ™ÿπŸÑŸäŸÖ|ÿßŸÑÿµÿ≠ÿ©|ÿßŸÑÿ®Ÿäÿ¶ÿ©|ÿßŸÑÿ™ŸÉŸÜŸàŸÑŸàÿ¨Ÿäÿß|ÿßŸÑÿ∞ŸÉÿßÿ°|ÿßŸÑÿ∑ÿßŸÇÿ©|ÿßŸÑŸÖŸäÿßŸá|ÿßŸÑÿ≤ÿ±ÿßÿπÿ©|ÿßŸÑŸÜŸÅÿ∑|ÿßŸÑÿ∫ÿßÿ≤)/i.test(t))return MATCH_NOTE="Topic keyword ‚Üí searching in Subject","subject";const o=t.split(/\s+/).filter(Boolean);if(o.length>=2&&o.length<=3&&isArabic(t))return MATCH_NOTE="2-3 Arabic words ‚Üí searching in Author",/[a-zA-Z]/.test(t)&&isArabic(t)?"subject":"author";return MATCH_NOTE="General search ‚Üí Subject & Title","subject"}
async function ensureLoaded(){if(LOADED)return;try{setBusy(!0,"Loading records‚Ä¶");const e=await fetch(DATA_URL,{cache:"reload"});if(!e.ok)throw new Error(`Fetch ${e.status}`);const t=new TextDecoder("utf-8").decode(await e.arrayBuffer()),n=t.split(/\r?\n/);if(n.length<2)throw new Error("Empty catalog");const o=n[0].split("\t").map(canonHeader);HEADERS=o;for(let e=1;e<n.length;e++){const t=n[e].split("\t");if(!(t.length<2||1===t.length&&!t[0])){const e={};o.forEach((n,o)=>{e[n]=clean(t[o]||"")});const n=e["full title"]||e.title||e["ÿßŸÑÿπŸÜŸàÿßŸÜ"]||"",r=e.author||e["ÿßŸÑŸÖÿ§ŸÑŸÅ"]||"",a=e["other author"]||e["ÿßŸÑŸÖÿ§ŸÑŸÅ ÿßŸÑÿ¢ÿÆÿ±"]||"",i=e["corporate name"]||e["ÿ¨Ÿáÿ© ŸÖÿ§ÿ≥ÿ≥Ÿäÿ©"]||"",s=e.subjects||e.subject||e["ÿßŸÑŸÖŸàÿ∂Ÿàÿπÿßÿ™"]||"",l=e.abstract||e.summary||e["ÿßŸÑŸÖŸÑÿÆÿµ"]||"",c=e.content||e.contents||e["ÿßŸÑŸÖÿ≠ÿ™ŸàŸäÿßÿ™"]||"",u=e["publications data"]||e["ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÜÿ¥ÿ±"]||"",d=e.book_url||e["book url"]||e["ÿ±ÿßÿ®ÿ∑ ÿßŸÑŸÉÿ™ÿßÿ®"]||"",m=e.year||e["ÿßŸÑÿ≥ŸÜÿ©"]||(u.match(/(19|20)\d{2}/)||[""])[0],f=u.replace(/\b(19|20)\d{2}\b/g,"").trim(),p=[r,a,i].filter(Boolean).join(" ");INDEX.push({id:INDEX.length,raw:{title:n,author:r,other_author:a,corporate_name:i,subject:s,summary:l,content:c,publisher:f,year:m,book_url:d},nTitle:norm(n),nAuthorAll:norm(p),nSummary:norm(l),nContent:norm(c),nSubject:norm(s),nPub:norm(f+" "+i),nYear:norm(m)})}}LOADED=!0,status.textContent=`‚úÖ Loaded ${INDEX.length} records`}catch(e){status.textContent=`‚ùå Error: ${e.message}`}finally{setBusy(!1)}}
function searchField(e,t){const n=norm(t),o=[];MATCH_NOTE="";for(const t of INDEX){let r=!1,a=0;if("author"===e){const e=t.split(/\s+/).filter(e=>e.length>=2&&!/^\d+$/.test(e));if(e.length>=2){if(e.every(e=>t.nAuthorAll.includes(e)))a=100+e.length,r=!0}else{const t=e[0]||n;t&&t.nAuthorAll.includes(t)&&(a=85,r=!0)}}else"title"===e?t.nTitle.includes(n)&&(a=80,r=!0):"subject"===e?(t.nSubject.includes(n)&&(a=100,r=!0),t.nTitle.includes(n)&&(a=85,r=!0),r&&isFamousPerson(t)&&(MATCH_NOTE="Books ABOUT this person")):"summary"===e?(t.nSummary.includes(n)&&(a=90,r=!0),t.nContent.includes(n)&&(a=80,r=!0)):"year"===e?t.nYear.includes(n)&&(a=60,r=!0):"pub"===e&&t.nPub.includes(n)&&(a=50,r=!0);r&&o.push({sc:a,...t})}return o.sort((e,t)=>t.sc-e.sc),o}
async function translateText(e,t){try{const n=isArabic(e)?"ar":"en";if(n===t)return e;const o=`https://api.mymemory.translated.net/get?q=${encodeURIComponent(e)}&langpair=${n}|${t}`,r=await(await fetch(o)).json();if(r.responseData&&r.responseData.translatedText)return r.responseData.translatedText;throw new Error("Translation failed")}catch(e){return console.error("Translation error:",e),null}}
async function translateRecord(e,t,n){const o=INDEX.find(t=>t.id===e);if(o){const e=o.raw[t];if(e){n.textContent="‚è≥",n.disabled=!0;const t=await translateText(e,isArabic(e)?"en":"ar");if(t){const e=document.createElement("div");e.className="translated",e.innerHTML=`<strong>${isArabic(t)?"ÿßŸÑÿ™ÿ±ÿ¨ŸÖÿ©:":"Translation:"}</strong> ${t}`,n.parentElement.appendChild(e),n.remove()}else n.textContent="üåê",n.disabled=!1}}}
async function getAISummary(e,t){if(0===t.length)return null;try{const n=t.slice(0,20).map(e=>({id:e.id,title:e.raw.title,author:e.raw.author,subject:e.raw.subject||"",summary:e.raw.summary||e.raw.content||""})),o=await fetch(`${BACKEND_URL}/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:e,matchedBooks:n,searchField:LAST.field})});if(!o.ok)return null;return(await o.json()).answer}catch(e){return console.error("AI summary error:",e),null}}
function clearResults(){body.innerHTML=""}
function renderChunk(e){const t=document.createDocumentFragment();for(const n of e){const e=n.raw,o=document.createElement("div");o.className="row",o.dir=isArabic(e.title||e.author)?"rtl":"ltr";const r=[e.author,e.other_author,e.corporate_name].filter(Boolean).join(" ‚Ä¢ "),a=[e.publisher,e.year].filter(Boolean).join(" ‚Ä¢ "),i=isArabic(e.title)?"EN":"AR";o.innerHTML=`<button class="translate-icon" onclick="translateRecord(${n.id},'title',this)">üåê ${i}</button><div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;padding-left:60px"><b style="font-size:15px;line-height:1.4;flex:1;min-width:0;word-break:break-word">${e.title||"(ÿ®ÿØŸàŸÜ ÿπŸÜŸàÿßŸÜ)"}</b>${e.book_url?`<a class="btn" href="${e.book_url}" target="_blank" style="flex-shrink:0">Open</a>`:'<button class="btn" disabled style="flex-shrink:0">No URL</button>'}</div>${r?`<div class="meta">${isArabic(r)?"ÿßŸÑŸÖÿ§ŸÑŸÅ: ":"Author: "}${r}</div>`:""}${e.subject?`<div class="meta">${isArabic(e.subject)?"ÿßŸÑŸÖŸàÿ∂Ÿàÿπ: ":"Subject: "}${e.subject}</div>`:""}${a?`<div class="meta">${a}</div>`:""}${e.summary?`<div style="margin-top:6px;font-size:13px">${e.summary.length>300?e.summary.slice(0,297)+"‚Ä¶":e.summary}</div>`:""}`,t.appendChild(o)}body.appendChild(t)}
function addShowMoreIfNeeded(){const e=document.getElementById("more-btn");if(e&&e.remove(),!(LAST.shown>=LAST.items.length)){const e=document.createElement("div");e.className="more-row",e.id="more-btn";const t=document.createElement("button"),n=LAST.items.length-LAST.shown;t.textContent=n>PAGE_SIZE?"Show more":"Show all",t.onclick=()=>{const e=Math.min(LAST.shown+PAGE_SIZE,LAST.items.length);renderChunk(LAST.items.slice(LAST.shown,e)),LAST.shown=e,addShowMoreIfNeeded()},e.appendChild(t),body.appendChild(e)}}
async function renderAll(e,t,n){clearResults();const o={author:"ÿßŸÑŸÖÿ§ŸÑŸÅ + ÿßŸÑŸÖÿ§ŸÑŸÅ ÿßŸÑŸÖÿ¥ÿßÿ±ŸÉ",title:"ÿßŸÑÿπŸÜŸàÿßŸÜ",subject:"ÿßŸÑŸÖŸàÿ∂Ÿàÿπ + ÿßŸÑÿπŸÜŸàÿßŸÜ",summary:"ÿßŸÑŸÖŸÑÿÆÿµ + ÿßŸÑŸÖÿ≠ÿ™ŸàŸäÿßÿ™",year:"ÿ≥ŸÜÿ© ÿßŸÑŸÜÿ¥ÿ±",pub:"ÿßŸÑŸÜÿßÿ¥ÿ±"}[t]||t,r=document.createElement("div");r.className="info";const a=MATCH_NOTE?" ‚Ä¢ "+MATCH_NOTE:"";if(r.textContent=`Searching: ${o}${a}`,body.appendChild(r),!e.length){const e=document.createElement("div");return e.className="info",e.textContent="ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨ / No results found",void body.appendChild(e)}const i=document.createElement("div");i.className="ai-summary",i.innerHTML="‚è≥ AI analyzing summaries...",body.appendChild(i),getAISummary(n,e.slice(0,20)).then(e=>{e?i.innerHTML=e:i.remove()});const s=document.createElement("div");s.className="info",s.textContent=`Ÿàÿ¨ÿØÿ™ ${e.length} ŸÜÿ™Ÿäÿ¨ÿ© / Found ${e.length} results`,body.appendChild(s),LAST.items=e,LAST.shown=Math.min(PAGE_SIZE,e.length),LAST.field=t,renderChunk(e.slice(0,LAST.shown)),addShowMoreIfNeeded()}
async function run(){setBusy(!0,"Searching‚Ä¶");try{await ensureLoaded();const e=q.value.trim();if(!e)return void setBusy(!1);const t=chooseField(e),n=searchField(t,e);await renderAll(n,t,e)}finally{setBusy(!1)}}
go.onclick=run,q.addEventListener("keydown",e=>{"Enter"===e.key&&run()}),window.translateRecord=translateRecord;
</script>
</body>
</html>
