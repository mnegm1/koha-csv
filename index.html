<!DOCTYPE html>
<html lang="ar" dir="auto">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Koha Search (AR/EN) — Robust CSV/TSV Parser</title>
<style>
  :root{ --brand:#BF9849; --brandText:#fff; }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#F3EFED;margin:0;padding:2rem}
  .box{max-width:720px;margin:auto;background:#fff;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.15);overflow:hidden}
  .head{background:var(--brand);color:#fff;padding:12px 16px;font-weight:700}
  .bar{display:flex;gap:8px;padding:12px;background:#fafafa;border-top:1px solid #e7e7e7}
  .bar input{flex:1;padding:10px;border:1px solid #cfd9e3;border-radius:8px;font-size:15px}
  .bar button{background:var(--brand);color:#fff;border:none;border-radius:8px;padding:10px 14px;font-weight:700;cursor:pointer}
  .status{font-size:12px;opacity:.8;padding:10px 12px}
  .body{padding:12px}
  .row{background:#f6f9fc;border:1px solid #e7edf4;border-radius:12px;padding:12px;margin:10px 0}
  .meta{opacity:.85;font-size:12px;margin-top:6px}
  .btn{display:inline-block;margin-top:8px;background:var(--brand);color:#fff;text-decoration:none;padding:6px 10px;border-radius:8px}
</style>
</head>
<body>
<div class="box">
  <div class="head">Koha Search (Arabic + English)</div>
  <div id="status" class="status">Loading…</div>
  <div class="bar">
    <input id="q" placeholder="اكتب: اسم مؤلف / عنوان / موضوع / سنة (مثال: 2019)" dir="auto" />
    <button id="go">Search</button>
  </div>
  <div class="body" id="body"></div>
</div>

<script>
/* ======= CONFIG ======= */
const DATA_URL = "/koha-csv/opac-catalog.csv"; // CSV or .tab — auto-sniffed

/* ======= UTF-8 + Arabic normalization ======= */
function stripBidi(s){ return String(s||"").replace(/[\u200E\u200F\u202A-\u202E]/g,""); }
function clean(s){ return stripBidi(String(s||"").replace(/^\uFEFF/,"")); }
function norm(s){
  if(!s) return "";
  s = clean(s).toLowerCase();
  try{ s = s.normalize("NFKD"); }catch(e){}
  // fold common Arabic variants
  s = s
    .replace(/[إأآٱ]/g,"ا")
    .replace(/[ىی]/g,"ي")
    .replace(/ة/g,"ه")
    .replace(/ک/g,"ك")
    // remove Arabic diacritics + tatweel
    .replace(/[\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06ED\u0640]/g,"")
    // fold digits
    .replace(/[\u0660-\u0669]/g, d => d.charCodeAt(0)-0x0660)
    .replace(/[\u06F0-\u06F9]/g, d => d.charCodeAt(0)-0x06F0)
    // keep letters, numbers, space
    .replace(/[^\p{L}\p{N}\s]/gu," ")
    .replace(/\s+/g," ")
    .trim();
  return s;
}
function isArabic(s){ return /[\u0600-\u06FF]/.test(s||""); }

/* ======= Robust CSV/TSV parser (quoted fields, any delimiter) ======= */
function sniffDelimiter(headerLine){
  const cnt = ch => (headerLine.match(new RegExp("\\"+ch,"g"))||[]).length;
  const cand = [",",";","\t","|"].map(d=>({d,n:cnt(d)})).sort((a,b)=>b.n-a.n);
  return cand[0].n>0 ? cand[0].d : ",";
}
function parseTable(text){
  text = clean(String(text||"")).replace(/\r\n?/g,"\n");
  if(!text.trim()) return {headers:[], rows:[], delim:","};
  const firstNL = text.indexOf("\n");
  const firstLine = firstNL>=0 ? text.slice(0,firstNL) : text;
  const DELIM = sniffDelimiter(firstLine);

  const rows=[]; let i=0, field="", row=[], inQuotes=false;
  while(i<text.length){
    const ch = text[i];
    if(inQuotes){
      if(ch==="\""){
        if(i+1<text.length && text[i+1]==="\""){ field+="\""; i+=2; continue; } // escaped quote
        inQuotes=false; i++; continue;
      } else { field+=ch; i++; continue; }
    } else {
      if(ch==="\""){ inQuotes=true; i++; continue; }
      if(ch===DELIM){ row.push(field); field=""; i++; continue; }
      if(ch==="\n"){ row.push(field); field=""; rows.push(row); row=[]; i++; continue; }
      field+=ch; i++; continue;
    }
  }
  // push last field/row
  row.push(field);
  if(row.length && (row.length>1 || row[0] !== "")) rows.push(row);

  if(!rows.length) return {headers:[], rows:[], delim:DELIM};
  const headers = rows[0].map(h => clean(h).toLowerCase());
  const out=[];
  for(let r=1;r<rows.length;r++){
    const rec={}; const cols=rows[r];
    for(let c=0;c<headers.length;c++){
      const key = headers[c] || ("col"+c);
      rec[key] = clean(cols[c] ?? "");
    }
    out.push(rec);
  }
  return {headers, rows:out, delim:DELIM};
}

/* ======= Header aliases (your screenshots) ======= */
function pick(obj, keys){
  for(const k of keys){
    const kk = k.toLowerCase();
    if (Object.prototype.hasOwnProperty.call(obj, kk) && obj[kk]) return obj[kk];
  }
  return "";
}
function mapRecord(k){
  const title   = pick(k, ["full title","title","العنوان","عنوان","اسم الكتاب"]);
  const author  = pick(k, ["author","authors","المؤلف","المؤلفون","كاتب","بقلم","اسم المؤلف"]);
  const summary = pick(k, ["abstract","summary","الملخص","نبذة","وصف"]);
  const content = pick(k, ["content","contents","المحتويات","المحتوى","نص"]);
  const subject = pick(k, ["subjects","subject","topic","topics","الموضوعات","الموضوع","موضوع","التخصص","الكلمات المفتاحية"]);
  const pubdat  = pick(k, ["publications data","publication data","publishing data","publisher data","بيانات النشر","تاريخ النشر","سنة النشر"]);
  const url     = pick(k, ["book_url","book url","url","رابط الكتاب","رابط_الكتاب","link"]);

  // Extract year from Publications data (supports 19xx/20xx)
  let year = pick(k, ["year","السنة","سنة النشر","تاريخ"]);
  if(!year){
    const ym = String(pubdat).match(/(19|20)\d{2}/);
    year = ym ? ym[0] : "";
  }
  const publisher = pubdat ? String(pubdat).replace(/\b(19|20)\d{2}\b/g,"").trim() : "";

  return {title,author,summary,content,subject,publisher,year,url,pubdat};
}

/* ======= Build index ======= */
let INDEX=[]; let HEADERS=[];
async function ensureLoaded(){
  try{
    const buf = await fetch(DATA_URL, {cache:"reload"}).then(r=>{ if(!r.ok) throw new Error(`Fetch ${r.status} ${r.statusText}`); return r.arrayBuffer(); });
    const text = new TextDecoder("utf-8",{fatal:false}).decode(buf);
    const parsed = parseTable(text);
    HEADERS = parsed.headers;
    const recs = parsed.rows.map(mapRecord);

    INDEX = recs.map((r,i)=>({
      id:i, raw:r,
      nTitle:  norm(r.title),   aTitle:  norm(r.title),
      nAuthor: norm(r.author),  aAuthor: norm(r.author),
      nSummary:norm(r.summary), aSummary:norm(r.summary),
      nContent:norm(r.content), aContent:norm(r.content),
      nSubject:norm(r.subject), aSubject:norm(r.subject),
      nPub:    norm(r.pubdat||""), nYear: norm(r.year||"")
    }));

    document.getElementById("status").textContent =
      `Loaded ${INDEX.length} records · delimiter “${parsed.delim}” · headers: ${HEADERS.join(" | ")}`;
  }catch(e){
    document.getElementById("status").textContent = `Load error: ${e.message}`;
    console.error(e);
  }
}

/* ======= Field choice ======= */
const AR_NAME_PARTS = new Set(["بن","ابن","بنت","أبو","ابو","آل","عبد","عبدال"]);
const EN_STOP = new Set(["the","a","an","of","and","for","on","in","to","with"]);
function looksLikeYear(q){ return /^\d{4}$/.test(q.trim()); }
function looksLikeName(q){
  const s = q.trim(); if(!s || looksLikeYear(s)) return false;
  const toks = s.split(/\s+/).filter(Boolean);
  if(toks.length<1 || toks.length>5) return false;
  let lettersOK=0, arPart=false;
  for(const t of toks){
    const nt = norm(t);
    if(/^[a-z\u0600-\u06FF]+$/i.test(nt)) lettersOK++;
    if(AR_NAME_PARTS.has(nt)) arPart=true;
    if(EN_STOP.has(nt)) return false;
  }
  if(lettersOK !== toks.length && lettersOK < toks.length-1) return false;

  // quick probe in authors
  const nq = norm(s);
  for(let i=0;i<Math.min(500, INDEX.length);i++){
    if(INDEX[i].nAuthor.includes(nq)) return true;
  }
  return arPart || toks.length===2;
}
function chooseField(q){
  if(looksLikeYear(q)) return "year";
  if(looksLikeName(q)) return "author";

  const nq = norm(q);
  let votes = {title:0, subject:0, summary:0, author:0, pub:0};
  for(let i=0;i<Math.min(1500, INDEX.length); i++){
    const r = INDEX[i];
    if(r.nTitle.includes(nq))   votes.title++;
    if(r.nSubject.includes(nq)) votes.subject++;
    if(r.nSummary.includes(nq)) votes.summary++;
    if(r.nContent.includes(nq)) votes.summary+=0.6;
    if(r.nAuthor.includes(nq))  votes.author+=0.6;
    if(r.nPub.includes(nq))     votes.pub+=0.6;
  }
  // light weights: subject slightly > title if equal
  const w = {author:votes.author*1.1, subject:votes.subject*1.1, title:votes.title, summary:votes.summary*0.95, pub:votes.pub};
  let best="title", bestV=-1;
  for(const k of Object.keys(w)){ if(w[k]>bestV){ best=k; bestV=w[k]; } }
  return best;
}

/* ======= Searches ======= */
function searchField(field, q){
  const nq = norm(q);
  const out=[];
  for(const r of INDEX){
    let sc=0, hit=false;
    if(field==="author" && r.nAuthor.includes(nq)){ sc+=10; hit=true; }
    else if(field==="title" && r.nTitle.includes(nq)){ sc+=8; hit=true; }
    else if(field==="subject" && r.nSubject.includes(nq)){ sc+=7; hit=true; }
    else if(field==="summary" && (r.nSummary.includes(nq) || r.nContent.includes(nq))){ sc+=6; hit=true; }
    else if(field==="year" && r.nYear.includes(nq)){ sc+=6; hit=true; }
    else if(field==="pub" && (r.nPub.includes(nq) || r.nYear.includes(nq))){ sc+=5; hit=true; }

    if(hit) out.push({sc, raw:r.raw});
  }
  out.sort((a,b)=>b.sc-a.sc);
  return out;
}
function searchBroad(q){
  const nq = norm(q);
  const out=[];
  for(const r of INDEX){
    let sc=0, hit=false;
    if(r.nAuthor.includes(nq)){ sc+=9; hit=true; }
    if(r.nTitle.includes(nq)) { sc+=7; hit=true; }
    if(r.nSubject.includes(nq)) { sc+=6; hit=true; }
    if(r.nSummary.includes(nq)){ sc+=5; hit=true; }
    if(r.nContent.includes(nq)) { sc+=3; hit=true; }
    if(r.nPub.includes(nq)) { sc+=3; hit=true; }
    if(r.nYear.includes(nq)) { sc+=4; hit=true; }
    if(hit) out.push({sc, raw:r.raw});
  }
  out.sort((a,b)=>b.sc-a.sc);
  return out;
}

/* ======= Render ======= */
function kohaURL(title){ return location.origin + "/cgi-bin/koha/opac-search.pl?q=" + encodeURIComponent('ti="'+(title||"")+'"'); }
function render(list, note){
  const B = document.getElementById("body");
  B.innerHTML = "";
  const noteEl = document.createElement("div");
  noteEl.className = "meta";
  noteEl.textContent = note;
  B.appendChild(noteEl);

  if(!list.length){
    const d=document.createElement("div"); d.className="row"; d.textContent="No results found.";
    B.appendChild(d); return;
  }
  for(const it of list.slice(0,30)){
    const r = it.raw;
    const div = document.createElement("div");
    div.className = "row";
    div.dir = isArabic((r.title||"")+(r.summary||"")+(r.content||"")+(r.author||"")+(r.subject||"")+(r.publisher||"")) ? "rtl" : "ltr";
    const openUrl = (r.url && /^https?:\/\//i.test(r.url)) ? r.url : kohaURL(r.title||"");
    const pubLine = [r.publisher, r.year].filter(Boolean).join(" • ");
    div.innerHTML =
      `<div style="display:flex;justify-content:space-between;gap:8px;align-items:center;">
         <b style="font-size:15px;line-height:1.3">${(r.title||"").replace(/</g,"&lt;")}</b>
         <a class="btn" href="${openUrl}" target="_blank" rel="noopener">Open record</a>
       </div>` +
      (r.author?  `<div class="meta">${isArabic(r.author)?'المؤلف: ':'Author: '}${r.author}</div>` : "") +
      (r.subject? `<div class="meta">${isArabic(r.subject)?'الموضوع: ':'Subject: '}${r.subject}</div>` : "") +
      (pubLine?   `<div class="meta">${pubLine}</div>` : "") +
      (r.summary? `<div style="margin-top:6px">${r.summary.length>360? r.summary.slice(0,357)+'…' : r.summary}</div>` : "");
    B.appendChild(div);
  }
}

/* ======= Actions ======= */
async function run(){
  await ensureLoaded();
  const q = document.getElementById("q").value.trim();
  if(!q){ return; }

  const field = chooseField(q); // author/title/subject/summary/year/pub
  let results = searchField(field, q);
  let labelAR = {author:"المؤلف", title:"العنوان", subject:"الموضوع", summary:"الملخص", year:"سنة النشر", pub:"بيانات النشر"}[field] || field;
  let note = `Searching field: ${field} / حقل البحث: ${labelAR}`;

  if(!results.length){
    // fallback
    results = searchBroad(q);
    if(results.length) note = `No exact hits in “${labelAR}”. Showing best matches across fields.`;
  }
  render(results, note);
}

document.getElementById("go").onclick = run;
document.getElementById("q").addEventListener("keydown", e => { if(e.key==="Enter") run(); });

ensureLoaded();
</script>
</body>
</html>
