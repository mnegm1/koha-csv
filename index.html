<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Koha ODS Chatbot</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.3/dist/xlsx.full.min.js"></script>
</head>
<body style="font-family:sans-serif; background:#F3EFED; padding:2rem;">
  <h2>Koha ODS Chatbot</h2>
  <p>This page loads the ODS catalog and adds the chat bubble ðŸ’¬ automatically.</p>

  <!-- chatbot script -->
  <script>
  const BOT_CFG = {
    DATA_URL: "https://raw.githubusercontent.com/mnegm1/koha-csv/main/opac-catalog.ods",
   
    MAX_RESULTS: 5,
    MIN_QUERY_LEN: 2,
    THEME: { accent: "#3EA3DC", dark: "#BF9849" },
    LANG: (document.documentElement.dir === "rtl" ||
           document.documentElement.lang?.startsWith("ar")) ? "ar" : "en"
  };

  const AR = {
    stripDia: s => s.replace(/[\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06ED]/g, ""),
    norm: s => s.replace(/\u0640/g,"").replace(/\u0629/g,"\u0647").replace(/\u064A/g,"\u0649")
  };
  function norm(s){ if(!s) return ""; const t = String(s).toLowerCase().normalize("NFKD").replace(/[\u0300-\u036f]/g,"");
    return /[\u0600-\u06FF]/.test(t)? AR.stripDia(AR.norm(t)) : t; }
  function toks(s){ return norm(s).split(/[^0-9\u0600-\u06FFa-zA-Z]+/).filter(Boolean); }

  async function loadODS(url){
    const r = await fetch(url); if(!r.ok) throw new Error("ODS fetch failed");
    const b = await r.arrayBuffer(); const wb = XLSX.read(b,{type:"array"});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws,{defval:"",raw:false});
    return rows.map(r=>{
      const k = Object.fromEntries(Object.entries(r).map(([h,v])=>[String(h).trim().toLowerCase(),v]));
      return {title:k.title??k.ti??"",author:k.author??k.authors??"",
              publisher:k.publisher??k.pub??"",year:k.year??k.date??"",
              summary:k.summary??k.abstract??"",url:k.url??""};
    });
  }

  const WEIGHTS={title:4,author:3,summary:1.5,publisher:1,year:2};
  const STOP=new Set(["the","and","of","in","on","for","a","an","to","with","by","Ø¹Ù†","ÙÙŠ","Ø¹Ù„Ù‰","Ù…Ù†","Ùˆ","Ø§Ù„Ù‰"]);
  function buildIndex(rows){return rows.map(r=>({raw:r,tokens:{title:toks(r.title),author:toks(r.author),summary:toks(r.summary),publisher:toks(r.publisher)},
    n:{title:norm(r.title),summary:norm(r.summary)}}));}
  function score(qT,rec){let s=0;for(const f of["title","author","summary","publisher"]){const w=WEIGHTS[f],F=rec.tokens[f];let h=0;
    for(const qt of qT){if(STOP.has(qt))continue;if(F.includes(qt))h+=1;else if(qt.length>=3&&F.some(t=>t.startsWith(qt)))h+=0.6;}
    if(f==="title"&&h>0)h*=1.2;s+=h*w;}return s;}
  function search(idx,q,lim){const qT=toks(q);const out=[];for(const rec of idx){const sc=score(qT,rec);if(sc>0)out.push({sc,rec});}
    out.sort((a,b)=>b.sc-a.sc);return out.slice(0,lim??BOT_CFG.MAX_RESULTS);}

  function ui(state){
    const css=`.fab{position:fixed;right:18px;bottom:18px;background:${BOT_CFG.THEME.accent};color:#fff;
    border:none;border-radius:50%;width:56px;height:56px;font-size:24px;cursor:pointer;}
    .box{position:fixed;right:18px;bottom:86px;width:min(420px,92vw);max-height:70vh;background:#fff;
    border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.3);display:none;flex-direction:column;}
    .head{background:${BOT_CFG.THEME.dark};color:#fff;padding:10px;font-weight:600;display:flex;justify-content:space-between;}
    .body{padding:10px;overflow:auto;max-height:56vh;font-size:14px;}
    .row{background:#f6f9fc;border-radius:10px;padding:8px;margin:6px 0;}
    .input{display:flex;padding:10px;border-top:1px solid #eee;}
    .input input{flex:1;padding:8px;border:1px solid #ccc;border-radius:8px;}
    .input button{background:${BOT_CFG.THEME.accent};color:#fff;border:none;border-radius:8px;padding:8px 12px;margin-left:6px;}`;
    const st=document.createElement("style");st.textContent=css;document.head.appendChild(st);
    const fab=document.createElement("button");fab.className="fab";fab.textContent="ðŸ’¬";
    const box=document.createElement("div");box.className="box";
    box.innerHTML=`<div class="head"><span>Catalog Assistant</span><button style="background:none;border:none;color:#fff;">Ã—</button></div>
    <div class="body" id="body"></div>
    <div class="input"><input id="q" type="text" placeholder="Search the catalogâ€¦"><button id="go">Search</button></div>`;
    document.body.appendChild(fab);document.body.appendChild(box);
    const body=box.querySelector("#body"),q=box.querySelector("#q"),go=box.querySelector("#go"),x=box.querySelector(".head button");
    fab.onclick=()=>box.style.display=box.style.display==="flex"?"none":"flex";x.onclick=()=>box.style.display="none";
    go.onclick=()=>run();q.onkeydown=e=>{if(e.key==="Enter")run();};
    function run(){const t=q.value.trim();if(!t)return;const res=search(state.idx,t,BOT_CFG.MAX_RESULTS);
      body.innerHTML="";if(!res.length){body.innerHTML="<div class=row>No results found.</div>";return;}
      for(const {rec} of res){const r=rec.raw;const u=r.url||BOT_CFG.KOHA_OPAC_BASE+"/cgi-bin/koha/opac-search.pl?q="+encodeURIComponent(r.title);
        body.insertAdjacentHTML("beforeend",`<div class=row><b><a href='${u}' target=_blank>${r.title}</a></b><br>${r.author||""} â€¢ ${r.year||""}</div>`);}
    }
  }

  loadODS(BOT_CFG.DATA_URL).then(rows=>{const idx=buildIndex(rows);ui({idx});});
  </script>
</body>
</html>
