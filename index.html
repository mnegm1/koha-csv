<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Koha TSV Chatbot — Fielded Search (AR/EN)</title>
<style>
  :root{
    --brand:#BF9849; --brandText:#fff;
    --logo-url:url("https://assets.almanhal.com/platform/shared/Product/ECSSR/middlelogo.png");
    --logo-size:130%; --fab-size:56px;
    --box-width:420px; --box-max-h:62vh;
    --label-text:"AI Assist"; --label-color:var(--brand); --label-size:12px;
  }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#F3EFED;padding:2rem}
  .fab-wrap{position:fixed;right:18px;bottom:18px;z-index:9999;width:var(--fab-size);height:calc(var(--fab-size) + 34px)}
  .fab-label{position:absolute;left:50%;bottom:calc(var(--fab-size) + 4px);transform:translateX(-50%);
    width:calc(var(--fab-size) + 36px);height:34px;pointer-events:none;filter:drop-shadow(0 1px 0 rgba(255,255,255,.65))}
  .fab-label text{fill:var(--label-color);font-weight:700;font-size:var(--label-size);letter-spacing:.5px}
  .fab{position:absolute;left:0;bottom:0;width:var(--fab-size);height:var(--fab-size);
    background:#fff var(--logo-url) center/var(--logo-size) no-repeat;border:4px solid var(--brand);
    border-radius:50%;cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,.25);transform:translateZ(0)}
  @keyframes bounceGlow{0%,100%{transform:translateY(0);box-shadow:0 8px 20px rgba(0,0,0,.25)}
    30%{transform:translateY(-10px);box-shadow:0 12px 26px rgba(191,152,73,.35)}
    60%{transform:translateY(0);box-shadow:0 10px 22px rgba(191,152,73,.25)}
    80%{transform:translateY(-5px);box-shadow:0 10px 26px rgba(191,152,73,.3)}}
  .fab.attn{animation:bounceGlow 2.6s ease-in-out 1}
  .box{position:fixed;right:18px;bottom:calc(18px + var(--fab-size) + 12px);width:min(var(--box-width),92vw);
    max-height:var(--box-max-h);background:#fff;border-radius:14px;border:1px solid #e8eef3;
    box-shadow:0 16px 40px rgba(0,0,0,.25);display:none;flex-direction:column;overflow:hidden;z-index:9999}
  .head{background:var(--brand);color:var(--brandText);padding:10px 14px;font-weight:600;display:flex;justify-content:space-between;align-items:center}
  .body{padding:10px;overflow:auto;max-height:calc(var(--box-max-h) - 120px);font-size:14px}
  .row{background:#f6f9fc;border:1px solid #e7edf4;border-radius:12px;padding:12px;margin:10px 0}
  .meta{opacity:.85;font-size:12px;margin-top:6px}
  .input{display:flex;gap:8px;padding:10px;background:#fafafa;border-top:1px solid #e8eef3;align-items:center}
  .input input{flex:1;padding:10px;border-radius:10px;border:1px solid #cfd9e3}
  .input button{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:600}
  .input button:hover{filter:brightness(.95)}
  .hint{font-size:12px;opacity:.8;margin-left:6px}
  .error{background:#fff0f0;border:1px solid #f5b5b5;color:#900;padding:10px}
  .btn{flex:0 0 auto;background:var(--brand);color:#fff;padding:6px 10px;border-radius:8px;text-decoration:none;font-weight:600}
  .btn:hover{filter:brightness(.95)}
  .more-row{display:flex;justify-content:center;margin:8px 0 2px}
  .more-row button{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:8px 14px;font-weight:600;cursor:pointer}
  .more-row button:disabled{opacity:.5;cursor:default}
</style>
</head>
<body>
  <h2 style="margin-bottom:6px">Koha TSV Chatbot</h2>
  <p style="opacity:.7;margin-top:0">Fielded search (AR/EN). Examples:
    <code>author: Naguib Mahfouz</code> — <code>كاتب: نجيب محفوظ</code> —
    <code>title: التنمية</code> — <code>subject: أمن الخليج</code> — <code>abstract: الطاقة</code>
  </p>

<script>
/* ===== error banner ===== */
addEventListener("error", e => showBannerError("JS error: " + (e.message||e)));
addEventListener("unhandledrejection", e => showBannerError("Promise error: " + (e.reason?.message||e.reason)));
function showBannerError(msg){
  let el=document.getElementById("top-error");
  if(!el){ el=document.createElement("div"); el.id="top-error"; el.className="error"; document.body.prepend(el); }
  el.textContent = String(msg||"Unknown error");
}

/* ===== UI ===== */
const wrap=document.createElement("div"); wrap.className="fab-wrap";
const label=document.createElementNS("http://www.w3.org/2000/svg","svg");
label.setAttribute("class","fab-label"); label.setAttribute("viewBox","0 0 120 40");
label.innerHTML=`<defs><path id="ka-arc" d="M 10,34 A 50,50 0 0 1 110,34"/></defs>
<text text-anchor="middle"><textPath href="#ka-arc" startOffset="50%">AI Assist</textPath></text>`;
const fab=document.createElement("button"); fab.className="fab attn"; fab.setAttribute("aria-label","AI Assistant");
wrap.appendChild(label); wrap.appendChild(fab); document.body.appendChild(wrap);

const box=document.createElement("div"); box.className="box";
box.innerHTML='' +
  '<div class="head"><div>AI Assistant</div>' +
  '<button id="x" style="background:none;border:none;color:#fff;font-size:18px;cursor:pointer" title="Close">×</button></div>' +
  '<div class="body" id="body"></div>' +
  '<div class="input">' +
    '<input id="q" type="text" placeholder="author: … | title: … | subject: … | abstract: … — كاتب: … | عنوان: … | موضوع: … | ملخص: …" dir="auto">' +
    '<button id="go">Search</button>' +
  '</div>' +
  '<div class="hint" id="hint" style="padding:0 12px 12px 12px">If no field is given, I search Title + Summary + Content. استخدم بادئة مثل <b>كاتب:</b> أو <b>عنوان:</b> للبحث في حقل محدد فقط.</div>';
document.body.appendChild(box);

const B=box.querySelector("#body"), Q=box.querySelector("#q"), GO=box.querySelector("#go"), closeBtn=box.querySelector("#x");
setTimeout(()=>fab.classList.remove('attn'),3000);
fab.onclick=()=>{ box.style.display=(box.style.display==="flex"?"none":"flex"); if(box.style.display==="flex") setTimeout(()=>Q.focus(),50); };
closeBtn.onclick=()=>{ box.style.display="none"; };

/* ===== Arabic helpers / normalization ===== */
const AR_ANY=/[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]/;
function isArabic(s){ return AR_ANY.test(String(s||"")); }
function normalizeArabicForms(str){
  if(!str) return "";
  const map={'ﺍ':'ا','ﺎ':'ا','ﺃ':'ا','ﺄ':'ا','ﺇ':'ا','ﺈ':'ا','ٱ':'ا','ﻻ':'لا','ﻼ':'لا'};
  return str.replace(/[\uFE70-\uFEFF\uFB50-\uFDFF]/g, ch=>map[ch]||ch);
}
function stripLatinDiacritics(s){ return s.replace(/[\u0300-\u036f]/g,""); }
function foldDigits(s){ return s.replace(/[\u0660-\u0669]/g,d=>d.charCodeAt(0)-0x0660).replace(/[\u06F0-\u06F9]/g,d=>d.charCodeAt(0)-0x06F0); }
function norm(s){
  if(!s) return "";
  let t=String(s).toLowerCase();
  try{t=t.normalize("NFKD");}catch(e){}
  t=stripLatinDiacritics(t);
  t=normalizeArabicForms(t);
  t=foldDigits(t);
  return t
    .replace(/[\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06ED\u0640]/g,"")
    .replace(/[إأآٱ]/g,"ا").replace(/[ىی]/g,"ي").replace(/ک/g,"ك");
}
const AR_LETTER_ONLY=/[ء-ي]/g;
function arLettersOnly(s){ const n=norm(s).replace(/ة/g,"ه").replace(/ى/g,"ي"); let out="",m; while((m=AR_LETTER_ONLY.exec(n))!==null) out+=m[0]; return out; }
function subseq(hay,needle){ if(!needle) return false; let i=0,j=0; while(i<hay.length&&j<needle.length){ if(hay.charCodeAt(i)===needle.charCodeAt(j)) j++; i++; } return j===needle.length; }

/* ===== Config ===== */
const BOT_CFG={ DATA_URL:"/koha-csv/opac-catalog.tab", PAGE_SIZE:12, MIN_QUERY_LEN:1, KOHA_OPAC_BASE:location.origin };

/* ===== TSV mapping (now with SUBJECT) ===== */
function parseTSV(text){
  const lines = text.replace(/\r\n?/g,"\n").split("\n").filter(l=>l.length>0);
  if(!lines.length) return [];
  const headers = lines[0].split("\t").map(h=>h.trim().toLowerCase());
  const rows=[];
  for(let i=1;i<lines.length;i++){
    const cols = lines[i].split("\t");
    const obj={};
    for(let c=0;c<headers.length;c++){ obj[headers[c]] = cols[c]? String(cols[c]).trim() : ""; }
    rows.push(obj);
  }
  return rows;
}
function mapRecord(k){
  const title   = k["full title"]||k["العنوان"]||k.title||"";
  const author  = k["author"]||k["المؤلف"]||k["المؤلفون"]||"";
  const summary = k["abstract"]||k["الملخص"]||"";
  const content = k["content"]||k["المحتوى"]||"";
  const subject = k["subject"]||k["subjects"]||k["topic"]||k["الموضوع"]||k["موضوع"]||k["التخصص"]||"";
  const pubdat  = k["publications data"]||k["بيانات النشر"]||"";
  const url     = k["book_url"]||k["book url"]||k["رابط_الكتاب"]||k["url"]||"";
  const ym = String(pubdat).match(/(\d{4})/);
  const year = ym? ym[1] : "";
  const publisher = String(pubdat||"").replace(/\b\d{4}\b/g,"").trim();
  return {title,author,summary,content,subject,publisher,year,url};
}

/* ===== Render ===== */
function kohaURL(title){ return BOT_CFG.KOHA_OPAC_BASE + "/cgi-bin/koha/opac-search.pl?q=" + encodeURIComponent('ti="'+title+'"'); }
function render(items){
  const list=document.createElement("div");
  if(!items.length){ list.innerHTML='<div class="row">No results found.</div>'; return list; }
  for(const it of items){
    const r=it.raw;
    const url = (r.url && /^https?:\/\//i.test(r.url)) ? r.url : kohaURL(r.title||"");
    const pub = [r.publisher, r.year].filter(Boolean).join(" • ");
    const div=document.createElement("div"); div.className="row";
    div.dir = isArabic((r.title||"")+(r.summary||"")+(r.content||"")+(r.author||"")+(r.subject||"")) ? "rtl" : "ltr";
    div.innerHTML =
      '<div style="display:flex;justify-content:space-between;gap:8px;align-items:center;">' +
        '<b style="font-size:15px;line-height:1.3">'+ String(r.title||"").replace(/</g,"&lt;") +'</b>' +
        '<a class="btn" href="'+url+'" target="_blank" rel="noopener">Open record</a>' +
      '</div>' +
      (r.author?  '<div class="meta">'+(isArabic(r.author)?'المؤلف: ':'Author: ')+r.author+'</div>' : '') +
      (r.subject? '<div class="meta">'+(isArabic(r.subject)?'الموضوع: ':'Subject: ')+r.subject+'</div>' : '') +
      (pub?       '<div class="meta">'+pub+'</div>' : '') +
      (r.summary? '<div style="margin-top:6px">'+ (r.summary.length>360? r.summary.slice(0,357)+'…' : r.summary) +'</div>' : '');
    list.appendChild(div);
  }
  return list;
}

/* ===== Intent detection (AR + EN) =====
   Returns { field: 'author'|'title'|'summary'|'subject'|'auto', term: '...' }
*/
const FIELD_ALIASES = {
  author:  [/^\s*(author|writer|by)\s*[:：]?\s*(.+)$/i,                // EN prefix
            /^\s*(كاتب|المؤلف|بقلم)\s*[:：]?\s*(.+)$/],                // AR prefix
  title:   [/^\s*(title)\s*[:：]?\s*(.+)$/i, /^\s*(العنوان|اسم\s*الكتاب|اسم\s*العمل)\s*[:：]?\s*(.+)$/],
  summary: [/^\s*(summary|abstract)\s*[:：]?\s*(.+)$/i, /^\s*(الملخص|نبذة)\s*[:：]?\s*(.+)$/],
  subject: [/^\s*(subject|topic)\s*[:：]?\s*(.+)$/i, /^\s*(الموضوع|موضوع|التخصص)\s*[:：]?\s*(.+)$/]
};
// also catch “author NAME” without colon at string start
const START_KEYWORDS = {
  author:  [/^\s*(author|writer|by)\s+(.+)$/i, /^\s*(كاتب|المؤلف|بقلم)\s+(.+)$/],
  title:   [/^\s*(title)\s+(.+)$/i, /^\s*(العنوان|اسم\s*الكتاب|اسم\s*العمل)\s+(.+)$/],
  summary: [/^\s*(summary|abstract)\s+(.+)$/i, /^\s*(الملخص|نبذة)\s+(.+)$/],
  subject: [/^\s*(subject|topic)\s+(.+)$/i, /^\s*(الموضوع|موضوع|التخصص)\s+(.+)$/]
};
function detectIntent(q){
  const s=q.trim();
  // explicit prefixes like "author: …", "كاتب: …"
  for (const [field, regs] of Object.entries(FIELD_ALIASES)){
    for (const re of regs){
      const m=s.match(re);
      if(m){ return {field, term:(m[2]||"").trim()}; }
    }
  }
  // start keywords like "author NAME"
  for (const [field, regs] of Object.entries(START_KEYWORDS)){
    for (const re of regs){
      const m=s.match(re);
      if(m){ return {field, term:(m[2]||"").trim()}; }
    }
  }
  // no clear intent → auto (title+summary+content)
  return {field:"auto", term:s};
}

/* ===== Build index ===== */
let INDEX=[]; let LOAD_PROMISE=null;
function ensureLoaded(){
  if (LOAD_PROMISE) return LOAD_PROMISE;
  LOAD_PROMISE = fetch(BOT_CFG.DATA_URL, {cache:"reload"})
    .then(r=>r.text())
    .then(text=>{
      const rows = parseTSV(text);
      const records = rows.map(mapRecord);
      INDEX = records.map((r,i)=>{
        const rawAll=(r.title+" "+r.author+" "+r.summary+" "+r.content+" "+r.subject+" "+r.publisher+" "+r.year).trim();
        return {
          id:i, raw:r, rawAll,
          nTitle:  norm(r.title),   aTitle:  arLettersOnly(r.title),
          nAuthor: norm(r.author),  aAuthor: arLettersOnly(r.author),
          nSummary:norm(r.summary), aSummary:arLettersOnly(r.summary),
          nContent:norm(r.content), aContent:arLettersOnly(r.content),
          nSubject:norm(r.subject), aSubject:arLettersOnly(r.subject),
          aAll:    arLettersOnly(rawAll)
        };
      });
    })
    .catch(err=>{ console.error(err); showBannerError(err?.message||String(err)); });
  return LOAD_PROMISE;
}

/* ===== Fielded search ===== */
function searchFielded(idx, intent){
  const term = intent.term.trim();
  if (!term || term.length < BOT_CFG.MIN_QUERY_LEN) return [];
  const nTerm = norm(term);
  const aTerm = arLettersOnly(term);

  // choose which normalized fields to use
  let fields = [];
  switch(intent.field){
    case "author":  fields = ["nAuthor","aAuthor"]; break;
    case "title":   fields = ["nTitle","aTitle"];   break;
    case "summary": fields = ["nSummary","aSummary"]; break;
    case "subject": fields = ["nSubject","aSubject"]; break;
    default:        fields = ["nTitle","nSummary","nContent","aAll"]; // auto/broad
  }

  // rank: exact contains (norm) gets higher score; arabic letters-only matches get lower score
  const out=[];
  for(const rec of idx){
    let sc=0, matched=false;

    // normalized text fields
    if (fields.includes("nAuthor") && rec.nAuthor.includes(nTerm)) { sc+=10; matched=true; }
    if (fields.includes("nTitle")  && rec.nTitle.includes(nTerm))  { sc+=8;  matched=true; }
    if (fields.includes("nSubject")&& rec.nSubject.includes(nTerm)){ sc+=7;  matched=true; }
    if (fields.includes("nSummary")&& rec.nSummary.includes(nTerm)){ sc+=5;  matched=true; }
    if (fields.includes("nContent")&& rec.nContent.includes(nTerm)){ sc+=3;  matched=true; }

    // arabic letters-only lanes (so diacritics/forms don’t block matches)
    if (aTerm){
      if (fields.includes("aAuthor")  && (rec.aAuthor.includes(aTerm)  || subseq(rec.aAuthor,aTerm)))  { sc+=2; matched=true; }
      if (fields.includes("aTitle")   && (rec.aTitle.includes(aTerm)   || subseq(rec.aTitle,aTerm)))   { sc+=1.6; matched=true; }
      if (fields.includes("aSubject") && (rec.aSubject.includes(aTerm) || subseq(rec.aSubject,aTerm))) { sc+=1.4; matched=true; }
      if (fields.includes("aSummary") && (rec.aSummary.includes(aTerm) || subseq(rec.aSummary,aTerm))) { sc+=1.2; matched=true; }
      if (fields.includes("aAll")     && (rec.aAll.includes(aTerm)     || subseq(rec.aAll,aTerm)))     { sc+=0.9; matched=true; }
    }

    if (matched) out.push({sc, raw:rec.raw});
  }
  out.sort((a,b)=>b.sc-a.sc);
  return out;
}

/* ===== Paging state ===== */
let LAST={items:[], shown:0};
function clearResultsArea(){ while(B.firstChild) B.removeChild(B.firstChild); }
function appendItems(items){ B.appendChild(render(items)); }
function appendShowMoreIfNeeded(){
  const old=document.getElementById("ka-more"); if(old) old.remove();
  if (LAST.shown >= LAST.items.length) return;
  const row=document.createElement("div"); row.id="ka-more"; row.className="more-row";
  const btn=document.createElement("button");
  const remaining=LAST.items.length - LAST.shown;
  btn.textContent = remaining > BOT_CFG.PAGE_SIZE ? "Show more" : "Show all";
  btn.onclick=()=>{
    const next=Math.min(LAST.shown + BOT_CFG.PAGE_SIZE, LAST.items.length);
    appendItems(LAST.items.slice(LAST.shown, next));
    LAST.shown=next; appendShowMoreIfNeeded();
  };
  row.appendChild(btn); B.appendChild(row);
}
function startNewResultSet(fullList){
  LAST.items=fullList||[]; LAST.shown=Math.min(BOT_CFG.PAGE_SIZE, LAST.items.length);
  clearResultsArea();
  if (LAST.items.length===0) { B.appendChild(render([])); }
  else { appendItems(LAST.items.slice(0, LAST.shown)); appendShowMoreIfNeeded(); }
}

/* ===== Trigger ===== */
document.addEventListener("DOMContentLoaded", ()=>{
  const body=document.getElementById("body");
  body.insertAdjacentHTML("afterbegin",
    '<div class="row">Tip: use field prefixes. مثال: <b>كاتب: نجيب محفوظ</b>، <b>عنوان: التنمية</b>، <b>موضوع: أمن الخليج</b>.</div>');
});
function runSearch(){
  ensureLoaded().then(()=>{
    const raw = Q.value.trim(); if (!raw) return;
    const intent = detectIntent(raw);
    const full = searchFielded(INDEX, intent);
    startNewResultSet(full);
  });
}
document.getElementById("go").onclick = runSearch;
Q.onkeydown = e => { if (e.key === "Enter") runSearch(); };
</script>
</body>
</html>
