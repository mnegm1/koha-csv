<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1" />
Â  <title>Koha ODS Chatbot</title>

Â  <style>
Â  Â  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#F3EFED;padding:2rem}
Â  Â  .fab{position:fixed;right:18px;bottom:18px;background:#3EA3DC;color:#fff;border:none;border-radius:50%;
Â  Â  Â  Â  Â width:56px;height:56px;font-size:24px;cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,.25);z-index:9999}
Â  Â  .box{position:fixed;right:18px;bottom:86px;width:min(520px,92vw);max-height:70vh;background:#fff;border-radius:14px;
Â  Â  Â  Â  Â border:1px solid #e8eef3;box-shadow:0 16px 40px rgba(0,0,0,.25);display:flex;flex-direction:column;overflow:hidden;z-index:9999}
Â  Â  .head{background:#BF9849;color:#fff;padding:10px 14px;font-weight:600;display:flex;justify-content:space-between}
Â  Â  .body{padding:10px;overflow:auto;max-height:56vh;font-size:14px}
Â  Â  .row{background:#f6f9fc;border:1px solid #e7edf4;border-radius:12px;padding:12px;margin:10px 0}
Â  Â  .meta{opacity:.85;font-size:12px;margin-top:6px}
Â  Â  .input{display:flex;gap:8px;padding:10px;background:#fafafa;border-top:1px solid #e8eef3}
Â  Â  .input input{flex:1;padding:10px;border-radius:10px;border:1px solid #cfd9e3}
Â  Â  .input button{background:#3EA3DC;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:600}
Â  Â  .error{background:#fff0f0;border:1px solid #f5b5b5;color:#900;padding:10px}
Â  Â  .btn{flex:0 0 auto;background:#3EA3DC;color:#fff;padding:6px 10px;border-radius:8px;text-decoration:none;font-weight:600}
Â  </style>

Â  Â  <script>
Â  (function loadSheetJS(){
Â  Â  const sources = [
Â  Â  Â  "/koha-csv/xlsx.full.min.js",
Â  Â  Â  "https://mnegm1.github.io/koha-csv/xlsx.full.min.js",
Â  Â  Â  "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.20.3/xlsx.full.min.js",
Â  Â  Â  "https://cdn.jsdelivr.net/npm/xlsx@0.20.3/dist/xlsx.full.min.js",
Â  Â  Â  "https://unpkg.com/xlsx@0.20.3/dist/xlsx.full.min.js"
Â  Â  ];
Â  Â  let i = 0;
Â  Â  function tryNext(){
Â  Â  Â  if (i >= sources.length) { window.__XLSX_LOAD_ERROR__ = "All sources failed"; return; }
Â  Â  Â  const s = document.createElement("script");
Â  Â  Â  s.src = sources[i++]; s.async = true;
Â  Â  Â  s.onloadÂ  = () => { window.__XLSX_READY__ = true; };
Â  Â  Â  s.onerror = tryNext;
Â  Â  Â  document.head.appendChild(s);
Â  Â  }
Â  Â  tryNext();
Â  })();
Â  </script>
</head>
<body>
Â  <h2>Koha ODS Chatbot</h2>
Â  <p>This page loads the ODS catalog and adds the chat bubble ğŸ’¬ automatically.</p>

Â  <script>
Â  (function startWhenReady(){
Â  Â  if (window.__XLSX_LOAD_ERROR__) {
Â  Â  Â  const pre = document.createElement("div");
Â  Â  Â  pre.className = "error";
Â  Â  Â  pre.textContent = "Failed to load XLSX library.";
Â  Â  Â  document.body.appendChild(pre);
Â  Â  Â  return;
Â  Â  }
Â  Â  if (!window.__XLSX_READY__) return setTimeout(startWhenReady, 150);

Â  Â  /* ===== CONFIG ===== */
Â  Â  const BOT_CFG = {
Â  Â  Â  DATA_URL: "https://raw.githubusercontent.com/mnegm1/koha-csv/main/opac-catalog.ods",
Â  Â  Â  MAX_RESULTS: 8,
Â  Â  Â  MIN_QUERY_LEN: 2,
Â  Â  Â  KOHA_OPAC_BASE: location.origin
Â  Â  };

Â  Â  /* ===== UI ===== */
Â  Â  const fab=document.createElement("button"); fab.className="fab"; fab.textContent="ğŸ’¬";
Â  Â  const box=document.createElement("div"); box.className="box";
Â  Â  box.innerHTML=`
Â  Â  Â  <div class="head">
Â  Â  Â  Â  <div>Catalog Assistant</div>
Â  Â  Â  Â  <button id="x" style="background:none;border:none;color:#fff;font-size:18px;cursor:pointer">Ã—</button>
Â  Â  Â  </div>
Â  Â  Â  <div class="body" id="body">
Â  Â  Â  Â  <div class="row" id="status">Loading catalogâ€¦</div>
Â  Â  Â  Â  <div class="row">Type title, author, yearØŒ Ø£Ùˆ ÙƒÙ„Ù…Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù„Ø®Øµ/Ø§Ù„Ù…Ø­ØªÙˆÙ‰. ÙÙ„Ø§ØªØ±: author:"name"Â  year:2021</div>
Â  Â  Â  </div>
Â  Â  Â  <div class="input">
Â  Â  Â  Â  <input id="q" type="text" placeholder="Search / Ø§Ø¨Ø­Ø«" dir="auto">
Â  Â  Â  Â  <button id="go">Search</button>
Â  Â  Â  </div>`;
Â  Â  document.body.appendChild(fab); document.body.appendChild(box);
Â  Â  const B = box.querySelector("#body"), Q = box.querySelector("#q"), GO = box.querySelector("#go");
Â  Â  const closeBtn = box.querySelector("#x");
Â  Â  fab.onclick = () => box.style.display = (box.style.display==="flex" ? "none" : "flex");
Â  Â  closeBtn.onclick = () => box.style.display = "none";
Â  Â  box.style.display = "flex"; Q.focus();

Â  Â  /* ===== Unicode-aware Arabic detection + tokenization ===== */
Â  Â  const U_LETTER_OR_NUMBER_RE = /[\p{L}\p{N}]+/gu;
Â  Â  const U_ARABIC_ANY_REÂ  Â  Â  Â = /\p{Script=Arabic}/u;
Â  Â  function isArabic(s){ return U_ARABIC_ANY_RE.test(String(s||"")); }

Â  Â  // Presentation-form mapping (kept)
Â  Â  function normalizeArabicForms(str){
Â  Â  Â  if(!str) return "";
Â  Â  Â  const map = {
Â  Â  Â  Â  'ïº':'Ø§','ïº':'Ø§','ïºƒ':'Ø§','ïº„':'Ø§','ïº‡':'Ø§','ïºˆ':'Ø§','Ù±':'Ø§',
Â  Â  Â  Â  'ïº':'Ø¨','ïº':'Ø¨','ïº‘':'Ø¨','ïº’':'Ø¨',
Â  Â  Â  Â  'ïº•':'Øª','ïº–':'Øª','ïº—':'Øª','ïº˜':'Øª',
Â  Â  Â  Â  'ïº™':'Ø«','ïºš':'Ø«','ïº›':'Ø«','ïºœ':'Ø«',
Â  Â  Â  Â  'ïº':'Ø¬','ïº':'Ø¬','ïºŸ':'Ø¬','ïº ':'Ø¬',
Â  Â  Â  Â  'ïº¡':'Ø­','ïº¢':'Ø­','ïº£':'Ø­','ïº¤':'Ø­',
Â  Â  Â  Â  'ïº¥':'Ø®','ïº¦':'Ø®','ïº§':'Ø®','ïº¨':'Ø®',
Â  Â  Â  Â  'ïº©':'Ø¯','ïºª':'Ø¯','ïº«':'Ø°','ïº¬':'Ø°',
Â  Â  Â  Â  'ïº­':'Ø±','ïº®':'Ø±','ïº¯':'Ø²','ïº°':'Ø²',
Â  Â  Â  Â  'ïº±':'Ø³','ïº²':'Ø³','ïº³':'Ø³','ïº´':'Ø³',
Â  Â  Â  Â  'ïºµ':'Ø´','ïº¶':'Ø´','ïº·':'Ø´','ïº¸':'Ø´',
Â  Â  Â  Â  'ïº¹':'Øµ','ïºº':'Øµ','ïº»':'Øµ','ïº¼':'Øµ',
Â  Â  Â  Â  'ïº½':'Ø¶','ïº¾':'Ø¶','ïº¿':'Ø¶','ï»€':'Ø¶',
Â  Â  Â  Â  'ï»':'Ø·','ï»‚':'Ø·','ï»ƒ':'Ø·','ï»„':'Ø·',
Â  Â  Â  Â  'ï»…':'Ø¸','ï»†':'Ø¸','ï»‡':'Ø¸','ï»ˆ':'Ø¸',
Â  Â  Â  Â  'ï»‰':'Ø¹','ï»Š':'Ø¹','ï»‹':'Ø¹','ï»Œ':'Ø¹',
Â  Â  Â  Â  'ï»':'Øº','ï»':'Øº','ï»':'Øº','ï»':'Øº',
Â  Â  Â  Â  'ï»‘':'Ù','ï»’':'Ù','ï»“':'Ù','ï»”':'Ù',
Â  Â  Â  Â  'ï»•':'Ù‚','ï»–':'Ù‚','ï»—':'Ù‚','ï»˜':'Ù‚',
Â  Â  Â  Â  'ï»™':'Ùƒ','ï»š':'Ùƒ','ï»›':'Ùƒ','ï»œ':'Ùƒ',
Â  Â  Â  Â  'ï»':'Ù„','ï»':'Ù„','ï»Ÿ':'Ù„','ï» ':'Ù„',
Â  Â  Â  Â  'ï»¡':'Ù…','ï»¢':'Ù…','ï»£':'Ù…','ï»¤':'Ù…',
Â  Â  Â  Â  'ï»¥':'Ù†','ï»¦':'Ù†','ï»§':'Ù†','ï»¨':'Ù†',
Â  Â  Â  Â  'ï»©':'Ù‡','ï»ª':'Ù‡','ï»«':'Ù‡','ï»¬':'Ù‡',
Â  Â  Â  Â  'ï»­':'Ùˆ','ï»®':'Ùˆ',
Â  Â  Â  Â  'ï»±':'ÙŠ','ï»²':'ÙŠ','ï»³':'ÙŠ','ï»´':'ÙŠ','ï»°':'Ù‰',
Â  Â  Â  Â  'ï»»':'Ù„Ø§','ï»¼':'Ù„Ø§'
Â  Â  Â  };
Â  Â  Â  return str.replace(/[\uFE70-\uFEFF\uFB50-\uFDFF]/g, ch => map[ch] || ch);
Â  Â  }

Â  Â  // Base normalizer (FIXED)
Â  Â  function norm(s){
Â  Â  Â  if (!s) return "";
Â  Â  Â  let t = String(s).toLowerCase()
Â  Â  Â  Â  .normalize("NFKD")
Â  Â  Â  Â  .replace(/[\u0300-\u036f]/g, "");
Â  Â  Â  t = normalizeArabicForms(t);
Â  Â  Â  t = t
Â  Â  Â  Â  .replace(/[\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06ED\u0640]/g,"") // tashkÄ«l + tatweel
Â  Â  Â  Â  .replace(/[\u200c-\u200f\u202a-\u202e]/g,"")Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // zero-width/bidi
Â  Â  Â  Â  // *** FIX APPLIED HERE: unifying more Arabic variants ***
Â  Â  Â  Â  .replace(/[Ø¥Ø£Ø¢Ù±]/g,"Ø§").replace(/[Ù‰ÛŒØ¦]/g,"ÙŠ").replace(/[Ø¤]/g,"Ùˆ").replace(/Ú©/g,"Ùƒ"); 
Â  Â  Â  return t;
Â  Â  }

Â  Â  // ULTRA normalizer: remove everything except letters+numbers and squash
Â  Â  function ultraNormalize(s){
Â  Â  Â  const n = norm(s).normalize("NFKC");
Â  Â  Â  return n.replace(/[^\p{L}\p{N}]+/gu,""); // drop spaces/punct entirely
Â  Â  }

Â  Â  function toks(s){
Â  Â  Â  const out = [];
Â  Â  Â  const src = String(s ?? "");
Â  Â  Â  const it = src.matchAll(U_LETTER_OR_NUMBER_RE);
Â  Â  Â  for (const m of it) {
Â  Â  Â  Â  const t = norm(m[0]);
Â  Â  Â  Â  if (t) out.push(t);
Â  Â  Â  }
Â  Â  Â  return out;
Â  Â  }

Â  Â  // Stopwords (normalized)
Â  Â  const RAW_STOP = new Set([
Â  Â  Â  "the","and","of","in","on","for","a","an","to","with","by",
Â  Â  Â  "Ø¹Ù†","ÙÙŠ","Ø¹Ù„Ù‰","Ù…Ù†","Ùˆ","Ø§Ù„Ù‰"
Â  Â  ]);
Â  Â  const STOP = new Set(Array.from(RAW_STOP, w => norm(w)));

Â  Â  Q.addEventListener("input", ()=>{ Q.dir = isArabic(Q.value) ? "rtl" : "ltr"; });

Â  Â  /* ===== Ranking / search ===== */
Â  Â  const WEIGHTS={title:4,author:3,summary:1.5,content:1.5,publisher:1,year:2};

Â  Â  function buildIndex(rows){
Â  Â  Â  return rows.map((r,i)=>({
Â  Â  Â  Â  id:i,
Â  Â  Â  Â  raw:r,
Â  Â  Â  Â  tokens:{
Â  Â  Â  Â  Â  title:toks(r.title),author:toks(r.author),summary:toks(r.summary),
Â  Â  Â  Â  Â  content:toks(r.content||""),publisher:toks(r.publisher||"")
Â  Â  Â  Â  },
Â  Â  Â  Â  n:{
Â  Â  Â  Â  Â  title:norm(r.title),summary:norm(r.summary),content:norm(r.content||""),
Â  Â  Â  Â  Â  all: norm([r.title,r.author,r.summary,r.content,r.publisher,r.year].join(" "))
Â  Â  Â  Â  },
Â  Â  Â  Â  ultra:{
Â  Â  Â  Â  Â  all: ultraNormalize([r.title,r.author,r.summary,r.content,r.publisher,r.year].join(" "))
Â  Â  Â  Â  }
Â  Â  Â  }));
Â  Â  }

Â  Â  function score(qT,rec){
Â  Â  Â  let s=0;
Â  Â  Â  const y=qT.find(t=>/^\d{4}$/.test(t));
Â  Â  Â  if(y && String(rec.raw.year||"")===y) s+=6;

Â  Â  Â  for(const f of ["title","author","summary","content","publisher"]){
Â  Â  Â  Â  const w=WEIGHTS[f], F=rec.tokens[f]||[]; if(!F.length) continue;
Â  Â  Â  Â  let h=0;
Â  Â  Â  Â  for(const qt of qT){
Â  Â  Â  Â  Â  if(STOP.has(qt)) continue;
Â  Â  Â  Â  Â  if(F.includes(qt)) h+=1;
Â  Â  Â  Â  Â  else if(qt.length>=3 && F.some(t=>t.startsWith(qt))) h+=0.6;
Â  Â  Â  Â  }
Â  Â  Â  Â  if(f==="title" && h>0) h*=1.2;
Â  Â  Â  Â  s += h*w;
Â  Â  Â  }

Â  Â  Â  const phrase=qT.join(" ");
Â  Â  Â  if(phrase && rec.n.title.includes(phrase)) s+=2.5;
Â  Â  Â  if(phrase && rec.n.summary.includes(phrase)) s+=1.0;
Â  Â  Â  if(phrase && rec.n.content.includes(phrase)) s+=1.0;

Â  Â  Â  for (const qt of qT) {
Â  Â  Â  Â  if (qt.length >= 2) {
Â  Â  Â  Â  Â  if (rec.n.title.includes(qt) || rec.n.summary.includes(qt) || (rec.n.content||"").includes(qt)) {
Â  Â  Â  Â  Â  Â  s += 0.8;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  return s;
Â  Â  }

Â  Â  // Basic fallback (normalized AND-of-terms)
Â  Â  function fallbackScan(idx, q, limit){
Â  Â  Â  const terms = toks(q);
Â  Â  Â  if (!terms.length) return [];
Â  Â  Â  const out = [];
Â  Â  Â  for (const rec of idx){
Â  Â  Â  Â  const hay = rec.n.all;
Â  Â  Â  Â  if (terms.every(t => hay.includes(t))){
Â  Â  Â  Â  Â  out.push({sc:1, rec});
Â  Â  Â  Â  Â  if (out.length >= (limit||BOT_CFG.MAX_RESULTS)) break;
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  return out;
Â  Â  }

Â  Â  // *** ULTRA Arabic fallback ***
Â  Â  // Works even if cells contain stubborn presentation forms or odd punctuation.
Â  Â  function arabicUltraScan(idx, q, limit){
Â  Â  Â  const nq = ultraNormalize(q);
Â  Â  Â  if (!nq) return [];
Â  Â  Â  const out = [];
Â  Â  Â  for (const rec of idx){
Â  Â  Â  Â  if (rec.ultra.all.includes(nq)){
Â  Â  Â  Â  Â  out.push({sc:0.9, rec});
Â  Â  Â  Â  Â  if (out.length >= (limit||BOT_CFG.MAX_RESULTS)) break;
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  return out;
Â  Â  }

Â  Â  function search(idx,q,lim){
Â  Â  Â  q=(q||"").trim(); if(q.length<BOT_CFG.MIN_QUERY_LEN) return [];
Â  Â  Â  const aF=/author:\s*"(.*?)"/i.exec(q)?.[1] || /author:\s*([^\s]+)/i.exec(q)?.[1];
Â  Â  Â  const yF=/year:\s*(\d{4})/i.exec(q)?.[1];
Â  Â  Â  const cleaned=q.replace(/author:\s*".*?"/ig,"").replace(/author:\s*[^\s]+/ig,"").replace(/year:\s*\d{4}/ig,"");
Â  Â  Â  const qT=toks(cleaned);
Â  Â  Â  const out=[];
Â  Â  Â  for(const rec of idx){
Â  Â  Â  Â  if(aF && !norm(rec.raw.author).includes(norm(aF))) continue;
Â  Â  Â  Â  if(yF && String(rec.raw.year||"")!==String(yF)) continue;
Â  Â  Â  Â  const sc=score(qT,rec); if(sc>0) out.push({sc,rec});
Â  Â  Â  }
Â  Â  Â  out.sort((a,b)=>b.sc-a.sc);
Â  Â  Â  if (out.length>0) return out.slice(0, lim??BOT_CFG.MAX_RESULTS);

Â  Â  Â  // if nothing, try tolerant normalized AND scan
Â  Â  Â  const fb = fallbackScan(idx, cleaned, lim);
Â  Â  Â  if (fb.length>0) return fb;

Â  Â  Â  // if query contains Arabic, run ultra fallback
Â  Â  Â  if (isArabic(q) || /[\u0600-\u06FF]/.test(q)) {
Â  Â  Â  Â  const ultra = arabicUltraScan(idx, q, lim);
Â  Â  Â  Â  if (ultra.length>0) return ultra;
Â  Â  Â  }
Â  Â  Â  return [];
Â  Â  }

Â  Â  function setStatus(msg, err){ const el=document.getElementById("status");
Â  Â  Â  if(!el) return; el.className = err ? "row error" : "row"; el.textContent = msg; }

Â  Â  function kohaURL(title){
Â  Â  Â  if (!BOT_CFG.KOHA_OPAC_BASE) return "#";
Â  Â  Â  return `${BOT_CFG.KOHA_OPAC_BASE}/cgi-bin/koha/opac-search.pl?q=${encodeURIComponent(`ti="${title}"`)}`;
Â  Â  }

Â  Â  function render(items){
Â  Â  Â  const list=document.createElement("div");
Â  Â  Â  if(!items.length){ list.innerHTML=`<div class="row">No results found.</div>`; return list; }
Â  Â  Â  for(const {rec} of items){
Â  Â  Â  Â  const r=rec.raw;
Â  Â  Â  Â  const url = r.url && /^https?:\/\//i.test(r.url) ? r.url : kohaURL(r.title||"");
Â  Â  Â  Â  const pub = [r.publisher, r.year].filter(Boolean).join(" â€¢ ");
Â  Â  Â  Â  const div=document.createElement("div"); div.className="row";
Â  Â  Â  Â  div.dir = isArabic(r.title||r.summary||r.content||r.author) ? "rtl" : "ltr";
Â  Â  Â  Â  div.innerHTML=`
Â  Â  Â  Â  Â  <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;">
Â  Â  Â  Â  Â  Â  <b style="font-size:15px;line-height:1.3">${(r.title||"").replace(/</g,"&lt;")}</b>
Â  Â  Â  Â  Â  Â  <a class="btn" href="${url}" target="_blank" rel="noopener">Open record</a>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  ${r.author? `<div class="meta">${isArabic(r.author)?"Ø§Ù„Ù…Ø¤Ù„Ù: ":"Author: "}${r.author}</div>` : ""}
Â  Â  Â  Â  Â  ${pub? `<div class="meta">${pub}</div>` : ""}
Â  Â  Â  Â  Â  ${r.summary? `<div style="margin-top:6px">${r.summary.length>360? r.summary.slice(0,357)+"â€¦" : r.summary}</div>` : ""}
Â  Â  Â  Â  Â  ${r.content? `<div style="margin-top:6px;opacity:.9">${r.content.length>360? r.content.slice(0,357)+"â€¦" : r.content}</div>` : ""}
Â  Â  Â  Â  `;
Â  Â  Â  Â  list.appendChild(div);
Â  Â  Â  }
Â  Â  Â  return list;
Â  Â  }

Â  Â  /* ===== Load ODS, map your columns (EN + AR), index ===== */
Â  Â  let INDEX=[];
Â  Â  fetch(BOT_CFG.DATA_URL,{cache:"reload"})
Â  Â  Â  .then(r => { if(!r.ok) throw new Error("HTTP "+r.status); return r.arrayBuffer(); })
Â  Â  Â  .then(buf => {
Â  Â  Â  Â  const wb = XLSX.read(buf,{type:"array"});
Â  Â  Â  Â  const ws = wb.Sheets["catalog"] || wb.Sheets[wb.SheetNames[0]];
Â  Â  Â  Â  if(!ws) throw new Error("No sheets in ODS");
Â  Â  Â  Â  const raw = XLSX.utils.sheet_to_json(ws,{defval:"",raw:false});

Â  Â  Â  Â  const records = raw.map(row=>{
Â  Â  Â  Â  Â  const k = {};
Â  Â  Â  Â  Â  for (const [h,v] of Object.entries(row)) k[String(h).trim().toLowerCase()] = v;

Â  Â  Â  Â  Â  // Your columns + Arabic variants
Â  Â  Â  Â  Â  const titleÂ  Â = k["full title"] ?? k["Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"] ?? k.title ?? "";
Â  Â  Â  Â  Â  const authorÂ  = k["author"] ?? k["Ø§Ù„Ù…Ø¤Ù„Ù"] ?? k["Ø§Ù„Ù…Ø¤Ù„ÙÙˆÙ†"] ?? "";
Â  Â  Â  Â  Â  const summary = k["abstract"] ?? k["Ø§Ù„Ù…Ù„Ø®Øµ"] ?? "";
Â  Â  Â  Â  Â  const content = k["content"] ?? k["Ø§Ù„Ù…Ø­ØªÙˆÙ‰"] ?? "";
Â  Â  Â  Â  Â  const pubdatÂ  = k["publications data"] ?? k["Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø±"] ?? "";
Â  Â  Â  Â  Â  const urlÂ  Â  Â = k["book_url"] ?? k["book url"] ?? k["Ø±Ø§Ø¨Ø·_Ø§Ù„ÙƒØªØ§Ø¨"] ?? k.url ?? "";

Â  Â  Â  Â  Â  const yearMatch = String(pubdat).match(/(\d{4})/);
Â  Â  Â  Â  Â  const yearÂ  = yearMatch ? yearMatch[1] : "";
Â  Â  Â  Â  Â  const publisher = String(pubdat || "")
Â  Â  Â  Â  Â  Â  .replace(/\b\d{4}\b/g,"")
Â  Â  Â  Â  Â  Â  .replace(/\s*[.,;|-]\s*$/,"")
Â  Â  Â  Â  Â  Â  .trim();

Â  Â  Â  Â  Â  return { title, author, summary, content, publisher, year, url };
Â  Â  Â  Â  });

Â  Â  Â  Â  INDEX = buildIndex(records);
Â  Â  Â  Â  setStatus(`Loaded ${records.length} records`);
Â  Â  Â  Â  const sample = render(records.slice(0,3).map((r,i)=>({rec:{raw:r},sc:1})));
Â  Â  Â  Â  B.appendChild(sample);
Â  Â  Â  })
Â  Â  Â  .catch(err => { console.error(err); setStatus("Chatbot init failed: "+err.message, true); });

Â  Â  // search handlers
Â  Â  GO.onclick = () => {
Â  Â  Â  const q = Q.value.trim(); if(!q) return;
Â  Â  Â  const res = search(INDEX, q, BOT_CFG.MAX_RESULTS);
Â  Â  Â  while (B.children.length > 1) B.removeChild(B.lastChild); // keep status/hint
Â  Â  Â  B.appendChild(render(res));
Â  Â  };
Â  Â  Q.onkeydown = (e) => { if(e.key==="Enter") GO.click(); };
Â  })();
Â  </script>
</body>
</html>
