<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Koha TSV Chatbot â€” Arabic solid</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#F3EFED;padding:2rem}
  .fab{position:fixed;right:18px;bottom:18px;background:#3EA3DC;color:#fff;border:none;border-radius:50%;
       width:56px;height:56px;font-size:24px;cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,.25);z-index:9999;display:block}
  .box{position:fixed;right:18px;bottom:86px;width:min(520px,92vw);max-height:70vh;background:#fff;border-radius:14px;
       border:1px solid #e8eef3;box-shadow:0 16px 40px rgba(0,0,0,.25);display:flex;flex-direction:column;overflow:hidden;z-index:9999}
  .head{background:#BF9849;color:#fff;padding:10px 14px;font-weight:600;display:flex;justify-content:space-between;align-items:center}
  .body{padding:10px;overflow:auto;max-height:56vh;font-size:14px}
  .row{background:#f6f9fc;border:1px solid #e7edf4;border-radius:12px;padding:12px;margin:10px 0}
  .meta{opacity:.85;font-size:12px;margin-top:6px}
  .input{display:flex;gap:8px;padding:10px;background:#fafafa;border-top:1px solid #e8eef3}
  .input input{flex:1;padding:10px;border-radius:10px;border:1px solid #cfd9e3}
  .input button{background:#3EA3DC;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:600}
  .error{background:#fff0f0;border:1px solid #f5b5b5;color:#900;padding:10px}
  .btn{flex:0 0 auto;background:#3EA3DC;color:#fff;padding:6px 10px;border-radius:8px;text-decoration:none;font-weight:600}
  .muted{opacity:.7}
</style>
</head>
<body>
  <h2>Koha TSV Chatbot</h2>
  <p class="muted">Loads a Koha <code>.tab</code> (TSV) export and searches Arabic + English.</p>

<script>
/* ===== visible crash reporter ===== */
window.addEventListener("error", e => showBannerError("JS error: " + (e.message||e)));
window.addEventListener("unhandledrejection", e => showBannerError("Promise error: " + (e.reason?.message||e.reason)));
function showBannerError(msg){
  let el=document.getElementById("top-error");
  if(!el){ el=document.createElement("div"); el.id="top-error"; el.className="error"; document.body.prepend(el); }
  el.textContent = String(msg||"Unknown error");
}

/* ===== UI ===== */
const fab = document.createElement("button"); fab.className="fab"; fab.textContent="ğŸ’¬";
const box = document.createElement("div"); box.className="box";
box.innerHTML = ''+
  '<div class="head"><div>Catalog Assistant</div>'+
  '<button id="x" style="background:none;border:none;color:#fff;font-size:18px;cursor:pointer" title="Close">Ã—</button></div>'+
  '<div class="body" id="body">'+
    '<div class="row" id="status">Loading catalogâ€¦</div>'+
    '<div class="row">Type title, author, year â€” Ø£Ùˆ Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø§Øª Ø¹Ø±Ø¨ÙŠØ© Ù…Ù† Ø§Ù„Ø¹Ù†ÙˆØ§Ù†/Ø§Ù„Ù…Ù„Ø®Øµ/Ø§Ù„Ù…Ø­ØªÙˆÙ‰. ÙÙ„Ø§ØªØ±: author:"name"  year:2021</div>'+
  '</div>'+
  '<div class="input"><input id="q" type="text" placeholder="Search / Ø§Ø¨Ø­Ø«" dir="auto"><button id="go">Search</button></div>';
document.body.appendChild(fab); document.body.appendChild(box);
const B=box.querySelector("#body"), Q=box.querySelector("#q"), GO=box.querySelector("#go"), closeBtn=box.querySelector("#x");
box.style.display="flex"; fab.style.display="block"; Q.focus();
fab.onclick=()=>{ box.style.display = (box.style.display==="flex"?"none":"flex"); };
closeBtn.onclick=()=>{ box.style.display="none"; };
function setStatus(msg, err){ let el=document.getElementById("status"); if(!el){el=document.createElement("div"); el.id="status"; el.className="row"; B.prepend(el);}
  el.className = err? "row error":"row"; el.textContent = msg; if(err) showBannerError(msg); }

/* ===== Arabic helpers ===== */
const AR_ANY=/[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]/;
function isArabic(s){ return AR_ANY.test(String(s||"")); }
function normalizeArabicForms(str){
  if(!str) return "";
  const map={'ïº':'Ø§','ïº':'Ø§','ïºƒ':'Ø§','ïº„':'Ø§','ïº‡':'Ø§','ïºˆ':'Ø§','Ù±':'Ø§','ïº':'Ø¨','ïº':'Ø¨','ïº‘':'Ø¨','ïº’':'Ø¨','ïº•':'Øª','ïº–':'Øª','ïº—':'Øª','ïº˜':'Øª','ïº™':'Ø«','ïºš':'Ø«','ïº›':'Ø«','ïºœ':'Ø«',
    'ïº':'Ø¬','ïº':'Ø¬','ïºŸ':'Ø¬','ïº ':'Ø¬','ïº¡':'Ø­','ïº¢':'Ø­','ïº£':'Ø­','ïº¤':'Ø­','ïº¥':'Ø®','ïº¦':'Ø®','ïº§':'Ø®','ïº¨':'Ø®','ïº©':'Ø¯','ïºª':'Ø¯','ïº«':'Ø°','ïº¬':'Ø°','ïº­':'Ø±','ïº®':'Ø±','ïº¯':'Ø²','ïº°':'Ø²',
    'ïº±':'Ø³','ïº²':'Ø³','ïº³':'Ø³','ïº´':'Ø³','ïºµ':'Ø´','ïº¶':'Ø´','ïº·':'Ø´','ïº¸':'Ø´','ïº¹':'Øµ','ïºº':'Øµ','ïº»':'Øµ','ïº¼':'Øµ','ïº½':'Ø¶','ïº¾':'Ø¶','ïº¿':'Ø¶','ï»€':'Ø¶','ï»':'Ø·','ï»‚':'Ø·','ï»ƒ':'Ø·','ï»„':'Ø·',
    'ï»…':'Ø¸','ï»†':'Ø¸','ï»‡':'Ø¸','ï»ˆ':'Ø¸','ï»‰':'Ø¹','ï»Š':'Ø¹','ï»‹':'Ø¹','ï»Œ':'Ø¹','ï»':'Øº','ï»':'Øº','ï»':'Øº','ï»':'Øº','ï»‘':'Ù','ï»’':'Ù','ï»“':'Ù','ï»”':'Ù','ï»•':'Ù‚','ï»–':'Ù‚','ï»—':'Ù‚','ï»˜':'Ù‚',
    'ï»™':'Ùƒ','ï»š':'Ùƒ','ï»›':'Ùƒ','ï»œ':'Ùƒ','ï»':'Ù„','ï»':'Ù„','ï»Ÿ':'Ù„','ï» ':'Ù„','ï»¡':'Ù…','ï»¢':'Ù…','ï»£':'Ù…','ï»¤':'Ù…','ï»¥':'Ù†','ï»¦':'Ù†','ï»§':'Ù†','ï»¨':'Ù†','ï»©':'Ù‡','ï»ª':'Ù‡','ï»«':'Ù‡','ï»¬':'Ù‡',
    'ï»­':'Ùˆ','ï»®':'Ùˆ','ï»±':'ÙŠ','ï»²':'ÙŠ','ï»³':'ÙŠ','ï»´':'ÙŠ','ï»°':'Ù‰','ï»»':'Ù„Ø§','ï»¼':'Ù„Ø§'};
  return str.replace(/[\uFE70-\uFEFF\uFB50-\uFDFF]/g, ch=>map[ch]||ch);
}
function stripLatinDiacritics(s){ return s.replace(/[\u0300-\u036f]/g,""); }
function foldDigits(s){ return s.replace(/[\u0660-\u0669]/g,d=>d.charCodeAt(0)-0x0660).replace(/[\u06F0-\u06F9]/g,d=>d.charCodeAt(0)-0x06F0); }
function norm(s){
  if(!s) return "";
  let t=String(s).toLowerCase();
  try{t=t.normalize("NFKD");}catch(e){}
  t=stripLatinDiacritics(t);
  t=normalizeArabicForms(t);
  t=foldDigits(t);
  return t
    .replace(/[\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06ED\u0640]/g,"")   // tashkÄ«l + tatweel
    .replace(/[\u061C\u200B-\u200F\u202A-\u202E\u2066-\u2069\u00A0\u202F]/g,"") // bidi/zero-width
    .replace(/[Ø¥Ø£Ø¢Ù±]/g,"Ø§").replace(/[Ù‰ÛŒ]/g,"ÙŠ").replace(/Ú©/g,"Ùƒ");
}
const AR_LETTER_ONLY=/[Ø¡-ÙŠ]/g;
function arLettersOnly(s){ const n=norm(s).replace(/Ø©/g,"Ù‡").replace(/Ù‰/g,"ÙŠ"); let out="",m; while((m=AR_LETTER_ONLY.exec(n))!==null) out+=m[0]; return out; }
function subseq(hay,needle){ if(!needle) return false; let i=0,j=0; while(i<hay.length&&j<needle.length){ if(hay.charCodeAt(i)===needle.charCodeAt(j)) j++; i++; } return j===needle.length; }

/* ===== CONFIG ===== */
const BOT_CFG = {
  // Put your .tab here (same-origin avoids 403/CORS issues)
  DATA_URL: "/koha-csv/opac-catalog.tab",
  MAX_RESULTS: 12,
  MIN_QUERY_LEN: 1,
  KOHA_OPAC_BASE: location.origin
};

/* ===== TSV (.tab) loader ===== */
function parseTSV(text){
  // Handle CRLF / LF, keep empty cells, strip hidden control marks in cells
  const CONTROL=/[\u061C\u200B-\u200F\u202A-\u202E\u2066-\u2069\u00A0\u202F]/g;
  const lines = text.replace(/\r\n?/g,"\n").split("\n").filter(l=>l.length>0);
  if(!lines.length) return [];
  const headers = lines[0].split("\t").map(h=>String(h).trim().toLowerCase());
  const rows=[];
  for(let i=1;i<lines.length;i++){
    const cols = lines[i].split("\t");
    const obj={};
    for(let c=0;c<headers.length;c++){
      obj[headers[c]] = (cols[c]==null? "": String(cols[c])).replace(CONTROL,"");
    }
    rows.push(obj);
  }
  return rows;
}

/* ===== Field mapping (EN/AR header variants) ===== */
function mapRecord(k){
  const title   = k["full title"]||k["Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"]||k.title||k["ti"]||"";
  const author  = k["author"]||k["Ø§Ù„Ù…Ø¤Ù„Ù"]||k["Ø§Ù„Ù…Ø¤Ù„ÙÙˆÙ†"]||k["au"]||"";
  const summary = k["abstract"]||k["Ø§Ù„Ù…Ù„Ø®Øµ"]||k["summary"]||"";
  const content = k["content"]||k["Ø§Ù„Ù…Ø­ØªÙˆÙ‰"]||"";
  const pubdat  = k["publications data"]||k["Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø±"]||k["pub"]||"";
  const url     = k["book_url"]||k["book url"]||k["Ø±Ø§Ø¨Ø·_Ø§Ù„ÙƒØªØ§Ø¨"]||k["url"]||"";
  const ym = String(pubdat).match(/(\d{4})/);
  const year = ym? ym[1] : "";
  const publisher = String(pubdat||"").replace(/\b\d{4}\b/g,"").replace(/\s*[.,;|-]\s*$/,"").trim();
  return {title,author,summary,content,publisher,year,url};
}

/* ===== Render ===== */
function kohaURL(title){
  if(!BOT_CFG.KOHA_OPAC_BASE) return "#";
  return BOT_CFG.KOHA_OPAC_BASE + "/cgi-bin/koha/opac-search.pl?q=" + encodeURIComponent('ti="'+title+'"');
}
function render(items){
  const list=document.createElement("div");
  if(!items.length){ list.innerHTML='<div class="row">No results found.</div>'; return list; }
  for(const it of items){
    const r=it.raw;
    const url = (r.url && /^https?:\/\//i.test(r.url)) ? r.url : kohaURL(r.title||"");
    const pub = [r.publisher, r.year].filter(Boolean).join(" â€¢ ");
    const div=document.createElement("div"); div.className="row";
    div.dir = isArabic((r.title||"")+(r.summary||"")+(r.content||"")+(r.author||"")) ? "rtl" : "ltr";
    div.innerHTML =
      '<div style="display:flex;justify-content:space-between;gap:8px;align-items:center;">' +
        '<b style="font-size:15px;line-height:1.3">'+ String(r.title||"").replace(/</g,"&lt;") +'</b>' +
        '<a class="btn" href="'+url+'" target="_blank" rel="noopener">Open record</a>' +
      '</div>' +
      (r.author? '<div class="meta">'+(isArabic(r.author)?'Ø§Ù„Ù…Ø¤Ù„Ù: ':'Author: ')+r.author+'</div>' : '') +
      (pub? '<div class="meta">'+pub+'</div>' : '') +
      (r.summary? '<div style="margin-top:6px">'+ (r.summary.length>360? r.summary.slice(0,357)+'â€¦' : r.summary) +'</div>' : '') +
      (r.content? '<div style="margin-top:6px;opacity:.9">'+ (r.content.length>360? r.content.slice(0,357)+'â€¦' : r.content) +'</div>' : '');
    list.appendChild(div);
  }
  return list;
}

/* ===== Search (same Arabic-smart pipeline) ===== */
function parseFilters(q){
  const aMatch=q.match(/author:\s*"([^"]+)"/i)||q.match(/author:\s*([^\s]+)/i);
  const yMatch=q.match(/year:\s*(\d{4})/i);
  const a=aMatch? aMatch[1]:""; const y=yMatch? yMatch[1]:"";
  const cleaned=q.replace(/author:\s*".*?"/ig,"").replace(/author:\s*[^\s]+/ig,"").replace(/year:\s*\d{4}/ig,"").trim();
  return {author:a, year:y, cleaned};
}
function search(idx,q,limit){
  q=(q||"").trim(); if(q.length < BOT_CFG.MIN_QUERY_LEN) return [];
  const F=parseFilters(q);
  const terms=F.cleaned.split(/\s+/).filter(Boolean);
  const nTerms=terms.map(norm);
  const aQuery=arLettersOnly(F.cleaned);

  // Stage 1: ranked on normalized fields
  const out=[];
  for(const rec of idx){
    if(F.author && norm(rec.raw.author).indexOf(norm(F.author))===-1) continue;
    if(F.year && String(rec.raw.year||"")!==String(F.year)) continue;
    let sc=0, matched=false;
    for(const qt of nTerms){
      if(!qt) continue;
      if(rec.nTitle.indexOf(qt)!==-1){sc+=5; matched=true;}
      if(rec.nSummary.indexOf(qt)!==-1){sc+=2; matched=true;}
      if(rec.nContent.indexOf(qt)!==-1){sc+=2; matched=true;}
    }
    const yTerm=q.match(/\b(\d{4})\b/);
    if(yTerm && String(rec.raw.year)===yTerm[1]){sc+=6; matched=true;}
    if(matched) out.push({sc, raw:rec.raw});
  }
  out.sort((a,b)=>b.sc-a.sc);
  if(out.length) return out.slice(0,limit||BOT_CFG.MAX_RESULTS);

  // Stage 2: Arabic letters-only (contiguous or subsequence)
  if(aQuery){
    const hits=[];
    for(const r of idx){
      if(F.author && norm(r.raw.author).indexOf(norm(F.author))===-1) continue;
      if(F.year && String(r.raw.year||"")!==String(F.year)) continue;
      const aAll=r.aAll; if(!aAll) continue;
      if(aAll.indexOf(aQuery)!==-1 || subseq(aAll,aQuery) || subseq(aAll,aQuery.replace(/Ù‡/g,"Ø©")) || subseq(aAll,aQuery.replace(/ÙŠ/g,"Ù‰"))){
        hits.push({sc:0.7, raw:r.raw});
      }
    }
    if(hits.length) return hits.slice(0,limit||BOT_CFG.MAX_RESULTS);
  }

  // Stage 3: simple fallback regex (letters with anything between)
  const letters = (norm(F.cleaned).replace(/\s+/g,"").match(/[Ø¡-ÙŠ]/g))||[];
  if(letters.length){
    const pattern = letters.join("[\\s\\S]{0,40}?");
    const re = new RegExp(pattern,"u");
    const hits=[];
    for(const r of idx){
      const hay = normalizeArabicForms(r.rawAll||"");
      if(re.test(hay)) hits.push({sc:0.6, raw:r.raw});
    }
    if(hits.length) return hits.slice(0,limit||BOT_CFG.MAX_RESULTS);
  }
  return [];
}

/* ===== Load TSV and build index ===== */
let INDEX=[];
fetch(BOT_CFG.DATA_URL, {cache:"reload"})
  .then(r=>{ if(!r.ok) throw new Error("HTTP "+r.status); return r.text(); })
  .then(text=>{
    const rows = parseTSV(text);
    if(!rows.length) throw new Error("Empty .tab file");
    const records = rows.map(mapRecord);

    INDEX = records.map((r,i)=>{
      const rawAll=(r.title+" "+r.author+" "+r.summary+" "+r.content+" "+r.publisher+" "+r.year).trim();
      return {
        id:i, raw:r,
        rawAll,
        nTitle:norm(r.title), nSummary:norm(r.summary), nContent:norm(r.content),
        aAll:arLettersOnly(rawAll)
      };
    });

    const arabicCount = records.filter(r => AR_ANY.test((r.title||"")+(r.author||"")+(r.summary||"")+(r.content||""))).length;
    setStatus("Loaded "+records.length+" records (Arabic rows: "+arabicCount+")");

    const sample = render(records.slice(0,3).map(r=>({raw:r,sc:1})));
    B.appendChild(sample);
  })
  .catch(err=>{
    console.error(err);
    setStatus("Chatbot init failed: "+(err?.message||err), true);
  });

GO.onclick = function(){
  const q = Q.value.trim(); if(!q) return;
  const res = search(INDEX, q, BOT_CFG.MAX_RESULTS);
  while (B.children.length > 1) B.removeChild(B.lastChild);
  B.appendChild(render(res));
};
Q.onkeydown = e => { if(e.key==="Enter") GO.click(); };
</script>
</body>
</html>
