<!DOCTYPE html>
<html lang="ar" dir="auto">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ECSSR AI Assistant</title>
<style>
:root{--brand:#BF9849;--logo-url:url("https://assets.almanhal.com/platform/shared/Product/ECSSR/middlelogo.png");--fab-size:70px}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#F3EFED;margin:0;padding:2rem}
.fab-wrap{position:fixed;right:18px;bottom:18px;z-index:9999;width:var(--fab-size);height:calc(var(--fab-size)+36px)}
.fab-label{position:absolute;left:50%;bottom:calc(var(--fab-size)+4px);transform:translateX(-50%);width:calc(var(--fab-size)+36px);height:34px;pointer-events:none;filter:drop-shadow(0 1px 0 rgba(255,255,255,.65))}
.fab-label text{fill:var(--brand);font-weight:700;font-size:12px;letter-spacing:.5px}
.fab{position:absolute;left:0;bottom:0;width:var(--fab-size);height:var(--fab-size);background:#fff var(--logo-url) center/145% no-repeat;border:5px solid #BF9849;border-radius:50%;cursor:pointer;box-shadow:0 10px 30px rgba(191,152,73,0.4);transition:transform 0.3s ease, box-shadow 0.3s ease}
.fab:hover{transform:scale(1.08);box-shadow:0 15px 40px rgba(191,152,73,0.6)}
.slide-banner{position:fixed;right:calc(var(--fab-size) + 30px);bottom:calc(18px + (var(--fab-size) / 2) - 22px);background:linear-gradient(135deg,#BF9849,#D4AB5E);color:#fff;padding:14px 28px;border-radius:30px;font-weight:700;font-size:15px;box-shadow:0 8px 24px rgba(191,152,73,0.5);white-space:nowrap;z-index:9998;animation:slideFromBottom 7s ease-in-out forwards;opacity:0;letter-spacing:0.3px}
@keyframes slideFromBottom{0%{transform:translateY(200px);opacity:0}15%{transform:translateY(0);opacity:1}85%{transform:translateY(0);opacity:1}100%{transform:translateY(200px);opacity:0}}
.box{position:fixed;right:18px;bottom:calc(18px + var(--fab-size) + 12px);width:min(620px,94vw);max-height:85vh;background:#fff;border-radius:14px;box-shadow:0 16px 40px rgba(0,0,0,.25);display:none;flex-direction:column;overflow:hidden;z-index:9999}
.head{background:linear-gradient(135deg,#BF9849,#D4AB5E);color:#fff;padding:12px 16px;font-weight:600;display:flex;justify-content:space-between;align-items:center}
.close{background:none;border:none;color:#fff;font-size:20px;cursor:pointer}
.status{font-size:12px;padding:8px 12px;background:#fafafa;border-bottom:1px solid #e8eef3}
.body{padding:10px;overflow:auto;flex:1}
.row{background:#f6f9fc;border:1px solid #e7edf4;border-radius:12px;padding:12px;margin:10px 0;position:relative}
.row:hover{box-shadow:0 4px 12px rgba(0,0,0,0.08);border-color:#BF9849}
.meta{opacity:.85;font-size:12px;margin-top:6px}
.translate-icon{position:absolute;top:12px;left:12px;background:#fff;border:1px solid #e0e0e0;border-radius:6px;padding:4px 8px;font-size:11px;cursor:pointer;transition:all 0.2s;z-index:10}
.translate-icon:hover{background:#BF9849;color:#fff;border-color:#BF9849}
.translated{background:#e8f4f8;padding:8px;margin-top:8px;border-radius:6px;font-size:13px;border-left:3px solid #BF9849}
.ai-summary{background:linear-gradient(135deg,#e8f4f8,#f0f8ff);border-left:4px solid #BF9849;padding:12px;margin:10px 0;border-radius:8px;font-size:13px;line-height:1.6}
.ai-summary::before{content:"🤖 ";margin-right:4px}

/* NEW: citations styling */
.cites{margin-top:10px;border-top:1px dashed #d9d9d9;padding-top:8px}
.cites h4{margin:6px 0 8px 0;font-size:13px;color:#444}
.cite-list{display:flex;flex-wrap:wrap;gap:8px}
.cite{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;font-size:12px;box-shadow:0 1px 3px rgba(0,0,0,.04);display:flex;align-items:center;gap:8px}
.cite b{font-weight:700;margin-inline-end:6px}
.cite a{background:#BF9849;color:#fff;text-decoration:none;border-radius:8px;padding:4px 8px;font-weight:600}
.cite a[disabled], .cite a[aria-disabled="true"]{opacity:.5;pointer-events:none}

.input-wrap{padding:10px;background:#fafafa;border-top:1px solid #e8eef3}
.input{display:flex;gap:8px}
.input input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #cfd9e3}
.input button{background:#BF9849;color:#fff;border:none;border-radius:10px;padding:10px 16px;font-weight:600;cursor:pointer}
.input button:disabled{opacity:.5}
.btn{background:#BF9849;color:#fff;padding:6px 12px;border-radius:8px;text-decoration:none;font-weight:600;font-size:12px;display:inline-block;white-space:nowrap}
.btn:hover{background:#D4AB5E}
.btn[disabled]{opacity:.5;cursor:not-allowed}
.info{background:#e8f4f8;border-left:4px solid #BF9849;padding:10px;margin:10px 0;border-radius:8px;font-size:13px}
.more-row{display:flex;justify-content:center;margin-top:10px}
.more-row button{background:#BF9849;color:#fff;border:none;border-radius:10px;padding:8px 14px;font-weight:700;cursor:pointer}
.busybar{display:none;align-items:center;gap:10px;padding:8px 12px;background:#fff;border-bottom:1px solid #e8eef3}
.box.busy .busybar{display:flex}
.spinner{width:32px;height:32px;border-radius:50%;background:#fff var(--logo-url) center/90% no-repeat;border:3px solid rgba(0,0,0,.06);box-shadow:0 2px 8px rgba(0,0,0,.12);animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.busytext{font-weight:600;color:#555}
</style>
</head>
<body>
<div class="slide-banner" id="slideBanner">UAE Federation Library AI Assistant</div>
<div class="fab-wrap">
  <svg class="fab-label" viewBox="0 0 120 40"><defs><path id="arc" d="M 10,34 A 50,50 0 0 1 110,34"/></defs><text text-anchor="middle"><textPath href="#arc" startOffset="50%">AI Assist</textPath></text></svg>
  <button class="fab" id="fab"></button>
</div>

<div class="box" id="box">
  <div class="head"><div>ECSSR AI Search</div><button class="close" id="close">×</button></div>
  <div class="busybar" id="busybar"><div class="spinner"></div><div class="busytext" id="busytext">Loading...</div></div>
  <div class="status" id="status">Ready</div>
  <div class="body" id="body"></div>
  <div class="input-wrap"><div class="input"><input id="q" type="text" placeholder="اكتب: اسم مؤلف / عنوان / موضوع / سنة" dir="auto"><button id="go">Search</button></div></div>
</div>

<script>
/* ------------------- Config ------------------- */
const DATA_URL="./opac-catalog.tab?delim=tab";
const PAGE_SIZE=12;
const BACKEND_URL="https://ecssr-ai-assistant.onrender.com/api";

/* ------------------- State ------------------- */
let INDEX=[],HEADERS=[],LOADED=false,MATCH_NOTE="",LAST={items:[],shown:0,field:""};

/* ------------------- UI Hooks ------------------- */
const fab=document.getElementById("fab"),box=document.getElementById("box"),close=document.getElementById("close"),body=document.getElementById("body"),status=document.getElementById("status"),q=document.getElementById("q"),go=document.getElementById("go");
setTimeout(()=>{const b=document.getElementById("slideBanner");if(b)b.remove()},7500);
fab.onclick=()=>{box.style.display=(box.style.display==="flex")?"none":"flex";if(box.style.display==="flex"){if(!LOADED){setBusy(true,"Initializing…");ensureLoaded().then(()=>setBusy(false))}setTimeout(()=>q.focus(),50)}};
close.onclick=()=>box.style.display="none";

/* ------------------- Utils ------------------- */
function setBusy(on,label){const bar=document.getElementById("busybar"),txt=document.getElementById("busytext");if(label)txt.textContent=label;if(on){box.classList.add("busy");go.disabled=true;q.disabled=true}else{box.classList.remove("busy");go.disabled=false;q.disabled=false}}
function stripBidi(s){return String(s||"").replace(/[\u200E\u200F\u202A-\u202E]/g,"")}
function clean(s){return stripBidi(String(s||"").replace(/^\uFEFF/,""))}
function canonHeader(h){return clean(h).toLowerCase().replace(/\s+/g," ").trim()}
function norm(s){
  if(!s)return "";
  s=clean(s).toLowerCase();
  try{s=s.normalize("NFKD")}catch(e){}
  s=s.replace(/[إأآٱ]/g,"ا").replace(/\s*و\s*/g,"و").replace(/[ىی]/g,"ي").replace(/ة/g,"ه").replace(/ک/g,"ك").replace(/\bعبد\s+ال/g,"عبدال")
     .replace(/[\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06ED\u0640]/g,"")
     .replace(/[\u0660-\u0669]/g,d=>String.fromCharCode(d.charCodeAt(0)-1632+48))
     .replace(/[\u06F0-\u06F9]/g,d=>String.fromCharCode(d.charCodeAt(0)-1776+48))
     .replace(/[^\p{L}\p{N}\s]/gu," ").replace(/\s+/g," ").trim();
  return s
}
function isArabic(s){return/[\u0600-\u06FF]/.test(s||"")}
function looksLikeYear(q){return/^\d{4}$/.test(q.trim())}
function chooseField(q){
  const raw=q.trim();
  if(/(ناشر|publisher|دار نشر|دار النشر|publishing house|press books)/i.test(raw)){MATCH_NOTE="Publisher keyword → Publisher field";return "pub"}
  if(looksLikeYear(raw))return "year";
  if(/^(what|how|why|when|where|who|which|ما|كيف|لماذا|متى|أين|من|ماذا|كيفية|هل)\b/i.test(raw)){MATCH_NOTE="Question → Summary";return "summary"}
  // (keep the rest of your heuristics as-is)
  MATCH_NOTE="Default → Subject";return "subject";
}

/* ------------------- Load OPAC ------------------- */
async function ensureLoaded(){
  if(LOADED)return;
  try{
    setBusy(true,"Loading records…");
    const resp=await fetch(DATA_URL,{cache:"reload"});
    if(!resp.ok)throw new Error(`Fetch ${resp.status}`);
    const text=await resp.text();
    const lines=text.split(/\r?\n/);
    if(lines.length<2)throw new Error("Empty catalog");
    HEADERS=lines[0].split("\t").map(canonHeader);
    for(let i=1;i<lines.length;i++){
      const cols=lines[i].split("\t");
      if(cols.length<2||(cols.length===1&&!cols[0]))continue;
      const rec={};
      HEADERS.forEach((h,idx)=>{rec[h]=clean(cols[idx]||"")});

      const title=rec["full title"]||rec["title"]||rec["العنوان"]||"";
      const author=rec["author"]||rec["المؤلف"]||"";
      const otherAu=rec["other author"]||rec["المؤلف الآخر"]||"";
      const corporate=rec["corporate name"]||rec["جهة مؤسسية"]||"";
      const subject=rec["subjects"]||rec["subject"]||rec["الموضوعات"]||"";
      const summary=rec["abstract"]||rec["summary"]||rec["الملخص"]||"";
      const content=rec["content"]||rec["contents"]||rec["المحتويات"]||"";
      const pubData=rec["publications data"]||rec["بيانات النشر"]||"";
      const bookUrl=rec["book_url"]||rec["book url"]||rec["رابط الكتاب"]||"";
      const year=rec["year"]||rec["السنة"]||(pubData.match(/(19|20)\d{2}/)||[""])[0];
      const publisher=pubData.replace(/\b(19|20)\d{2}\b/g,"").trim();
      const authorAll=[author,otherAu,corporate].filter(Boolean).join(" ");

      INDEX.push({
        id:INDEX.length,
        raw:{title,author,other_author:otherAu,corporate_name:corporate,subject,summary,content,publisher,year,book_url:bookUrl},
        nTitle:norm(title),
        nAuthor:norm(author),
        nOtherAuthor:norm(otherAu),
        nCorporate:norm(corporate),
        nAuthorAll:norm(authorAll),
        nSummary:norm(summary),
        nContent:norm(content),
        nSubject:norm(subject),
        nPub:norm(publisher+" "+corporate),
        nYear:norm(year)
      })
    }
    LOADED=true;
    status.textContent=`✅ Loaded ${INDEX.length} records`;
  }catch(e){
    status.textContent=`❌ Error: ${e.message}`;
  }finally{
    setBusy(false)
  }
}

/* ------------------- Author matching (your rules) ------------------- */
const NAME_STOP = new Set(["بن","بنت","ابن","أبن","آل","ال","أبو","ابو","بو","بنّ","عبد","عبدال"]);
const COMMON_GIVEN = new Set(["محمد","احمد","أحمد","علي","حسن","حسين","خالد","سعيد","سالم","يوسف","عبدالله","عبد الله","عبدالرحمن","عبد الرحمن","عبدالعزيز","عبد العزيز","عبدال","عبد","محمود","ابراهيم","إبراهيم","عمر","سامي","نادر","ماجد"]);
function tokenizeName(n){ return (n||"").split(/\s+/).filter(t=>t.length>=2) }
function tokenEq(a,b){ if(a===b) return true; if(a.length>=3 && b.startsWith(a)) return true; if(b.length>=3 && a.startsWith(b)) return true; return false; }
function extractSurname(tokens){ for(let i=tokens.length-1;i>=0;i--){const t=tokens[i]; if(!NAME_STOP.has(t)) return t;} return tokens[tokens.length-1]||null; }
function exactAuthorMatch(qTokens,name){
  const aTokens=tokenizeName(name);
  if(qTokens.length!==aTokens.length) return false;
  return qTokens.every(qt=>aTokens.some(at=>tokenEq(qt,at))) &&
         aTokens.every(at=>qTokens.some(qt=>tokenEq(qt,at)));
}
function flexibleAuthorMatch(qTokens,name){
  const aTokens=tokenizeName(name);
  if(aTokens.length===0||qTokens.length===0) return {hit:false,score:0};
  const anchor=extractSurname(qTokens);
  const hasAnchor=anchor?aTokens.some(at=>tokenEq(anchor,at)):false;
  if(anchor && !hasAnchor) return {hit:false,score:0};
  const qNonCommon=qTokens.filter(t=>t!==anchor && !COMMON_GIVEN.has(t) && !NAME_STOP.has(t));
  if(qNonCommon.length>0){
    const hasDistinct=qNonCommon.some(t=>aTokens.some(at=>tokenEq(t,at)));
    if(!hasDistinct) return {hit:false,score:0};
  }
  let overlap=0; const used=new Array(aTokens.length).fill(false);
  for(const qt of qTokens){ const i=aTokens.findIndex((at,idx)=>!used[idx]&&tokenEq(qt,at)); if(i>=0){used[i]=true;overlap++;} }
  const minLen=Math.min(qTokens.length,aTokens.length);
  // tighten for >=3 tokens (need 3)
  const need=(qTokens.length>=3)?3:Math.max(2,Math.ceil(minLen*0.66));
  if(overlap>=need){
    const closeness=1-Math.abs(qTokens.length-aTokens.length)/5;
    const anchorBonus=hasAnchor?8:0;
    const distinctBonus=(qNonCommon.length>0)?5:0;
    return {hit:true,score:70+overlap*10+closeness*5+anchorBonus+distinctBonus};
  }
  return {hit:false,score:0};
}

/* ------------------- Search core ------------------- */
function searchField(field,q){
  const nq=norm(q);
  const tokens=nq.split(/\s+/).filter(t=>t.length>=2);
  const out=[]; MATCH_NOTE="";

  // exact 2-token preference
  let exactTwoTokenExists=false;
  if(field==="author" && tokens.length===2){
    for(const r of INDEX){
      const a2 = tokenizeName(r.nAuthor).length===2 && exactAuthorMatch(tokens,r.nAuthor);
      const o2 = tokenizeName(r.nOtherAuthor).length===2 && exactAuthorMatch(tokens,r.nOtherAuthor);
      const c2 = tokenizeName(r.nCorporate).length===2 && exactAuthorMatch(tokens,r.nCorporate);
      if(a2||o2||c2){ exactTwoTokenExists=true; break; }
    }
  }

  // exact same-length preference for >=3 tokens
  let exactSameLenExists=false;
  if(field==="author" && tokens.length>=3){
    for(const r of INDEX){
      const aSL = tokenizeName(r.nAuthor).length===tokens.length && exactAuthorMatch(tokens,r.nAuthor);
      const oSL = tokenizeName(r.nOtherAuthor).length===tokens.length && exactAuthorMatch(tokens,r.nOtherAuthor);
      const cSL = tokenizeName(r.nCorporate).length===tokens.length && exactAuthorMatch(tokens,r.nCorporate);
      if(aSL||oSL||cSL){ exactSameLenExists=true; break; }
    }
  }

  for(const r of INDEX){
    let hit=false,sc=0;

    if(field==="author"){
      const aExact = exactAuthorMatch(tokens,r.nAuthor);
      const oExact = exactAuthorMatch(tokens,r.nOtherAuthor);
      const cExact = exactAuthorMatch(tokens,r.nCorporate);

      if(tokens.length>=3 && exactSameLenExists){
        if(aExact && tokenizeName(r.nAuthor).length===tokens.length){ sc=130; hit=true; }
        else if(oExact && tokenizeName(r.nOtherAuthor).length===tokens.length){ sc=122; hit=true; }
        else if(cExact && tokenizeName(r.nCorporate).length===tokens.length){ sc=115; hit=true; }
      } else if(tokens.length===2 && exactTwoTokenExists){
        if(aExact && tokenizeName(r.nAuthor).length===2){ sc=125; hit=true; }
        else if(oExact && tokenizeName(r.nOtherAuthor).length===2){ sc=118; hit=true; }
        else if(cExact && tokenizeName(r.nCorporate).length===2){ sc=112; hit=true; }
      } else {
        if      (aExact){ sc=120; hit=true; }
        else if (oExact){ sc=112; hit=true; }
        else if (cExact){ sc=105; hit=true; }
        else{
          const main=flexibleAuthorMatch(tokens,r.nAuthor);
          const other=flexibleAuthorMatch(tokens,r.nOtherAuthor);
          const corp=flexibleAuthorMatch(tokens,r.nCorporate);
          const best=[main,other,corp].reduce((a,b)=>a.score>b.score?a:b,{hit:false,score:0});
          if(best.hit){ sc=best.score; hit=true; }
        }
      }

      if(hit) MATCH_NOTE = (tokens.length===2 && exactTwoTokenExists)
        ? "Author: exact 2-token match preferred"
        : (tokens.length>=3 && exactSameLenExists)
          ? "Author: exact same-length match preferred"
          : "Author: surname anchor + distinct token";

    } else if(field==="title"){
      const matchCount = tokens.filter(tok=>r.nTitle.includes(tok)).length;
      if(matchCount === tokens.length){sc=90+matchCount*5;hit=true}
      else if(matchCount>0 && matchCount>=tokens.length*0.5){sc=40+matchCount*5;hit=true}

    } else if(field==="subject"){
      if(r.nSubject.includes(nq)){sc=100;hit=true}
      else if(r.nTitle.includes(nq)){sc=90;hit=true}
      else {
        const sm=tokens.filter(tok=>r.nSubject.includes(tok)).length;
        const tm=tokens.filter(tok=>r.nTitle.includes(tok)).length;
        const total=Math.max(sm,tm);
        if(total>=tokens.length*0.5){sc=30+total*8;hit=true}
      }

    } else if(field==="summary"){
      if(r.nSummary.includes(nq)){sc=90;hit=true}
      else if(r.nContent.includes(nq)){sc=80;hit=true}
      else {
        const sm=tokens.filter(tok=>r.nSummary.includes(tok)).length;
        const cm=tokens.filter(tok=>r.nContent.includes(tok)).length;
        const total=Math.max(sm,cm);
        if(total>=tokens.length*0.4){sc=20+total*10;hit=true}
      }

    } else if(field==="year"){
      if(r.nYear.includes(nq)){sc=60;hit=true}

    } else if(field==="pub"){
      if(r.nPub.includes(nq)){sc=100;hit=true}
      else {
        const m=tokens.filter(tok=>r.nPub.includes(tok)).length;
        if(m>=tokens.length*0.6){sc=40+m*10;hit=true}
      }
    }

    if(hit) out.push({sc,...r})
  }

  out.sort((a,b)=>b.sc-a.sc);
  return out
}

/* ------------------- Translate + AI ------------------- */
async function translateText(text,targetLang){try{const sourceLang=isArabic(text)?"ar":"en";if(sourceLang===targetLang)return text;const url=`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${sourceLang}|${targetLang}`,response=await fetch(url),data=await response.json();if(data.responseData&&data.responseData.translatedText)return data.responseData.translatedText;throw new Error("Translation failed")}catch(error){console.error("Translation error:",error);return null}}
async function translateRecord(recordId,field,button){const book=INDEX.find(b=>b.id===recordId);if(!book)return;const text=book.raw[field];if(!text)return;button.textContent="⏳";button.disabled=true;const targetLang=isArabic(text)?"en":"ar",translated=await translateText(text,targetLang);if(translated){const div=document.createElement("div");div.className="translated";div.innerHTML=`<strong>${isArabic(translated)?"الترجمة:":"Translation:"}</strong> ${translated}`;button.parentElement.appendChild(div);button.remove()}else{button.textContent="🌐";button.disabled=false}}

/* ---- CALL BACKEND: keep payload (answer + bookIds + citations) ---- */
async function getAISummary(query,matchedBooks){
  if(matchedBooks.length===0) return null;
  try{
    const booksWithSummaries=matchedBooks.slice(0,20).map(b=>({
      id:b.id,title:b.raw.title,author:b.raw.author,
      subject:b.raw.subject||"",
      summary:b.raw.summary||b.raw.content||"",
      book_url:b.raw.book_url||""
    }));
    const response=await fetch(`${BACKEND_URL}/chat`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({query,matchedBooks:booksWithSummaries,searchField:LAST.field})
    });
    if(!response.ok) return null;
    return await response.json(); // { answer, bookIds, citations }
  }catch(error){
    console.error("AI summary error:",error);
    return null;
  }
}

/* ------------------- Render ------------------- */
function clearResults(){body.innerHTML=""}
function renderChunk(items){
  const frag=document.createDocumentFragment();
  for(const it of items){
    const r=it.raw,div=document.createElement("div");
    div.className="row";div.dir=isArabic(r.title||r.author)?"rtl":"ltr";
    const authors=[r.author,r.other_author,r.corporate_name].filter(Boolean).join(" • ");
    const pubLine=[r.publisher,r.year].filter(Boolean).join(" • ");
    const translateTo=isArabic(r.title)?"EN":"AR";
    div.innerHTML=`<button class="translate-icon" onclick="translateRecord(${it.id},'title',this)">🌐 ${translateTo}</button>
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;padding-left:60px">
        <b style="font-size:15px;line-height:1.4;flex:1;min-width:0;word-break:break-word">${r.title||"(بدون عنوان)"}</b>
        ${r.book_url?`<a class="btn" href="${r.book_url}" target="_blank" style="flex-shrink:0">Open</a>`:'<button class="btn" disabled style="flex-shrink:0">No URL</button>'}
      </div>
      ${authors?`<div class="meta">${isArabic(authors)?"المؤلف: ":"Author: "}${authors}</div>`:""}
      ${r.subject?`<div class="meta">${isArabic(r.subject)?"الموضوع: ":"Subject: "}${r.subject}</div>`:""}
      ${pubLine?`<div class="meta">${pubLine}</div>`:""}
      ${r.summary?`<div style="margin-top:6px;font-size:13px">${r.summary.length>300?r.summary.slice(0,297)+"…":r.summary}</div>`:""}`;
    frag.appendChild(div)
  }
  body.appendChild(frag)
}
function addShowMoreIfNeeded(){
  const old=document.getElementById("more-btn");if(old)old.remove();
  if(LAST.shown>=LAST.items.length)return;
  const row=document.createElement("div");row.className="more-row";row.id="more-btn";
  const btn=document.createElement("button"),remaining=LAST.items.length-LAST.shown;
  btn.textContent=remaining>PAGE_SIZE?"Show more":"Show all";
  btn.onclick=()=>{const next=Math.min(LAST.shown+PAGE_SIZE,LAST.items.length);renderChunk(LAST.items.slice(LAST.shown,next));LAST.shown=next;addShowMoreIfNeeded()};
  row.appendChild(btn);body.appendChild(row)
}

/* ------------------- Render all, with AI + citations ------------------- */
async function renderAll(list,field,query){
  clearResults();
  const labelAR={author:"المؤلف + المؤلف المشارك",title:"العنوان",subject:"الموضوع + العنوان",summary:"الملخص + المحتويات",year:"سنة النشر",pub:"الناشر"}[field]||field;
  const note=document.createElement("div");note.className="info";
  const extra=MATCH_NOTE?" • "+MATCH_NOTE:"";
  note.textContent=`Searching: ${labelAR}${extra}`;
  body.appendChild(note);

  if(!list.length){
    const empty=document.createElement("div");
    empty.className="info";
    empty.textContent="لا توجد نتائج / No results found";
    body.appendChild(empty);
    return;
  }

  // AI summary section
  const aiSummaryDiv=document.createElement("div");
  aiSummaryDiv.className="ai-summary";
  aiSummaryDiv.innerHTML="⏳ AI analyzing summaries...";
  body.appendChild(aiSummaryDiv);

  const sliceForAI=list.slice(0,20);
  getAISummary(query,sliceForAI).then(payload=>{
    if(!payload){ aiSummaryDiv.remove(); return; }

    // 1) Render LLM answer with inline numbered citations:
    // Replace (ID: 123) -> <sup><a href="#cite-123">[n]</a></sup>
    let answer=payload.answer||"";
    const idOrder=[];
    answer=answer.replace(/\(ID:\s*(\d+)\)/g,(_,id)=>{
      const idx=idOrder.indexOf(id);
      const num=(idx>=0)?(idx+1):(idOrder.push(id),idOrder.length);
      return `<sup><a href="#cite-${id}" style="color:#BF9849;text-decoration:none">[${num}]</a></sup>`;
    });
    aiSummaryDiv.innerHTML=answer;

    // 2) Build a local map from the 20 books we sent (fallback)
    const localMap=new Map();
    for(const b of sliceForAI){
      localMap.set(String(b.id),{
        id:b.id,
        title:b.raw?.title || b.title || 'Untitled',
        author:b.raw?.author || b.author || 'Unknown',
        url:b.raw?.book_url || b.book_url || ''
      });
    }

    // 3) Prefer backend citations; fallback to ids extracted from text
    let cites = Array.isArray(payload.citations) ? payload.citations : [];
    if(!cites.length && Array.isArray(payload.bookIds)){
      cites = payload.bookIds.map(id=>localMap.get(String(id))).filter(Boolean);
    }
    if(!cites.length) return;

    // 4) Render the Sources / المراجع list
    const wrap=document.createElement("div");
    wrap.className="cites";
    wrap.innerHTML=`<h4>${isArabic(query)?'المراجع':'Sources'}</h4>`;

    const ul=document.createElement("div");
    ul.className="cite-list";

    let counter=1;
    for(const c of cites){
      const div=document.createElement("div");
      div.className="cite";
      div.id=`cite-${c.id}`;
      div.innerHTML=`
        <b>[${counter}]</b>
        <span style="max-width:340px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
          ${c.title || 'Untitled'} — <i>${c.author || 'Unknown'}</i>
        </span>
        ${c.url ? `<a href="${c.url}" target="_blank" rel="noopener">Open</a>`
                : `<a aria-disabled="true" disabled>Open</a>`}
      `;
      ul.appendChild(div);
      counter++;
    }
    wrap.appendChild(ul);
    aiSummaryDiv.appendChild(wrap);
  });

  const info=document.createElement("div");
  info.className="info";
  info.textContent=`وجدت ${list.length} نتيجة / Found ${list.length} results`;
  body.appendChild(info);

  LAST.items=list;LAST.shown=Math.min(PAGE_SIZE,list.length);LAST.field=field;
  renderChunk(list.slice(0,LAST.shown));addShowMoreIfNeeded();
}

/* ------------------- Run ------------------- */
async function run(){
  setBusy(true,"Searching…");
  try{
    await ensureLoaded();
    const raw=q.value.trim();if(!raw){setBusy(false);return}
    const field=chooseField(raw),results=searchField(field,raw);
    await renderAll(results,field,raw)
  }finally{
    setBusy(false)
  }
}
go.onclick=run;
q.addEventListener("keydown",e=>{if(e.key==="Enter")run()});
window.translateRecord=translateRecord;
</script>
</body>
</html>
