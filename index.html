<!DOCTYPE html>
<html lang="ar" dir="auto">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ECSSR AI Assistant</title>
<style>
  :root{
    --brand:#BF9849;
    --logo-url:url("https://assets.almanhal.com/platform/shared/Product/ECSSR/middlelogo.png");
    --fab-size:70px;
  }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#F3EFED;margin:0;padding:2rem}
  
  .fab-wrap{
    position:fixed;right:18px;bottom:18px;z-index:9999;
    width:var(--fab-size);height:calc(var(--fab-size)+36px);
  }
  
  .fab-label{
    position:absolute;left:50%;bottom:calc(var(--fab-size)+4px);transform:translateX(-50%);
    width:calc(var(--fab-size)+36px);height:34px;pointer-events:none;
    filter:drop-shadow(0 1px 0 rgba(255,255,255,.65));
  }
  .fab-label text{fill:var(--brand);font-weight:700;font-size:12px;letter-spacing:.5px}
  
  .fab{
    position:absolute;left:0;bottom:0;width:var(--fab-size);height:var(--fab-size);
    background:#fff var(--logo-url) center/145% no-repeat;
    border:5px solid #BF9849;border-radius:50%;cursor:pointer;
    box-shadow:0 10px 30px rgba(191,152,73,0.4);
    transition:transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  .fab:hover{
    transform:scale(1.08);
    box-shadow:0 15px 40px rgba(191,152,73,0.6);
  }
  
  .slide-banner{
    position:fixed;
    right:calc(var(--fab-size) + 30px);
    bottom:calc(18px + (var(--fab-size) / 2) - 22px);
    background:linear-gradient(135deg,#BF9849,#D4AB5E);color:#fff;
    padding:14px 28px;border-radius:30px;font-weight:700;font-size:15px;
    box-shadow:0 8px 24px rgba(191,152,73,0.5);white-space:nowrap;z-index:9998;
    animation:slideFromBottom 7s ease-in-out forwards;opacity:0;letter-spacing:0.3px;
  }
  
  @keyframes slideFromBottom {
    0% { transform:translateY(200px); opacity:0; }
    15% { transform:translateY(0); opacity:1; }
    85% { transform:translateY(0); opacity:1; }
    100% { transform:translateY(200px); opacity:0; }
  }
  
  .box{
    position:fixed;right:18px;bottom:calc(18px + var(--fab-size) + 12px);
    width:min(620px,94vw);max-height:85vh;background:#fff;border-radius:14px;
    box-shadow:0 16px 40px rgba(0,0,0,.25);display:none;flex-direction:column;
    overflow:hidden;z-index:9999;
  }
  
  .head{
    background:linear-gradient(135deg,#BF9849,#D4AB5E);color:#fff;padding:12px 16px;
    font-weight:600;display:flex;justify-content:space-between;align-items:center;
  }
  .close{background:none;border:none;color:#fff;font-size:20px;cursor:pointer}
  
  .status{font-size:12px;padding:8px 12px;background:#fafafa;border-bottom:1px solid #e8eef3}
  .body{padding:10px;overflow:auto;flex:1}
  
  .row{background:#f6f9fc;border:1px solid #e7edf4;border-radius:12px;padding:12px;margin:10px 0;position:relative}
  .row:hover{box-shadow:0 4px 12px rgba(0,0,0,0.08);border-color:#BF9849}
  .meta{opacity:.85;font-size:12px;margin-top:6px}
  
  .translate-icon{position:absolute;top:12px;left:12px;background:#fff;border:1px solid #e0e0e0;
    border-radius:6px;padding:4px 8px;font-size:11px;cursor:pointer;transition:all 0.2s;z-index:10}
  .translate-icon:hover{background:#BF9849;color:#fff;border-color:#BF9849}
  .translated{background:#e8f4f8;padding:8px;margin-top:8px;border-radius:6px;font-size:13px;border-left:3px solid #BF9849}
  
  .ai-summary{background:linear-gradient(135deg,#e8f4f8,#f0f8ff);border-left:4px solid #BF9849;
    padding:12px;margin:10px 0;border-radius:8px;font-size:13px;line-height:1.6}
  .ai-summary::before{content:"ğŸ¤– ";margin-right:4px}
  
  .input-wrap{padding:10px;background:#fafafa;border-top:1px solid #e8eef3}
  .input{display:flex;gap:8px}
  .input input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #cfd9e3}
  .input button{background:#BF9849;color:#fff;border:none;border-radius:10px;padding:10px 16px;
    font-weight:600;cursor:pointer}
  .input button:disabled{opacity:.5}
  
  .btn{background:#BF9849;color:#fff;padding:6px 12px;border-radius:8px;text-decoration:none;
    font-weight:600;font-size:12px;display:inline-block;white-space:nowrap}
  .btn:hover{background:#D4AB5E}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  
  .info{background:#e8f4f8;border-left:4px solid #BF9849;padding:10px;margin:10px 0;border-radius:8px;font-size:13px}
  .more-row{display:flex;justify-content:center;margin-top:10px}
  .more-row button{background:#BF9849;color:#fff;border:none;border-radius:10px;padding:8px 14px;font-weight:700;cursor:pointer}
  
  .busybar{display:none;align-items:center;gap:10px;padding:8px 12px;background:#fff;border-bottom:1px solid #e8eef3}
  .box.busy .busybar{display:flex}
  .spinner{width:32px;height:32px;border-radius:50%;background:#fff var(--logo-url) center/90% no-repeat;
    border:3px solid rgba(0,0,0,.06);box-shadow:0 2px 8px rgba(0,0,0,.12);animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .busytext{font-weight:600;color:#555}
</style>
</head>
<body>
  <div class="slide-banner" id="slideBanner">
    UAE Federation Library AI Assistant
  </div>

  <div class="fab-wrap">
    <svg class="fab-label" viewBox="0 0 120 40"><defs><path id="arc" d="M 10,34 A 50,50 0 0 1 110,34"/></defs>
      <text text-anchor="middle"><textPath href="#arc" startOffset="50%">AI Assist</textPath></text>
    </svg>
    <button class="fab" id="fab"></button>
  </div>

  <div class="box" id="box">
    <div class="head">
      <div>ECSSR AI Search</div>
      <button class="close" id="close">Ã—</button>
    </div>
    
    <div class="busybar" id="busybar">
      <div class="spinner"></div>
      <div class="busytext" id="busytext">Loading...</div>
    </div>
    
    <div class="status" id="status">Ready</div>
    <div class="body" id="body"></div>
    
    <div class="input-wrap">
      <div class="input">
        <input id="q" type="text" placeholder="Ø§ÙƒØªØ¨: Ø§Ø³Ù… Ù…Ø¤Ù„Ù / Ø¹Ù†ÙˆØ§Ù† / Ù…ÙˆØ¶ÙˆØ¹ / Ø§Ø³Ù… Ø´Ø®ØµÙŠØ© / Ø³Ù†Ø©" dir="auto">
        <button id="go">Search</button>
      </div>
    </div>
  </div>

<script>
const DATA_URL = "./opac-catalog.tab?delim=tab";
const PAGE_SIZE = 12;
const BACKEND_URL = "https://ecssr-ai-assistant.onrender.com/api";

let INDEX = [];
let HEADERS = [];
let LOADED = false;
let MATCH_NOTE = "";
let LAST = {items:[], shown:0, field:""};

const fab = document.getElementById("fab");
const box = document.getElementById("box");
const close = document.getElementById("close");
const body = document.getElementById("body");
const status = document.getElementById("status");
const q = document.getElementById("q");
const go = document.getElementById("go");

setTimeout(() => {
  const banner = document.getElementById("slideBanner");
  if(banner) banner.remove();
}, 7500);

fab.onclick = () => { 
  box.style.display = box.style.display === "flex" ? "none" : "flex";
  if(box.style.display === "flex") {
    if(!LOADED) {
      setBusy(true,"Initializingâ€¦");
      ensureLoaded().then(()=>setBusy(false));
    }
    setTimeout(() => q.focus(), 50);
  }
};
close.onclick = () => box.style.display = "none";

function setBusy(on, label){
  const bar = document.getElementById('busybar');
  const txt = document.getElementById('busytext');
  if(label) txt.textContent = label;
  if(on){ 
    box.classList.add('busy');
    go.disabled = true;
    q.disabled = true;
  } else { 
    box.classList.remove('busy');
    go.disabled = false;
    q.disabled = false;
  }
}

function stripBidi(s){ return String(s||"").replace(/[\u200E\u200F\u202A-\u202E]/g,""); }
function clean(s){ return stripBidi(String(s||"").replace(/^\uFEFF/,"")); }
function canonHeader(h){ return clean(h).toLowerCase().replace(/\s+/g," ").trim(); }

function norm(s){
  if(!s) return "";
  s = clean(s).toLowerCase();
  try{s=s.normalize("NFKD");}catch(e){}
  s = s
    .replace(/[Ø¥Ø£Ø¢Ù±]/g,"Ø§")
    .replace(/[Ù‰ÛŒ]/g,"ÙŠ")
    .replace(/Ø©/g,"Ù‡")
    .replace(/Ú©/g,"Ùƒ")
    .replace(/\bØ¹Ø¨Ø¯\s+Ø§Ù„/g,"Ø¹Ø¨Ø¯Ø§Ù„")
    .replace(/[\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06ED\u0640]/g,"")
    .replace(/[\u0660-\u0669]/g,d=>d.charCodeAt(0)-0x0660)
    .replace(/[\u06F0-\u06F9]/g,d=>d.charCodeAt(0)-0x06F0)
    .replace(/[^\p{L}\p{N}\s]/gu," ")
    .replace(/\s+/g," ").trim();
  return s;
}

function isArabic(s){ return /[\u0600-\u06FF]/.test(s||""); }

const FAMOUS_PEOPLE = new Set([
  "Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø²Ø§ÙŠØ¯", "Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø±Ø§Ø´Ø¯", "Ø®Ù„ÙŠÙØ© Ø¨Ù† Ø²Ø§ÙŠØ¯", "Ø²Ø§ÙŠØ¯ Ø¨Ù† Ø³Ù„Ø·Ø§Ù†",
  "Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø²Ø§ÙŠØ¯ Ø¢Ù„ Ù†Ù‡ÙŠØ§Ù†", "sheikh mohamed", "sheikh mohammed", "sheikh khalifa", "sheikh zayed",
  "Ø§Ù„Ø´ÙŠØ® Ù…Ø­Ù…Ø¯", "Ø§Ù„Ø´ÙŠØ® Ø®Ù„ÙŠÙØ©", "Ø§Ù„Ø´ÙŠØ® Ø²Ø§ÙŠØ¯"
]);

const NAME_STOPWORDS = new Set([
  "Ø¨Ù†","Ø§Ø¨Ù†","Ø¨Ù†Øª","Ø£Ø¨Ùˆ","Ø§Ø¨Ùˆ","Ø¢Ù„","Ø¹Ø¨Ø¯","Ø¹Ø¨Ø¯Ø§Ù„","Ø¨Ù†Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡","Ø¨Ù†Ø¹Ø¨Ø¯","Ø¨Ù†Ø¹Ø¨Ø¯Ø§Ù„",
  "Ø§Ù„Ø¯ÙƒØªÙˆØ±","Ø¯ÙƒØªÙˆØ±","Ø§Ù„Ø£Ø³ØªØ§Ø°","Ø§Ø³ØªØ§Ø°","Ø¯","Ù…","Ø³Ù…Ùˆ","Ø³Ø¹Ø§Ø¯Ø©","Ù…Ø¹Ø§Ù„ÙŠ","Ø§Ù„Ø´ÙŠØ®","sheikh"
]);

const AR_NAME_PARTS = new Set(["Ø¨Ù†","Ø§Ø¨Ù†","Ø¨Ù†Øª","Ø£Ø¨Ùˆ","Ø§Ø¨Ùˆ","Ø¢Ù„","Ø¹Ø¨Ø¯","Ø¹Ø¨Ø¯Ø§Ù„"]);
const EN_STOP = new Set(["the","a","an","of","and","for","on","in","to","with"]);

// FIXED: More specific author detection
function looksLikeYear(q){ return /^\d{4}$/.test(q.trim()); }

function isFamousPerson(q){
  const nq = norm(q);
  for(const person of FAMOUS_PEOPLE){
    if(nq.includes(norm(person))) return true;
  }
  if(/\b(president|Ø±Ø¦ÙŠØ³|Ø³Ù…Ùˆ|ØµØ§Ø­Ø¨ Ø§Ù„Ø³Ù…Ùˆ)\b/i.test(q)) return true;
  return false;
}

// FIXED: Much stricter author name detection
function looksLikeName(q){
  const s=q.trim(); 
  if(!s||looksLikeYear(s)) return false;
  if(isFamousPerson(s)) return false;
  
  const toks=s.split(/\s+/).filter(Boolean);
  
  // Must be 2-4 words for Arabic, 2-3 for English
  if(toks.length<2 || toks.length>4) return false;
  
  // Must have Arabic name parts (Ø¨Ù†ØŒ Ø§Ø¨Ù†ØŒ etc.) OR match existing authors
  let hasNamePart = false;
  for(const t of toks){
    if(AR_NAME_PARTS.has(norm(t))) hasNamePart = true;
  }
  
  // If no Arabic name parts, check if it matches existing authors
  if(!hasNamePart){
    const nq=norm(s);
    let foundInAuthors = false;
    for(let i=0;i<Math.min(200,INDEX.length);i++){
      if(INDEX[i].nAuthorAll.includes(nq)){
        foundInAuthors = true;
        break;
      }
    }
    if(!foundInAuthors) return false; // Not an author!
  }
  
  return true;
}

function tokenizeQuery(raw){
  const q = norm(raw);
  if (!q) return [];
  const toks = q.split(/\s+/).filter(t => t.length >= 2 && !/^\d+$/.test(t));
  return toks.filter(t => !NAME_STOPWORDS.has(t));
}

function containsAllTokens(targetNorm, tokens){
  if (!tokens.length) return false;
  for (const t of tokens) if (!targetNorm.includes(t)) return false;
  return true;
}

// FIXED: Better field chooser - topics should go to subject, not author
function chooseField(q){
  const raw = q.trim();
  const nq = norm(q);
  
  // 1. YEAR detection
  if(looksLikeYear(raw)) return "year";
  
  // 2. QUESTION detection
  const questionWords = /^(what|how|why|when|where|who|which|Ù…Ø§|ÙƒÙŠÙ|Ù„Ù…Ø§Ø°Ø§|Ù…ØªÙ‰|Ø£ÙŠÙ†|Ù…Ù†|Ù…Ø§Ø°Ø§|ÙƒÙŠÙÙŠØ©|Ù‡Ù„)\b/i;
  if(questionWords.test(raw)) {
    MATCH_NOTE = "Question detected â†’ searching in Abstract & Contents";
    return "summary";
  }
  
  // 3. FAMOUS PERSON detection
  if(isFamousPerson(raw)) {
    MATCH_NOTE = "Famous person â†’ searching in Subject & Title (not Author)";
    return "subject";
  }
  
  // 4. TOPIC KEYWORDS - Common Arabic subjects (NOT author names)
  const topicKeywords = /(Ø§Ù„ØªØ±Ø§Ø«|Ø§Ù„Ø«Ù‚Ø§ÙØ©|Ø§Ù„ØªØ§Ø±ÙŠØ®|Ø§Ù„ÙÙ†|Ø§Ù„Ø¹Ù„ÙˆÙ…|Ø§Ù„Ø£Ø¯Ø¨|Ø§Ù„Ø´Ø¹Ø±|Ø§Ù„Ø³ÙŠØ§Ø³Ø©|Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯|Ø§Ù„ØªØ¹Ù„ÙŠÙ…|Ø§Ù„ØµØ­Ø©|Ø§Ù„Ø¨ÙŠØ¦Ø©|Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§|Ø§Ù„Ø°ÙƒØ§Ø¡|Ø§Ù„Ø·Ø§Ù‚Ø©|Ø§Ù„Ù…ÙŠØ§Ù‡|Ø§Ù„Ø²Ø±Ø§Ø¹Ø©|Ø§Ù„Ø´Ø¹Ø¨ÙŠ|Ø§Ù„Ù‚ÙˆÙ…ÙŠ|Ø§Ù„ÙˆØ·Ù†ÙŠ|Ø§Ù„Ø¯ÙŠÙ†ÙŠ|Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ)/;
  if(topicKeywords.test(raw)) {
    MATCH_NOTE = "Topic keyword detected â†’ searching in Subject & Title";
    return "subject";
  }
  
  // 5. AUTHOR NAME detection - STRICT
  if(looksLikeName(raw)) {
    MATCH_NOTE = "Author name detected â†’ searching in Author & Co-Author";
    return "author";
  }
  
  // 6. Check actual distribution in catalog
  const tokens = tokenizeQuery(raw);
  if(tokens.length > 0){
    let subjectMatches = 0;
    let titleMatches = 0;
    let authorMatches = 0;
    
    for(let i=0; i<Math.min(500, INDEX.length); i++){
      const r = INDEX[i];
      if(r.nSubject.includes(nq)) subjectMatches++;
      if(r.nTitle.includes(nq)) titleMatches++;
      if(r.nAuthorAll.includes(nq)) authorMatches++;
    }
    
    // If appears in subjects >> authors, it's a topic
    if(subjectMatches > authorMatches * 3){
      MATCH_NOTE = "Topic detected â†’ searching in Subject & Title";
      return "subject";
    }
    
    // If appears in authors, search authors
    if(authorMatches > subjectMatches){
      MATCH_NOTE = "Found in authors â†’ searching Author fields";
      return "author";
    }
  }
  
  // 7. DEFAULT: subject search (safer than title for Arabic)
  return "subject";
}

async function ensureLoaded(){
  if(LOADED) return;
  try{
    setBusy(true,"Loading recordsâ€¦");
    const resp = await fetch(DATA_URL, {cache:"reload"});
    if(!resp.ok) throw new Error(`Fetch ${resp.status}`);
    
    const buf = await resp.arrayBuffer();
    const decoder = new TextDecoder('utf-8');
    const text = decoder.decode(buf);
    
    const lines = text.split(/\r?\n/);
    if(lines.length < 2) throw new Error("Empty catalog");
    
    const headers = lines[0].split("\t").map(canonHeader);
    HEADERS = headers;
    
    for(let i=1; i<lines.length; i++){
      const cols = lines[i].split("\t");
      if(cols.length < 2 || (cols.length === 1 && !cols[0])) continue;
      
      const rec = {};
      headers.forEach((h, idx) => {
        rec[h] = clean(cols[idx] || "");
      });
      
      const title = rec["full title"] || rec["title"] || rec["Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"] || "";
      const author = rec["author"] || rec["Ø§Ù„Ù…Ø¤Ù„Ù"] || "";
      const otherAu = rec["other author"] || rec["Ø§Ù„Ù…Ø¤Ù„Ù Ø§Ù„Ø¢Ø®Ø±"] || "";
      const corporate = rec["corporate name"] || rec["Ø¬Ù‡Ø© Ù…Ø¤Ø³Ø³ÙŠØ©"] || "";
      const subject = rec["subjects"] || rec["subject"] || rec["Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹Ø§Øª"] || "";
      const summary = rec["abstract"] || rec["summary"] || rec["Ø§Ù„Ù…Ù„Ø®Øµ"] || "";
      const content = rec["content"] || rec["contents"] || rec["Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª"] || "";
      const pubData = rec["publications data"] || rec["Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø±"] || "";
      const bookUrl = rec["book_url"] || rec["book url"] || rec["Ø±Ø§Ø¨Ø· Ø§Ù„ÙƒØªØ§Ø¨"] || "";
      const year = rec["year"] || rec["Ø§Ù„Ø³Ù†Ø©"] || (pubData.match(/(19|20)\d{2}/)||[""])[0];
      const publisher = pubData.replace(/\b(19|20)\d{2}\b/g,"").trim();
      
      const authorAll = [author, otherAu, corporate].filter(Boolean).join(" ");
      
      INDEX.push({
        id: INDEX.length,
        raw: {title, author, other_author:otherAu, corporate_name:corporate, subject, summary, content, publisher, year, book_url:bookUrl},
        nTitle: norm(title),
        nAuthorAll: norm(authorAll),
        nSummary: norm(summary),
        nContent: norm(content),
        nSubject: norm(subject),
        nPub: norm(publisher + " " + corporate),
        nYear: norm(year)
      });
    }
    
    LOADED = true;
    status.textContent = `âœ… Loaded ${INDEX.length} records`;
  }catch(e){
    status.textContent = `âŒ Error: ${e.message}`;
  }finally{
    setBusy(false);
  }
}

function searchField(field, q){
  const nq = norm(q);
  const out = [];
  MATCH_NOTE = "";
  
  for (const r of INDEX){
    let hit=false, sc=0;

    if (field === "author"){
      const tokens = tokenizeQuery(q);
      if (tokens.length >= 2){
        if (containsAllTokens(r.nAuthorAll, tokens)){
          sc = 100 + tokens.length;
          hit = true;
        }
      } else {
        const tok = tokens[0] || nq;
        if (tok && r.nAuthorAll.includes(tok)){
          sc = 85;
          hit = true;
        }
      }
    } else if (field === "title"){
      if (r.nTitle.includes(nq)) { sc=80; hit=true; }
    } else if (field === "subject"){
      if (r.nSubject.includes(nq)) { sc=100; hit=true; }
      if (r.nTitle.includes(nq)) { sc=85; hit=true; }
      
      if(hit && isFamousPerson(q)) {
        MATCH_NOTE = "Searching books ABOUT this person (not BY them)";
      }
    } else if (field === "summary"){
      if (r.nSummary.includes(nq)) { sc=90; hit=true; }
      if (r.nContent.includes(nq)) { sc=80; hit=true; }
    } else if (field === "year"){
      if (r.nYear.includes(nq)) { sc=60; hit=true; }
    } else if (field === "pub"){
      if (r.nPub.includes(nq)) { sc=50; hit=true; }
    }

    if (hit) out.push({sc, ...r});
  }
  
  out.sort((a,b)=>b.sc-a.sc);
  return out;
}

async function translateText(text, targetLang) {
  try {
    const sourceLang = isArabic(text) ? 'ar' : 'en';
    if(sourceLang === targetLang) return text;
    
    const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${sourceLang}|${targetLang}`;
    const response = await fetch(url);
    const data = await response.json();
    
    if(data.responseData && data.responseData.translatedText) {
      return data.responseData.translatedText;
    }
    throw new Error("Translation failed");
  } catch(error) {
    console.error("Translation error:", error);
    return null;
  }
}

async function translateRecord(recordId, field, button) {
  const book = INDEX.find(b => b.id === recordId);
  if(!book) return;
  
  const text = book.raw[field];
  if(!text) return;
  
  button.textContent = "â³";
  button.disabled = true;
  
  const targetLang = isArabic(text) ? 'en' : 'ar';
  const translated = await translateText(text, targetLang);
  
  if(translated) {
    const div = document.createElement('div');
    div.className = 'translated';
    div.innerHTML = `<strong>${isArabic(translated)?'Ø§Ù„ØªØ±Ø¬Ù…Ø©:':'Translation:'}</strong> ${translated}`;
    button.parentElement.appendChild(div);
    button.remove();
  } else {
    button.textContent = "ğŸŒ";
    button.disabled = false;
  }
}

async function getAISummary(query, matchedBooks){
  if(matchedBooks.length === 0) return null;
  
  try {
    const booksWithSummaries = matchedBooks.slice(0, 20).map(b => ({
      id: b.id,
      title: b.raw.title,
      author: b.raw.author,
      subject: b.raw.subject || '',
      summary: b.raw.summary || b.raw.content || ""
    }));
    
    const response = await fetch(`${BACKEND_URL}/chat`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        query,
        matchedBooks: booksWithSummaries,
        searchField: LAST.field
      })
    });
    
    if (!response.ok) return null;
    const data = await response.json();
    return data.answer;
  } catch (error) {
    console.error('AI summary error:', error);
    return null;
  }
}

function clearResults(){ body.innerHTML = ""; }

function renderChunk(items){
  const frag = document.createDocumentFragment();
  for(const it of items){
    const r = it.raw;
    const div = document.createElement("div");
    div.className = "row";
    div.dir = isArabic(r.title || r.author) ? "rtl" : "ltr";
    
    const authors = [r.author, r.other_author, r.corporate_name].filter(Boolean).join(" â€¢ ");
    const pubLine = [r.publisher, r.year].filter(Boolean).join(" â€¢ ");
    const translateTo = isArabic(r.title) ? 'EN' : 'AR';
    
    div.innerHTML = `
      <button class="translate-icon" onclick="translateRecord(${it.id}, 'title', this)">
        ğŸŒ ${translateTo}
      </button>
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;padding-left:60px;">
        <b style="font-size:15px;line-height:1.4;flex:1;min-width:0;word-break:break-word;">${r.title || "(Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†)"}</b>
        ${r.book_url ? `<a class="btn" href="${r.book_url}" target="_blank" style="flex-shrink:0;">Open</a>` : `<button class="btn" disabled style="flex-shrink:0;">No URL</button>`}
      </div>
      ${authors ? `<div class="meta">${isArabic(authors)?'Ø§Ù„Ù…Ø¤Ù„Ù: ':'Author: '}${authors}</div>` : ""}
      ${r.subject ? `<div class="meta">${isArabic(r.subject)?'Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: ':'Subject: '}${r.subject}</div>` : ""}
      ${pubLine ? `<div class="meta">${pubLine}</div>` : ""}
      ${r.summary ? `<div style="margin-top:6px;font-size:13px">${r.summary.length>300 ? r.summary.slice(0,297)+'â€¦' : r.summary}</div>` : ""}
    `;
    frag.appendChild(div);
  }
  body.appendChild(frag);
}

function addShowMoreIfNeeded(){
  const old = document.getElementById("more-btn");
  if(old) old.remove();
  if(LAST.shown >= LAST.items.length) return;
  
  const row = document.createElement("div");
  row.className = "more-row";
  row.id = "more-btn";
  const btn = document.createElement("button");
  const remaining = LAST.items.length - LAST.shown;
  btn.textContent = remaining>PAGE_SIZE ? "Show more" : "Show all";
  btn.onclick = () => {
    const next = Math.min(LAST.shown+PAGE_SIZE, LAST.items.length);
    renderChunk(LAST.items.slice(LAST.shown, next));
    LAST.shown = next;
    addShowMoreIfNeeded();
  };
  row.appendChild(btn);
  body.appendChild(row);
}

async function renderAll(list, field, query){
  clearResults();
  
  const labelAR = {
    author:"Ø§Ù„Ù…Ø¤Ù„Ù + Ø§Ù„Ù…Ø¤Ù„Ù Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ",
    title:"Ø§Ù„Ø¹Ù†ÙˆØ§Ù†",
    subject:"Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ + Ø§Ù„Ø¹Ù†ÙˆØ§Ù†",
    summary:"Ø§Ù„Ù…Ù„Ø®Øµ + Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª",
    year:"Ø³Ù†Ø© Ø§Ù„Ù†Ø´Ø±",
    pub:"Ø§Ù„Ù†Ø§Ø´Ø±"
  }[field] || field;
  
  const note = document.createElement("div");
  note.className = "info";
  const extra = MATCH_NOTE ? " â€¢ " + MATCH_NOTE : "";
  note.textContent = `Searching: ${labelAR}${extra}`;
  body.appendChild(note);

  if(!list.length){
    const empty = document.createElement("div");
    empty.className = "info";
    empty.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ / No results found";
    body.appendChild(empty);
    return;
  }
  
  const aiSummaryDiv = document.createElement("div");
  aiSummaryDiv.className = "ai-summary";
  aiSummaryDiv.innerHTML = "â³ AI analyzing summaries...";
  body.appendChild(aiSummaryDiv);
  
  getAISummary(query, list.slice(0,20)).then(aiAnswer => {
    if(aiAnswer){
      aiSummaryDiv.innerHTML = aiAnswer;
    } else {
      aiSummaryDiv.remove();
    }
  });
  
  const info = document.createElement("div");
  info.className = "info";
  info.textContent = `ÙˆØ¬Ø¯Øª ${list.length} Ù†ØªÙŠØ¬Ø© / Found ${list.length} results`;
  body.appendChild(info);
  
  LAST.items = list;
  LAST.shown = Math.min(PAGE_SIZE, list.length);
  LAST.field = field;
  
  renderChunk(list.slice(0, LAST.shown));
  addShowMoreIfNeeded();
}

async function run(){
  setBusy(true, "Searchingâ€¦");
  try{
    await ensureLoaded();
    const raw = q.value.trim();
    if(!raw){ setBusy(false); return; }
    
    const field = chooseField(raw);
    const results = searchField(field, raw);
    await renderAll(results, field, raw);
  }finally{
    setBusy(false);
  }
}

go.onclick = run;
q.addEventListener("keydown", e => { 
  if(e.key === "Enter") run(); 
});

window.translateRecord = translateRecord;

// REMOVED: Don't load on page load - only when user opens widget
// ensureLoaded();
</script>
</body>
</html>
