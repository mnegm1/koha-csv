<!DOCTYPE html>
<html lang="ar" dir="auto">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>UAE Federation Library AI Assistant</title>
<style>
:root{--brand:#BF9849;--logo-url:url("https://assets.almanhal.com/platform/shared/Product/ECSSR/middlelogo.png");--fab-size:70px}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#F3EFED;margin:0;padding:2rem}
.fab-wrap{position:fixed;right:18px;bottom:18px;z-index:9999;width:var(--fab-size);height:calc(var(--fab-size)+36px)}
.fab-label{position:absolute;left:50%;bottom:calc(var(--fab-size)+4px);transform:translateX(-50%);width:calc(var(--fab-size)+36px);height:34px;pointer-events:none;filter:drop-shadow(0 1px 0 rgba(255,255,255,.65))}
.fab-label text{fill:var(--brand);font-weight:700;font-size:12px;letter-spacing:.5px}
.fab{position:absolute;left:0;bottom:0;width:var(--fab-size);height:var(--fab-size);background:#fff var(--logo-url) center/145% no-repeat;border:5px solid #BF9849;border-radius:50%;cursor:pointer;box-shadow:0 10px 30px rgba(191,152,73,0.4);transition:transform 0.3s ease, box-shadow 0.3s ease}
.fab:hover{transform:scale(1.08);box-shadow:0 15px 40px rgba(191,152,73,0.6)}
.slide-banner{position:fixed;right:calc(var(--fab-size) + 30px);bottom:calc(18px + (var(--fab-size) / 2) - 22px);background:linear-gradient(135deg,#BF9849,#D4AB5E);color:#fff;padding:14px 28px;border-radius:30px;font-weight:700;font-size:15px;box-shadow:0 8px 24px rgba(191,152,73,0.5);white-space:nowrap;z-index:9998;animation:slideFromBottom 7s ease-in-out forwards;opacity:0;letter-spacing:0.3px}
@keyframes slideFromBottom{0%{transform:translateY(200px);opacity:0}15%{transform:translateY(0);opacity:1}85%{transform:translateY(0);opacity:1}100%{transform:translateY(200px);opacity:0}}
.box{position:fixed;right:18px;bottom:calc(18px + var(--fab-size) + 12px);width:min(620px,94vw);max-height:85vh;background:#fff;border-radius:14px;box-shadow:0 16px 40px rgba(0,0,0,.25);display:none;flex-direction:column;overflow:hidden;z-index:9999}
.head{background:linear-gradient(135deg,#BF9849,#D4AB5E);color:#fff;padding:12px 16px;font-weight:600;display:flex;justify-content:space-between;align-items:center}
.close{background:none;border:none;color:#fff;font-size:20px;cursor:pointer}
.status{font-size:12px;padding:8px 12px;background:#fafafa;border-bottom:1px solid #e8eef3}
.body{padding:10px;overflow:auto;flex:1}
.row{background:#f6f9fc;border:1px solid #e7edf4;border-radius:12px;padding:12px;margin:10px 0;position:relative}
.row:hover{box-shadow:0 4px 12px rgba(0,0,0,0.08);border-color:#BF9849}
.meta{opacity:.85;font-size:12px;margin-top:6px}
.translate-icon{position:absolute;top:12px;left:12px;background:#fff;border:1px solid #e0e0e0;border-radius:6px;padding:4px 8px;font-size:11px;cursor:pointer;transition:all 0.2s;z-index:10}
.translate-icon:hover{background:#BF9849;color:#fff;border-color:#BF9849}
.translated{background:#e8f4f8;padding:8px;margin-top:8px;border-radius:6px;font-size:13px;border-left:3px solid #BF9849}
.ai-summary{background:linear-gradient(135deg,#e8f4f8,#f0f8ff);border-left:4px solid #BF9849;padding:12px;margin:10px 0;border-radius:8px;font-size:13px;line-height:1.6}
.ai-summary::before{content:"ğŸ¤– ";margin-right:4px}
.citations-box{background:#fffbf0;border:2px solid #BF9849;border-radius:8px;padding:12px;margin:10px 0;font-size:12px}
.citations-box h4{margin:0 0 8px 0;color:#BF9849;font-size:13px}
.citation-item{padding:6px 0;border-bottom:1px solid #e0e0e0}
.citation-item:last-child{border-bottom:none}
.citation-link{color:#BF9849;text-decoration:none;font-weight:600}
.citation-link:hover{text-decoration:underline}
.input-wrap{padding:10px;background:#fafafa;border-top:1px solid #e8eef3}
.input{display:flex;gap:8px}
.input input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #cfd9e3}
.input button{background:#BF9849;color:#fff;border:none;border-radius:10px;padding:10px 16px;font-weight:600;cursor:pointer}
.input button:disabled{opacity:.5}
.btn{background:#BF9849;color:#fff;padding:6px 12px;border-radius:8px;text-decoration:none;font-weight:600;font-size:12px;display:inline-block;white-space:nowrap}
.btn:hover{background:#D4AB5E}
.btn[disabled]{opacity:.5;cursor:not-allowed}
.info{background:#e8f4f8;border-left:4px solid #BF9849;padding:10px;margin:10px 0;border-radius:8px;font-size:13px}
.more-row{display:flex;justify-content:center;margin-top:10px}
.more-row button{background:#BF9849;color:#fff;border:none;border-radius:10px;padding:8px 14px;font-weight:700;cursor:pointer}
.busybar{display:none;align-items:center;gap:12px;padding:12px 14px;background:#fff;border-bottom:1px solid #e8eef3}
.box.busy .busybar{display:flex}
.spinner{width:32px;height:32px;border-radius:50%;background:#fff var(--logo-url) center/90% no-repeat;border:3px solid rgba(0,0,0,.06);box-shadow:0 2px 8px rgba(0,0,0,.12);animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes rotate{0%,100%{transform:rotate(0deg)}50%{transform:rotate(180deg)}}
@keyframes hourglassAnimation{0%{transform:scaleY(1)}50%{transform:scaleY(0.85)}100%{transform:scaleY(1)}}
.hourglass-icon{display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;font-size:20px;animation:hourglassAnimation 1.5s ease-in-out infinite;transform-origin:center;margin-right:8px}
.busytext{font-weight:600;color:#555;display:flex;align-items:center;gap:6px}
.item-type-badge{display:inline-block;background:#BF9849;color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;margin-left:6px}
/* Web sources styling with hyperlinks */
.web-sources-section{margin-top:15px;padding:15px;background:#e8f4f8;border-left:4px solid #BF9849;border-radius:8px}
.web-sources-title{font-weight:700;color:#BF9849;margin-bottom:10px;font-size:14px}
.web-sources-subtitle{font-size:12px;color:#666;margin-bottom:12px}
.web-source-item{margin-bottom:12px;padding:12px;background:white;border-radius:6px;border:1px solid #ddd;transition:all 0.2s ease}
.web-source-item:hover{border-color:#BF9849;box-shadow:0 2px 8px rgba(191,152,73,0.15)}
.web-source-domain{font-weight:600;color:#BF9849;margin-bottom:6px;font-size:12px;text-transform:uppercase;letter-spacing:0.5px}
.web-source-link{display:inline-block;color:#BF9849;font-size:13px;text-decoration:underline;font-weight:600;padding:6px 0;border-bottom:2px solid transparent;transition:all 0.2s ease;cursor:pointer}
.web-source-link:hover{border-bottom-color:#BF9849;color:#D4AB5E;text-decoration:underline}
.web-source-link::before{content:"ğŸ”— "}
</style>
</head>
<body>
<div class="slide-banner" id="slideBanner">UAE Federation Library AI Assistant</div>
<div class="fab-wrap">
  <svg class="fab-label" viewBox="0 0 120 40"><defs><path id="arc" d="M 10,34 A 50,50 0 0 1 110,34"/></defs><text text-anchor="middle"><textPath href="#arc" startOffset="50%">AI Assist</textPath></text></svg>
  <button class="fab" id="fab"></button>
</div>

<div class="box" id="box">
  <div class="head"><div>UAE Federation Library AI Search</div><button class="close" id="close">Ã—</button></div>
   <div class="busybar" id="busybar"><div class="spinner"></div><div class="busytext" id="busytext">Loading...</div></div>
  <div class="status" id="status">Ready</div>
  <div class="body" id="body"></div>
  <div class="input-wrap"><div class="input"><input id="q" type="text" placeholder="Ø§ÙƒØªØ¨: Ø§Ø³Ù… Ù…Ø¤Ù„Ù / Ø¹Ù†ÙˆØ§Ù† / Ù…ÙˆØ¶ÙˆØ¹ / Ø³Ù†Ø©" dir="auto"><button id="go">Search</button></div></div>
</div>

<script>
const DATA_URL="./opac-catalog.tab?delim=tab";
const PAGE_SIZE=12;
const BACKEND_URL="https://ecssr-ai-assistant.onrender.com/api";

let INDEX=[],HEADERS=[],LOADED=false,MATCH_NOTE="",LAST={items:[],shown:0,field:""};

const fab=document.getElementById("fab"),box=document.getElementById("box"),close=document.getElementById("close"),body=document.getElementById("body"),status=document.getElementById("status"),q=document.getElementById("q"),go=document.getElementById("go");
setTimeout(()=>{const b=document.getElementById("slideBanner");if(b)b.remove()},7500);
fab.onclick=()=>{box.style.display=(box.style.display==="flex")?"none":"flex";if(box.style.display==="flex"){if(!LOADED){setBusy(true,"Initializingâ€¦");ensureLoaded().then(()=>setBusy(false))}setTimeout(()=>q.focus(),50)}};
close.onclick=()=>box.style.display="none";

function setBusy(on,label){const bar=document.getElementById("busybar"),txt=document.getElementById("busytext");if(label)txt.textContent=label;if(on){box.classList.add("busy");go.disabled=true;q.disabled=true}else{box.classList.remove("busy");go.disabled=false;q.disabled=false}}
function stripBidi(s){return String(s||"").replace(/[\u200E\u200F\u202A-\u202E]/g,"")}
function clean(s){return stripBidi(String(s||"").replace(/^\uFEFF/,""))}
function canonHeader(h){return clean(h).toLowerCase().replace(/\s+/g," ").trim()}
function norm(s){
  if(!s)return "";
  s=clean(s).toLowerCase();
  try{s=s.normalize("NFKD")}catch(e){}
  s=s.replace(/[Ø¥Ø£Ø¢Ù±]/g,"Ø§")
     .replace(/\s*Ùˆ\s*/g,"Ùˆ")
     .replace(/[Ù‰ÛŒ]/g,"ÙŠ")
     .replace(/Ø©/g,"Ù‡")
     .replace(/Ú©/g,"Ùƒ")
     .replace(/\bØ¹Ø¨Ø¯\s+Ø§Ù„/g,"Ø¹Ø¨Ø¯Ø§Ù„")
     .replace(/[\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06ED\u0640]/g,"")
     .replace(/[\u0660-\u0669]/g,d=>String.fromCharCode(d.charCodeAt(0)-1632+48))
     .replace(/[\u06F0-\u06F9]/g,d=>String.fromCharCode(d.charCodeAt(0)-1776+48))
     .replace(/[^\p{L}\p{N}\s]/gu," ")
     .replace(/\s+/g," ")
     .trim();
  return s
}
function isArabic(s){return/[\u0600-\u06FF]/.test(s||"")}
// Famous people (search in content/summary - books ABOUT them)
const FAMOUS_PEOPLE=new Set(["Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø²Ø§ÙŠØ¯","Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø±Ø§Ø´Ø¯","Ø®Ù„ÙŠÙØ© Ø¨Ù† Ø²Ø§ÙŠØ¯","Ø²Ø§ÙŠØ¯ Ø¨Ù† Ø³Ù„Ø·Ø§Ù†","Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø²Ø§ÙŠØ¯ Ø¢Ù„ Ù†Ù‡ÙŠØ§Ù†","sheikh mohamed","sheikh mohammed","sheikh khalifa","sheikh zayed","Ø§Ù„Ø´ÙŠØ® Ù…Ø­Ù…Ø¯","Ø§Ù„Ø´ÙŠØ® Ø®Ù„ÙŠÙØ©","Ø§Ù„Ø´ÙŠØ® Ø²Ø§ÙŠØ¯","ØµØ§Ø­Ø¨ Ø§Ù„Ø³Ù…Ùˆ"]);

// Common UAE/Arab cities and locations
const KNOWN_LOCATIONS=new Set(["Ø¯Ø¨ÙŠ","dubai","Ø£Ø¨ÙˆØ¸Ø¨ÙŠ","Ø£Ø¨Ùˆ Ø¸Ø¨ÙŠ","Ø§Ø¨ÙˆØ¸Ø¨ÙŠ","abu dhabi","Ø§Ù„Ø´Ø§Ø±Ù‚Ø©","sharjah","Ø¹Ø¬Ù…Ø§Ù†","ajman","Ø±Ø£Ø³ Ø§Ù„Ø®ÙŠÙ…Ø©","ras al khaimah","Ø§Ù„ÙØ¬ÙŠØ±Ø©","fujairah","Ø§Ù… Ø§Ù„Ù‚ÙŠÙˆÙŠÙ†","umm al quwain","Ø§Ù„Ø¹ÙŠÙ†","al ain","Ø§Ù„Ø¸ÙØ±Ø©","Ù…ØµØ±","egypt","Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©","saudi arabia","Ø§Ù„Ø±ÙŠØ§Ø¶","riyadh","Ø¬Ø¯Ø©","jeddah","Ø§Ù„ÙƒÙˆÙŠØª","kuwait","Ù‚Ø·Ø±","qatar","Ø§Ù„Ø¯ÙˆØ­Ø©","doha","Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†","bahrain","Ø§Ù„Ù…Ù†Ø§Ù…Ø©","manama","Ø¹Ù…Ø§Ù†","oman","Ù…Ø³Ù‚Ø·","muscat","Ø§Ù„Ø£Ø±Ø¯Ù†","jordan","Ø¹Ù…Ù‘Ø§Ù†","amman","Ù„Ø¨Ù†Ø§Ù†","lebanon","Ø¨ÙŠØ±ÙˆØª","beirut","Ø³ÙˆØ±ÙŠØ§","syria","Ø¯Ù…Ø´Ù‚","damascus","Ø§Ù„Ø¹Ø±Ø§Ù‚","iraq","Ø¨ØºØ¯Ø§Ø¯","baghdad","ÙÙ„Ø³Ø·ÙŠÙ†","palestine","Ø§Ù„Ù‚Ø¯Ø³","jerusalem","Ø§Ù„ÙŠÙ…Ù†","yemen","ØµÙ†Ø¹Ø§Ø¡","sanaa","Ø§Ù„Ù…ØºØ±Ø¨","morocco","Ø§Ù„Ø±Ø¨Ø§Ø·","rabat","ØªÙˆÙ†Ø³","tunisia","Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±","algeria","Ù„ÙŠØ¨ÙŠØ§","libya","Ø§Ù„Ø³ÙˆØ¯Ø§Ù†","sudan","Ø§Ù„Ø®Ø±Ø·ÙˆÙ…","khartoum","Ù„Ù†Ø¯Ù†","london","Ø¨Ø§Ø±ÙŠØ³","paris","Ù†ÙŠÙˆÙŠÙˆØ±Ùƒ","new york","ÙˆØ§Ø´Ù†Ø·Ù†","washington","Ù…ÙˆØ³ÙƒÙˆ","moscow","Ø¨ÙƒÙŠÙ†","beijing","Ø·ÙˆÙƒÙŠÙˆ","tokyo","Ø¨Ø±Ù„ÙŠÙ†","berlin","Ø±ÙˆÙ…Ø§","rome","Ù…Ø¯Ø±ÙŠØ¯","madrid","Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©","cairo","Ø§Ø³Ø·Ù†Ø¨ÙˆÙ„","istanbul","Ø·Ù‡Ø±Ø§Ù†","tehran"]);

// Publisher location keywords
const PUBLISHER_KEYWORDS=new Set(["Ø¯Ø§Ø±","Ø¯Ø§Ø± Ù†Ø´Ø±","publisher","published in","Ù…Ø·Ø¨Ø¹Ø©","Ù…Ø·Ø¨ÙˆØ¹ ÙÙŠ","Ù†Ø´Ø± ÙÙŠ","Ù…Ø±ÙƒØ²","ØµØ¯Ø± ÙÙŠ","ØµØ§Ø¯Ø± Ø¹Ù†"]);

function looksLikeYear(q){return/^\d{4}$/.test(q.trim())}

function isFamousPerson(q){
  const nq=norm(q);
  for(const p of FAMOUS_PEOPLE)if(nq.includes(norm(p)))return true;
  return/\b(president|Ø±Ø¦ÙŠØ³|Ø³Ù…Ùˆ|ØµØ§Ø­Ø¨ Ø§Ù„Ø³Ù…Ùˆ|Ø´ÙŠØ®|Ø§Ù„Ø´ÙŠØ®)\b/i.test(q);
}

function isKnownLocation(q){
  const nq=norm(q);
  for(const loc of KNOWN_LOCATIONS)if(nq.includes(norm(loc)))return true;
  return false;
}

function hasPublisherKeywords(q){
  const nq=norm(q);
  for(const kw of PUBLISHER_KEYWORDS)if(nq.includes(norm(kw)))return true;
  return false;
}

// ---------- AUTHOR MATCHING (surname anchor + non-common name) ----------
const NAME_STOP = new Set(["Ø¨Ù†","Ø¨Ù†Øª","Ø§Ø¨Ù†","Ø£Ø¨Ù†","Ø¢Ù„","Ø§Ù„","Ø£Ø¨Ùˆ","Ø§Ø¨Ùˆ","Ø¨Ùˆ","Ø¨Ù†Ù‘","Ø¹Ø¨Ø¯","Ø¹Ø¨Ø¯Ø§Ù„"]);
const COMMON_GIVEN = new Set(["Ù…Ø­Ù…Ø¯","Ø§Ø­Ù…Ø¯","Ø£Ø­Ù…Ø¯","Ø¹Ù„ÙŠ","Ø­Ø³Ù†","Ø­Ø³ÙŠÙ†","Ø®Ø§Ù„Ø¯","Ø³Ø¹ÙŠØ¯","Ø³Ø§Ù„Ù…","ÙŠÙˆØ³Ù","Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡","Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡","Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù†","Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­Ù…Ù†","Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ²","Ø¹Ø¨Ø¯ Ø§Ù„Ø¹Ø²ÙŠØ²","Ø¹Ø¨Ø¯Ø§Ù„","Ø¹Ø¨Ø¯","Ù…Ø­Ù…ÙˆØ¯","Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ…","Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…","Ø¹Ù…Ø±","Ø³Ø§Ù…ÙŠ","Ø³Ø¹ÙŠØ¯","Ù†Ø§Ø¯Ø±","Ù…Ø§Ø¬Ø¯"]);

function extractSurname(tokens){
  for(let i=tokens.length-1;i>=0;i--){
    const t = tokens[i];
    if(!NAME_STOP.has(t)) return t;
  }
  return tokens[tokens.length-1] || null;
}
function tokenizeName(n){ return norm(n).split(/\s+/).filter(t=>t.length>=2) }
function tokenEq(a,b){
  if(a===b) return true;
  if(a.length>=3 && b.startsWith(a)) return true;
  if(b.length>=3 && a.startsWith(b)) return true;
  return false;
}
function exactAuthorMatch(qTokens, name){
  const aTokens = tokenizeName(name);
  if(qTokens.length!==aTokens.length) return false;
  return qTokens.every(qt => aTokens.some(at=>tokenEq(qt,at))) &&
         aTokens.every(at => qTokens.some(qt=>tokenEq(qt,at)));
}
function flexibleAuthorMatch(qTokens, name){
  const aTokens = tokenizeName(name);
  if(aTokens.length===0 || qTokens.length===0) return {hit:false,score:0};

  const anchor = extractSurname(qTokens);
  const hasAnchor = anchor ? aTokens.some(at=>tokenEq(anchor, at)) : false;
  if(anchor && !hasAnchor) return {hit:false,score:0};

  const qNonCommon = qTokens.filter(t => t !== anchor && !COMMON_GIVEN.has(t) && !NAME_STOP.has(t));
  if(qNonCommon.length > 0){
    const hasDistinct = qNonCommon.some(t => aTokens.some(at=>tokenEq(t,at)));
    if(!hasDistinct) return {hit:false,score:0};
  }

  let overlap=0; const used=new Array(aTokens.length).fill(false);
  for(const qt of qTokens){
    const i=aTokens.findIndex((at,idx)=>!used[idx] && tokenEq(qt,at));
    if(i>=0){ used[i]=true; overlap++; }
  }
  const minLen=Math.min(qTokens.length,aTokens.length);
  const need=Math.max(2, Math.ceil(minLen*0.66));
  if(overlap>=need){
    const closeness=1 - Math.abs(qTokens.length - aTokens.length)/5;
    const anchorBonus=hasAnchor?8:0;
    const distinctBonus=(qNonCommon.length>0)?5:0;
    return {hit:true, score:70 + overlap*10 + closeness*5 + anchorBonus + distinctBonus};
  }
  return {hit:false,score:0};
}


// ---------- AI QUERY UNDERSTANDING - REMOVED (TOO SLOW) ----------
// Removed this function to speed up search - was making extra API call


// ---------- FIELD CHOOSER (with AI fallback) ----------
async function chooseFieldSmart(q){
  const raw=q.trim();
  
  // 1. Check for YEAR first
  if(looksLikeYear(raw)){
    MATCH_NOTE="Year detected";
    return "year";
  }
  
  // 2. Check if it's a FAMOUS PERSON (highest priority - search in content/summary)
  if(isFamousPerson(raw)){
    MATCH_NOTE="Famous person â†’ Content & Summary (books ABOUT them)";
    return "famous_person";
  }
  
  // 3. Check if it's a KNOWN LOCATION
  if(isKnownLocation(raw)){
    // If it has publisher keywords â†’ search publisher location
    if(hasPublisherKeywords(raw)){
      MATCH_NOTE="Location with publisher keyword â†’ Publisher location";
      return "pub_location";
    } else {
      // Otherwise â†’ location as subject
      MATCH_NOTE="Location as subject â†’ Subject, Title";
      return "location_subject";
    }
  }
  
  // 4. Check for PUBLISHER keywords (without location)
  if(hasPublisherKeywords(raw)){
    MATCH_NOTE="Publisher keyword â†’ Publisher field";
    return "pub";
  }
  
  // 5. Call AI-powered backend for smart analysis
  try {
    console.log(`ğŸ¤– Asking AI to analyze: "${raw}"`);
    
    const response = await fetch(`${BACKEND_URL}/understand-query`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({query: raw})
    });
    
    if(!response.ok) throw new Error('AI analysis failed');
    
    const analysis = await response.json();
    console.log('ğŸ“Š AI analysis:', analysis);
    
    // Map AI analysis to search fields
    const queryType = analysis.intent || analysis.queryType;
    const searchFields = analysis.searchFields || [];
    
    // For PERSON queries â†’ this is a REGULAR AUTHOR (not famous)
    if (queryType === 'person' && searchFields.includes('author')) {
      MATCH_NOTE = `AI: Author name â†’ Author, Co-author, Corporate author`;
      return 'author';
    } 
    // For PLACE queries â†’ distinguish between subject and publisher location
    else if (queryType === 'place') {
      if (searchFields.includes('publisher_location')) {
        MATCH_NOTE = `AI: Publisher location â†’ Publisher field`;
        return 'pub_location';
      } else {
        MATCH_NOTE = `AI: Location as subject â†’ Subject, Title`;
        return 'location_subject';
      }
    } 
    // For TITLE queries
    else if (queryType === 'title' || (searchFields.includes('title') && searchFields.length === 1)) {
      MATCH_NOTE = `AI: Book title â†’ Title`;
      return 'title';
    } 
    // For SUBJECT/TOPIC queries
    else if (searchFields.includes('subject')) {
      MATCH_NOTE = `AI: Topic/Subject â†’ Subject`;
      return 'subject';
    } 
    // Default
    else {
      MATCH_NOTE = `AI: General search â†’ All fields`;
      return 'default';
    }
    
  } catch (error) {
    console.error('âš ï¸ AI analysis failed, using fallback:', error);
    // Fallback to rule-based logic
    return chooseField(raw);
  }
}

// ---------- FIELD CHOOSER (rule-based) ----------
function chooseField(q){
  const raw=q.trim();
  if(/(Ù†Ø§Ø´Ø±|publisher|Ø¯Ø§Ø± Ù†Ø´Ø±|Ø¯Ø§Ø± Ø§Ù„Ù†Ø´Ø±|publishing house|press books)/i.test(raw)){MATCH_NOTE="Publisher keyword â†’ Publisher field";return "pub"}
  if(looksLikeYear(raw))return "year";
  if(/^(what|how|why|when|where|who|which|Ù…Ø§|ÙƒÙŠÙ|Ù„Ù…Ø§Ø°Ø§|Ù…ØªÙ‰|Ø£ÙŠÙ†|Ù…Ù†|Ù…Ø§Ø°Ø§|ÙƒÙŠÙÙŠØ©|Ù‡Ù„)\b/i.test(raw)){MATCH_NOTE="Question â†’ Summary";return "summary"}
  
  // Famous people â†’ search in content/summary (books ABOUT them)
  if(isFamousPerson(raw)){MATCH_NOTE="Famous person â†’ Content & Summary (books ABOUT them)";return "famous_person"}
  
  if(/(ØªØ±Ø§Ø«|Ø§Ù„ØªØ±Ø§Ø«|Ø«Ù‚Ø§ÙØ©|Ø§Ù„Ø«Ù‚Ø§ÙØ©|ØªØ§Ø±ÙŠØ®|Ø§Ù„ØªØ§Ø±ÙŠØ®|ÙÙ†|Ø§Ù„ÙÙ†|Ø¹Ù„ÙˆÙ…|Ø§Ù„Ø¹Ù„ÙˆÙ…|Ø£Ø¯Ø¨|Ø§Ù„Ø£Ø¯Ø¨|Ø´Ø¹Ø±|Ø§Ù„Ø´Ø¹Ø±|Ø³ÙŠØ§Ø³Ø©|Ø§Ù„Ø³ÙŠØ§Ø³Ø©|Ø§Ù‚ØªØµØ§Ø¯|Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯|ØªØ¹Ù„ÙŠÙ…|Ø§Ù„ØªØ¹Ù„ÙŠÙ…|ØµØ­Ø©|Ø§Ù„ØµØ­Ø©|Ø¨ÙŠØ¦Ø©|Ø§Ù„Ø¨ÙŠØ¦Ø©|ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§|Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§|Ø°ÙƒØ§Ø¡|Ø§Ù„Ø°ÙƒØ§Ø¡|Ø·Ø§Ù‚Ø©|Ø§Ù„Ø·Ø§Ù‚Ø©|Ù…ÙŠØ§Ù‡|Ø§Ù„Ù…ÙŠØ§Ù‡|Ø²Ø±Ø§Ø¹Ø©|Ø§Ù„Ø²Ø±Ø§Ø¹Ø©|Ù†ÙØ·|Ø§Ù„Ù†ÙØ·|ØºØ§Ø²|Ø§Ù„ØºØ§Ø²|Ø§Ù…Ø§Ø±Ø§Øª|Ø§Ù„Ø§Ù…Ø§Ø±Ø§Øª|Ø¥Ù…Ø§Ø±Ø§Øª|Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª)/i.test(raw)){MATCH_NOTE="Topic keyword â†’ Subject";return "subject"}
  if(LOADED && INDEX.length>0){
    const nq=norm(raw);let a=0,s=0;
    for(let i=0;i<Math.min(500,INDEX.length);i++){
      if(INDEX[i].nAuthorAll.includes(nq)) a++;
      if(INDEX[i].nSubject.includes(nq) || INDEX[i].nTitle.includes(nq)) s++;
    }
    if(s>3){MATCH_NOTE="Found in subjects â†’ Subject";return "subject"}
    if(a>3 && a>s){MATCH_NOTE="Found in authors â†’ Author";return "author"}
  }
  const words=raw.split(/\s+/).filter(Boolean);
  if(words.length>=2 && words.length<=3 && isArabic(raw) && !/[a-zA-Z]/.test(raw)){MATCH_NOTE="2-3 Arabic words â†’ Author";return "author"}
  MATCH_NOTE="Default â†’ Title+Subject+Author";return "default"
}

// ---------- LOAD DATA ----------
async function ensureLoaded(){
  if(LOADED)return;
  const resp=await fetch(DATA_URL);
  if(!resp.ok)throw new Error("Failed to load data");
  const txt=await resp.text(),lines=txt.split(/\r?\n/).filter(l=>l.trim());
  if(lines.length<2)throw new Error("Empty or invalid data");
  const rawHdrs=lines[0].split("\t");
  HEADERS=rawHdrs.map(h=>canonHeader(h));
  const idxMap={};
  ["biblionumber","full title","author","abstract","publications data","content","subjects","corporate name","other authors","year","item type","book_url"].forEach(h=>{const i=HEADERS.indexOf(h);if(i>=0)idxMap[h]=i});
  for(let i=1;i<lines.length;i++){
    const cells=lines[i].split("\t");
    if(cells.length!==rawHdrs.length)continue;
    const obj={id:cells[idxMap["biblionumber"]]||"",title:clean(cells[idxMap["full title"]]||""),author:clean(cells[idxMap["author"]]||""),summary:clean(cells[idxMap["abstract"]]||""),publisher:clean(cells[idxMap["publications data"]]||""),content:clean(cells[idxMap["content"]]||""),subject:clean(cells[idxMap["subjects"]]||""),corporate_name:clean(cells[idxMap["corporate name"]]||""),other_author:clean(cells[idxMap["other authors"]]||""),year:clean(cells[idxMap["year"]]||""),item_type:clean(cells[idxMap["item type"]]||""),book_url:clean(cells[idxMap["book_url"]]||"")};
    const combo=obj.author+" "+obj.other_author+" "+obj.corporate_name;
    INDEX.push({id:obj.id,raw:obj,nTitle:norm(obj.title),nAuthor:norm(obj.author),nOtherAuthor:norm(obj.other_author),nCorporate:norm(obj.corporate_name),nAuthorAll:norm(combo),nSummary:norm(obj.summary),nContent:norm(obj.content),nSubject:norm(obj.subject),nYear:norm(obj.year),nPub:norm(obj.publisher)})
  }
  LOADED=true;
  status.textContent=`âœ… Loaded ${INDEX.length} records`
}

// ---------- SEARCH ----------
function searchField(field,q){
  const nq=norm(q),tokens=nq.split(/\s+/).filter(t=>t.length>=2),out=[];
  for(const r of INDEX){
    let sc=0,hit=false;
    if(field==="default"){
      if(r.nTitle.includes(nq)){sc=100;hit=true}
      else if(r.nSubject.includes(nq)){sc=70;hit=true}
      else if(r.nAuthorAll.includes(nq)){sc=60;hit=true}
      else {
        const titleMatch = tokens.filter(tok=>r.nTitle.includes(tok)).length;
        const subjectMatch = tokens.filter(tok=>r.nSubject.includes(tok)).length;
        const authorMatch = tokens.filter(tok=>r.nAuthorAll.includes(tok)).length;
        const totalMatch = Math.max(titleMatch, subjectMatch, authorMatch);
        if(totalMatch >= tokens.length * 0.5){sc = 30 + totalMatch * 8;hit=true}
      }

    } else if (field === "famous_person") {
      // *** Famous people: Search in CONTENT and SUMMARY (books ABOUT them) ***
      if(r.nSummary.includes(nq)){sc=100;hit=true}
      else if(r.nContent.includes(nq)){sc=95;hit=true}
      else if(r.nTitle.includes(nq)){sc=90;hit=true}
      else if(r.nSubject.includes(nq)){sc=85;hit=true}
      else {
        const summaryMatch = tokens.filter(tok=>r.nSummary.includes(tok)).length;
        const contentMatch = tokens.filter(tok=>r.nContent.includes(tok)).length;
        const titleMatch = tokens.filter(tok=>r.nTitle.includes(tok)).length;
        const subjectMatch = tokens.filter(tok=>r.nSubject.includes(tok)).length;
        const totalMatch = Math.max(summaryMatch, contentMatch, titleMatch, subjectMatch);
        if(totalMatch >= tokens.length * 0.6){
          sc = 40 + totalMatch * 10;
          hit=true;
        }
      }

    } else if (field === "location_subject") {
      // *** Location as a SUBJECT/TOPIC ***
      if(r.nSubject.includes(nq)){sc=100;hit=true}
      else if(r.nTitle.includes(nq)){sc=90;hit=true}
      else {
        const subjectMatch = tokens.filter(tok=>r.nSubject.includes(tok)).length;
        const titleMatch = tokens.filter(tok=>r.nTitle.includes(tok)).length;
        const totalMatch = Math.max(subjectMatch, titleMatch);
        if(totalMatch >= tokens.length * 0.6){sc = 40 + totalMatch * 10;hit=true}
      }

    } else if (field === "pub_location") {
      // *** Location as PUBLISHER LOCATION ***
      if(r.nPub.includes(nq)){sc=100;hit=true}
      else {
        const matchCount = tokens.filter(tok=>r.nPub.includes(tok)).length;
        if(matchCount >= tokens.length * 0.5){sc = 50 + matchCount * 10;hit=true}
      }

    } else if (field === "author") {
      const tlen = tokens.length;

      // If user entered exactly 3 tokens â†’ enforce strict exact 3-name match
      if (tlen === 3) {
        const aMain  = tokenizeName(r.nAuthor);
        const aOther = tokenizeName(r.nOtherAuthor);
        const aCorp  = tokenizeName(r.nCorporate);

        if (aMain.length === 3 && exactAuthorMatch(tokens, r.nAuthor)) { sc = 130; hit = true; }
        else if (aOther.length === 3 && exactAuthorMatch(tokens, r.nOtherAuthor)) { sc = 122; hit = true; }
        else if (aCorp.length === 3 && exactAuthorMatch(tokens, r.nCorporate)) { sc = 115; hit = true; }

        if (hit) MATCH_NOTE = "Author: exact 3-name match";
        // Skip flexible logic in this case
      } else {
        // Keep existing behavior for all other queries
        if (exactAuthorMatch(tokens, r.nAuthor)) { sc = 120; hit = true; }
        else if (exactAuthorMatch(tokens, r.nOtherAuthor)) { sc = 112; hit = true; }
        else if (exactAuthorMatch(tokens, r.nCorporate)) { sc = 105; hit = true; }
        else {
          const main  = flexibleAuthorMatch(tokens, r.nAuthor);
          const other = flexibleAuthorMatch(tokens, r.nOtherAuthor);
          const corp  = flexibleAuthorMatch(tokens, r.nCorporate);
          const best  = [main, other, corp].reduce((a, b) => (a.score > b.score ? a : b), { hit: false, score: 0 });
          if (best.hit) { sc = best.score; hit = true; }
        }
        if (hit) MATCH_NOTE = "Author: surname + distinct name (if present)";
      }



    } else if(field==="subject"){
      if(r.nSubject.includes(nq)){sc=100;hit=true}
      else if(r.nTitle.includes(nq)){sc=80;hit=true}
      else {
        const subjectMatch = tokens.filter(tok=>r.nSubject.includes(tok)).length;
        const titleMatch = tokens.filter(tok=>r.nTitle.includes(tok)).length;
        const totalMatch = Math.max(subjectMatch, titleMatch);
        if(totalMatch >= tokens.length * 0.5){sc = 30 + totalMatch * 8;hit=true}
      }
      if(hit&&isFamousPerson(q))MATCH_NOTE="Books ABOUT this person"

    } else if(field==="summary"){
      if(r.nSummary.includes(nq)){sc=90;hit=true}
      else if(r.nContent.includes(nq)){sc=80;hit=true}
      else {
        const summaryMatch = tokens.filter(tok=>r.nSummary.includes(tok)).length;
        const contentMatch = tokens.filter(tok=>r.nContent.includes(tok)).length;
        const totalMatch = Math.max(summaryMatch, contentMatch);
        if(totalMatch >= tokens.length * 0.4){sc = 20 + totalMatch * 10;hit=true}
      }

    } else if(field==="year"){
      if(r.nYear.includes(nq)){sc=60;hit=true}

    } else if(field==="pub"){
      if(r.nPub.includes(nq)){sc=100;hit=true}
      else {
        const matchCount = tokens.filter(tok=>r.nPub.includes(tok)).length;
        if(matchCount >= tokens.length * 0.6){sc = 40 + matchCount * 10;hit=true}
      }
    }

    if(hit) out.push({sc,...r})
  }

  out.sort((a,b)=>b.sc-a.sc);
  return out
}

// ---------- TRANSLATION + AI SUMMARY ----------
async function translateText(text,targetLang){try{const sourceLang=isArabic(text)?"ar":"en";if(sourceLang===targetLang)return text;const url=`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${sourceLang}|${targetLang}`,response=await fetch(url),data=await response.json();if(data.responseData&&data.responseData.translatedText)return data.responseData.translatedText;throw new Error("Translation failed")}catch(error){console.error("Translation error:",error);return null}}
async function translateRecord(recordId,field,button){const book=INDEX.find(b=>b.id===recordId);if(!book)return;const text=book.raw[field];if(!text)return;button.textContent="â³";button.disabled=true;const targetLang=isArabic(text)?"en":"ar",translated=await translateText(text,targetLang);if(translated){const div=document.createElement("div");div.className="translated";div.innerHTML=`<strong>${isArabic(translated)?"Ø§Ù„ØªØ±Ø¬Ù…Ø©:":"Translation:"}</strong> ${translated}`;button.parentElement.appendChild(div);button.remove()}else{button.textContent="ğŸŒ";button.disabled=false}}
async function getAISummary(query,matchedBooks){
  if(matchedBooks.length===0)return null;
  try{
    const booksWithSummaries=matchedBooks.slice(0,20).map(b=>({
      id:b.id,
      title:b.raw.title,
      author:b.raw.author,
      subject:b.raw.subject||"",
      summary:b.raw.summary||b.raw.content||"",
      year:b.raw.year||"",
      item_type:b.raw.item_type||"",
      book_url:b.raw.book_url||""
    }));
    const response=await fetch(`${BACKEND_URL}/chat`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({query,books:booksWithSummaries,searchField:LAST.field})
    });
    if(!response.ok)return null;
    const data=await response.json();
    return {
      answer: data.answer, 
      bookIds: data.bookIds || [],
      source: data.source || 'library',
      webSources: data.webSources || [] // {url, title, domain}
    };
  }catch(error){
    console.error("AI summary error:",error);
    return null;
  }
}

// ---------- RENDER ----------
function clearResults(){body.innerHTML=""}
function startNewResearch(){
  clearResults();
  q.value="";
  q.focus();
  status.textContent="Ready";
}
function renderChunk(items){
  const frag=document.createDocumentFragment();
  for(const it of items){
    const r=it.raw,div=document.createElement("div");
    div.className="row";
    div.dir=isArabic(r.title||r.author)?"rtl":"ltr";
    const authors=[r.author,r.other_author,r.corporate_name].filter(Boolean).join(" â€¢ ");
    const pubLine=[r.publisher,r.year].filter(Boolean).join(" â€¢ ");
    const translateTo=isArabic(r.title)?"EN":"AR";
    
    // Add Item Type badge if available
    const itemTypeBadge = r.item_type ? `<span class="item-type-badge">${r.item_type}</span>` : '';
    
    div.innerHTML=
      `<button class="translate-icon" onclick="translateRecord('${it.id}','title',this)">ğŸŒ ${translateTo}</button>
       <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;padding-left:60px">
         <div style="flex:1;min-width:0">
           <b style="font-size:15px;line-height:1.4;word-break:break-word">${r.title||"(Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†)"}</b>
           ${itemTypeBadge}
         </div>
         ${r.book_url?`<a class="btn" href="${r.book_url}" target="_blank" style="flex-shrink:0">Open</a>`:'<button class="btn" disabled style="flex-shrink:0">No URL</button>'}
       </div>
       ${authors?`<div class="meta">${isArabic(authors)?"Ø§Ù„Ù…Ø¤Ù„Ù: ":"Author: "}${authors}</div>`:""}
       ${r.subject?`<div class="meta">${isArabic(r.subject)?"Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: ":"Subject: "}${r.subject}</div>`:""}
       ${pubLine?`<div class="meta">${pubLine}</div>`:""}
       ${r.summary?`<div style="margin-top:6px;font-size:13px">${r.summary.length>300?r.summary.slice(0,297)+"â€¦":r.summary}</div>`:""}`;
    frag.appendChild(div)
  }
  body.appendChild(frag)
}

function renderCitations(citations){
  if(!citations || citations.length === 0) return;
  
  const citationsDiv = document.createElement("div");
  citationsDiv.className = "citations-box";
  
  const isAr = isArabic(citations[0].title || '');
  const heading = isAr ? "ğŸ“š Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©:" : "ğŸ“š Sources Referenced:";
  
  let html = `<h4>${heading}</h4>`;
  
  citations.forEach((cite, idx) => {
    const num = idx + 1;
    let citationText = '';
    
    if(cite.title) citationText += cite.title;
    if(cite.author) citationText += (citationText ? ', by ' : '') + cite.author;
    if(cite.year) citationText += (citationText ? ', ' : '') + cite.year;
    if(cite.item_type) citationText += (citationText ? ' ' : '') + `[${cite.item_type}]`;
    
    html += `<div class="citation-item">
      ${num}. ${citationText}
      ${cite.url ? ` <a href="${cite.url}" target="_blank" class="citation-link">ğŸ”—</a>` : ''}
    </div>`;
  });
  
  citationsDiv.innerHTML = html;
  body.appendChild(citationsDiv);
}

async function renderAll(list,field,raw){
  clearResults();
  LAST={items:list,shown:0,field};
  
  if(list.length===0){
    const el=document.createElement("div");
    el.className="info";
    el.textContent=isArabic(raw)?`Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ / No results found`:`No results found`;
    body.appendChild(el);
    status.textContent="No results";
    return
  }
  
  // 1. Show results count
  const info=document.createElement("div");
  info.className="info";
  info.textContent=`ÙˆØ¬Ø¯Øª ${list.length} Ù†ØªÙŠØ¬Ø© / Found ${list.length} results`;
  body.appendChild(info);
  
  // 2. Show bibliographic records section header
  const recordsHeader=document.createElement("div");
  recordsHeader.style.cssText="background:linear-gradient(135deg,#BF9849,#D4AB5E);color:#fff;padding:12px;margin:15px 0 10px 0;border-radius:10px;font-weight:bold;text-align:center;font-size:16px";
  recordsHeader.textContent="ğŸ“š Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø§Ù„Ø¨Ø¨Ù„ÙŠÙˆØºØ±Ø§ÙÙŠØ© / Bibliographic Records";
  body.appendChild(recordsHeader);
  
  // 3. Render bibliographic records FIRST
  LAST.items=list;
  LAST.shown=Math.min(PAGE_SIZE,list.length);
  renderChunk(list.slice(0,LAST.shown));
  
  // Add "Load More" button if needed
  if(list.length>PAGE_SIZE){
    const moreDiv=document.createElement("div");
    moreDiv.className="more-row";
    const btn=document.createElement("button");
    btn.textContent=isArabic(raw)?`Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯ (${list.length-PAGE_SIZE} Ù…ØªØ¨Ù‚ÙŠ)`:`Load More (${list.length-PAGE_SIZE} remaining)`;
    btn.onclick=()=>{
      const nextChunk=LAST.items.slice(LAST.shown,LAST.shown+PAGE_SIZE);
      renderChunk(nextChunk);
      LAST.shown+=nextChunk.length;
      if(LAST.shown>=LAST.items.length)moreDiv.remove();
      else btn.textContent=isArabic(raw)?`Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯ (${LAST.items.length-LAST.shown} Ù…ØªØ¨Ù‚ÙŠ)`:`Load More (${LAST.items.length-LAST.shown} remaining)`
    };
    moreDiv.appendChild(btn);
    body.appendChild(moreDiv)
  }
  
  // 4. Add AI summary section AFTER records
  const aiSectionHeader=document.createElement("div");
  aiSectionHeader.style.cssText="background:linear-gradient(135deg,#BF9849,#D4AB5E);color:#fff;padding:12px;margin:25px 0 10px 0;border-radius:10px;font-weight:bold;text-align:center;font-size:16px;border-top:3px solid #BF9849";
  aiSectionHeader.textContent="ğŸ¤– Ù…Ù„Ø®Øµ Ø°ÙƒÙŠ / AI Summary";
  body.appendChild(aiSectionHeader);
  
  const aiSummaryDiv=document.createElement("div");
  aiSummaryDiv.className="ai-summary";
  aiSummaryDiv.innerHTML='<span style="display:inline-block;animation:rotate 1.5s linear infinite">â³</span> AI analyzing data...';
  body.appendChild(aiSummaryDiv);
  
  status.textContent=`âœ… Found ${list.length} results`;
  
  // Get AI summary asynchronously
  getAISummary(raw, list).then(result => {
    if(result && result.answer){
      console.log('âœ… AI Summary received:', result);
      
      // Convert links correctly (do NOT strip them)
let cleanedAnswer = result.answer.trim();

// 1) Convert Markdown links [text](url) â†’ <a href="url">text</a>
let answerWithLinks = cleanedAnswer
  .replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,
           '<a href="$2" target="_blank" style="color:#BF9849;font-weight:600;text-decoration:underline;">$1</a>')
  // 2) Convert raw (https://...) â†’ <a href="...">...</a>
  .replace(/\((https?:\/\/[^\s)]+)\)/g,
           '<a href="$1" target="_blank" style="color:#BF9849;font-weight:600;text-decoration:underline;">$1</a>')
  // 3) Basic markdown formatting
  .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
  .replace(/\*(.*?)\*/g, '<em>$1</em>')
  .replace(/~~(.*?)~~/g, '<del>$1</del>')
  .replace(/\n/g, '<br>');

      
      // Replace citations [1] with clickable links (BOOK sources)
      answerWithLinks = answerWithLinks.replace(/\[(\d+)\]/g, (match, num) => {
        const bookIndex = parseInt(num) - 1;
        if(bookIndex >= 0 && bookIndex < list.length){
          const book = list[bookIndex];
          const title = (book.raw.title || 'Untitled').toString();
          const bookUrl = book.raw.book_url || book.raw.book_Url || '#';
          
          if(bookUrl && bookUrl !== '#'){
            return `<a href="${bookUrl}" target="_blank" style="color:#BF9849;font-weight:700;text-decoration:none;border-bottom:2px solid #BF9849;padding:0 2px;background:rgba(191,152,73,0.1);border-radius:3px;cursor:pointer" title="${title}" onclick="event.stopPropagation()">[${num}]</a>`;
          } else {
            return `<span style="color:#BF9849;font-weight:700;background:rgba(191,152,73,0.1);padding:0 2px;border-radius:3px;cursor:pointer" title="${title}">[${num}]</span>`;
          }
        }
        return match;
      });
      
      // Replace citations [W1] [W2] etc with clickable web sources (WEB sources)
      answerWithLinks = answerWithLinks.replace(/\[W(\d+)\]/g, (match, num) => {
        const webIndex = parseInt(num) - 1;
        if(result.webSources && webIndex >= 0 && webIndex < result.webSources.length){
          const source = result.webSources[webIndex];
          let url = typeof source === 'string' ? source : (source.url || '#');
          let title = typeof source === 'string' ? source : (source.title || source.domain || 'Web Source');
          
          if(url && url !== '#'){
            return `<a href="${url}" target="_blank" style="color:#BF9849;font-weight:700;text-decoration:none;border-bottom:2px solid #BF9849;padding:0 2px;background:rgba(191,152,73,0.1);border-radius:3px;cursor:pointer" title="${title}" onclick="event.stopPropagation()">[W${num}]</a>`;
          } else {
            return `<span style="color:#BF9849;font-weight:700;background:rgba(191,152,73,0.1);padding:0 2px;border-radius:3px;cursor:pointer" title="${title}">[W${num}]</span>`;
          }
        }
        return match;
      });
      
      aiSummaryDiv.innerHTML=answerWithLinks;
      
      // REORDER: Add aiSummaryDiv to body FIRST (will be moved after)
      body.appendChild(aiSummaryDiv);
      
      // Add WEB sources section SECOND (right after AI summary)
      if(result.webSources && result.webSources.length > 0){
        const webSourcesDiv = document.createElement("div");
        webSourcesDiv.className = "web-sources-section";
        
        let webHTML = '<div class="web-sources-title">ğŸŒ Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¥Ù…Ø§Ø±Ø§ØªÙŠØ©  / UAE Web Sources :</div>';
        webHTML += '<div class="web-sources-subtitle">âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø¯Ø± Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ - Ø§Ù†Ù‚Ø± Ù„Ù„ØªØ£ÙƒØ¯ / All sources verifiable - click to verify</div>';
        
        // Filter web sources to match the search query (to avoid unrelated centers)
        const searchQueryNorm = norm(raw).toLowerCase();
        let relevantSources = result.webSources;
        
        // If we have a relevant search term, filter sources
        if(raw && raw.trim().length > 2){
          relevantSources = result.webSources.filter(source => {
            let sourceText = '';
            if(typeof source === 'string'){
              sourceText = source.toLowerCase();
            } else {
              sourceText = (source.title || source.domain || source.url || '').toLowerCase();
            }
            // Check if source contains search terms or is clearly relevant
            return sourceText.includes(searchQueryNorm) || 
                   sourceText.includes('ecssr') || 
                   sourceText.includes('sheikh') ||
                   sourceText.includes('zayed') ||
                   sourceText.includes('Ù…Ø­Ù…Ø¯') ||
                   sourceText.includes('Ø²Ø§ÙŠØ¯') ||
                   sourceText.includes('Ø´ÙŠØ®');
          });
        }
        
        // If filtering removed everything, show all sources
        if(relevantSources.length === 0){
          relevantSources = result.webSources;
        }
        
        relevantSources.forEach((source, idx) => {
          // Handle both string URLs and object format
          let url, domain, title;
          
          if (typeof source === 'string') {
            // Backend sent just URL string
            url = source;
            try {
              const urlObj = new URL(url);
              domain = urlObj.hostname.replace('www.', '');
              title = url.length > 80 ? url.substring(0, 77) + '...' : url;
            } catch {
              domain = 'UAE Source';
              title = url;
            }
          } else {
            // Backend sent object with domain, title, url
            url = source.url || '#';
            domain = source.domain || 'UAE Source';
            title = source.title || url;
          }
          
          webHTML += `<div class="web-source-item">`;
          webHTML += `<div class="web-source-domain">${domain}</div>`;
          if(url && url !== '#'){
            webHTML += `<a href="${url}" target="_blank" class="web-source-link">${title}</a>`;
          } else {
            webHTML += `<span style="color:#999;font-size:12px">${title}</span>`;
          }
          webHTML += `</div>`;
        });
        
        webSourcesDiv.innerHTML = webHTML;
        aiSummaryDiv.after(webSourcesDiv);
      }
      
      // Add book sources section THIRD (after web sources)
      if(result.bookIds && result.bookIds.length > 0){
        const bookSourcesDiv = document.createElement("div");
        bookSourcesDiv.style.cssText = "margin-top:15px;padding:15px;background:#fafafa;border-left:4px solid #BF9849;border-radius:8px";
        
        let sourcesHTML = '<div style="font-weight:700;color:#BF9849;margin-bottom:10px;font-size:14px">ğŸ“š Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© / Sources Used:</div>';
        
        result.bookIds.forEach(bookNum => {
          const bookIndex = bookNum - 1;
          if(bookIndex >= 0 && bookIndex < list.length){
            const book = list[bookIndex];
            const title = (book.raw.title || 'Untitled').toString();
            const author = (book.raw.author || 'Unknown').toString();
            const bookUrl = book.raw.book_url || book.raw.book_Url || '#';
            
            sourcesHTML += `<div style="margin-bottom:10px;padding:8px;background:white;border-radius:5px;border:1px solid #eee">`;
            sourcesHTML += `<span style="font-weight:700;color:#BF9849;font-size:16px">[${bookNum}]</span> `;
            sourcesHTML += `<strong>${title}</strong><br>`;
            sourcesHTML += `<span style="color:#666;font-size:12px">Ø§Ù„Ù…Ø¤Ù„Ù / Author: ${author}</span>`;
            if(bookUrl && bookUrl !== '#'){
              sourcesHTML += `<br><a href="${bookUrl}" target="_blank" style="color:#BF9849;font-size:12px;text-decoration:none;font-weight:600">ğŸ”— ÙØªØ­ Ø§Ù„ÙƒØªØ§Ø¨ / Open Book â†’</a>`;
            }
            sourcesHTML += `</div>`;
          }
        });
        
        bookSourcesDiv.innerHTML = sourcesHTML;
        // Find the last section and add after it
        const lastSection = aiSummaryDiv.nextElementSibling;
        if(lastSection){
          lastSection.after(bookSourcesDiv);
        } else {
          aiSummaryDiv.after(bookSourcesDiv);
        }
      }
      
      // Add Disclaimer note LAST
      const sourceNote=document.createElement("div");
      sourceNote.className="info";
      sourceNote.style.marginTop="8px";
      sourceNote.style.fontSize="12px";
      sourceNote.style.background="linear-gradient(135deg,#fff9e6,#fffbf0)";
      sourceNote.innerHTML="<strong>ğŸ“š Ø¥Ø®Ù„Ø§Ø¡ Ù…Ø³Ø¤ÙˆÙ„ÙŠØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ:</strong> ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ø®Øµ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø¨Ù‡Ø¯Ù ØªÙŠØ³ÙŠØ± ÙÙ‡Ù… Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØªÙ‚Ø¯ÙŠÙ… Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø³Ø±ÙŠØ¹Ø©. ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø§Ø­Ø¸Ø© Ø£Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆÙ„Ø¯Ø© Ù‚Ø¯ Ù„Ø§ ØªÙƒÙˆÙ† Ø¯Ù‚ÙŠÙ‚Ø© ØªÙ…Ø§Ù…Ù‹Ø§ Ø£Ùˆ Ø´Ø§Ù…Ù„Ø©ØŒ Ù„Ø°Ø§ ÙŠÙÙ†ØµØ­ Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ø£ØµÙ„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„ÙŠÙ‡Ø§. ÙˆÙ„Ø§ ØªØªØ­Ù…Ù„ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø£ÙŠ Ù…Ø³Ø¤ÙˆÙ„ÙŠØ© Ø¹Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØµØ§Ø¯Ø±Ø© Ø¹Ù† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ.<br><strong>ğŸ“š AI Information Disclaimer:</strong> This summary is automatically generated using artificial intelligence technologies to provide a quick overview of the content. The information presented may not be fully accurate or complete; therefore, it is recommended to verify details from the original source before relying on them. The library assumes no responsibility for any outcomes resulting from AI-generated conten.";
      
      // Add disclaimer after all sections
      let lastElement = aiSummaryDiv;
      let current = aiSummaryDiv.nextElementSibling;
      while(current){
        lastElement = current;
        current = current.nextElementSibling;
      }
      lastElement.after(sourceNote);
      
      // Add "Start New Research" button
      const newResearchBtn = document.createElement("div");
      newResearchBtn.style.cssText = "margin-top:20px;padding:15px;text-align:center";
      newResearchBtn.innerHTML = `<button onclick="startNewResearch()" style="background:#BF9849;color:#fff;border:none;padding:12px 30px;border-radius:8px;font-weight:600;font-size:14px;cursor:pointer;transition:all 0.3s ease">ğŸ”„ Start New Research</button>`;
      sourceNote.after(newResearchBtn);
    }else{
      console.error('âŒ No AI result or answer:', result);
      aiSummaryDiv.innerHTML = 'âš ï¸ AI summary unavailable';
      aiSummaryDiv.style.color = '#999';
      body.appendChild(aiSummaryDiv);
    }
  }).catch(error => {
    console.error('âŒ AI Summary error:', error);
    aiSummaryDiv.innerHTML = 'âš ï¸ Error generating AI summary';
    aiSummaryDiv.style.color = '#999';
    body.appendChild(aiSummaryDiv);
  });
}

// ---------- RUN ----------
async function run(){
  setBusy(true,"AI analyzing queryâ€¦");
  try{
    await ensureLoaded();
    const raw=q.value.trim();if(!raw){setBusy(false);return}
    
    // Use AI-powered smart field chooser
    const field = await chooseFieldSmart(raw);
    
    setBusy(true,"Searchingâ€¦");
    const results=searchField(field,raw);
    await renderAll(results,field,raw)
  }finally{setBusy(false)}
}
go.onclick=run;
q.addEventListener("keydown",e=>{if(e.key==="Enter")run()});
window.translateRecord=translateRecord;
</script>
</body>
</html>
