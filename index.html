/* === Koha OPAC — Catalog Assistant (.tab / TSV) — AR/EN solid === */
(function () {
  if (window.__KOHA_OPAC_ASSISTANT__) return; // prevent double-run
  window.__KOHA_OPAC_ASSISTANT__ = true;

  /* ================= CONFIG ================= */
  const CFG = {
    DATA_URL: "/koha-csv/opac-catalog.tab", // change if hosted elsewhere
    MAX_RESULTS: 18,
    MIN_QUERY_LEN: 1,
    OPEN_HOTKEY: true,        // Ctrl/Cmd + K to toggle
    REMEMBER_STATE: true,     // remember open/closed across pages
    BRAND_PRIMARY: "#3EA3DC",
    BRAND_ACCENT:  "#BF9849"
  };

  /* ================ STYLES ================== */
  const css = `
  .koha-assist-fab{position:fixed;right:18px;bottom:18px;background:${CFG.BRAND_PRIMARY};color:#fff;border:none;border-radius:50%;
    width:56px;height:56px;font-size:24px;cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,.25);z-index:2147483000;display:block}
  .koha-assist-box{position:fixed;right:18px;bottom:86px;width:min(560px,92vw);max-height:72vh;background:#fff;border-radius:14px;
    border:1px solid #e8eef3;box-shadow:0 16px 40px rgba(0,0,0,.25);display:flex;flex-direction:column;overflow:hidden;z-index:2147483000}
  .koha-assist-head{background:${CFG.BRAND_ACCENT};color:#fff;padding:10px 14px;font-weight:600;display:flex;gap:8px;align-items:center;justify-content:space-between}
  .koha-assist-body{padding:10px;overflow:auto;max-height:56vh;font-size:14px;background:#fff}
  .koha-assist-row{background:#f6f9fc;border:1px solid #e7edf4;border-radius:12px;padding:12px;margin:10px 0}
  .koha-assist-meta{opacity:.85;font-size:12px;margin-top:6px}
  .koha-assist-input{display:flex;gap:8px;padding:10px;background:#fafafa;border-top:1px solid #e8eef3}
  .koha-assist-input input{flex:1;padding:10px;border-radius:10px;border:1px solid #cfd9e3}
  .koha-assist-input button{background:${CFG.BRAND_PRIMARY};color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:600}
  .koha-assist-error{background:#fff0f0;border:1px solid #f5b5b5;color:#900;padding:10px;border-radius:10px}
  .koha-assist-btn{flex:0 0 auto;background:${CFG.BRAND_PRIMARY};color:#fff;padding:6px 10px;border-radius:8px;text-decoration:none;font-weight:600}
  .koha-assist-muted{opacity:.7}
  .koha-assist-toperr{position:fixed;left:12px;right:12px;top:12px}
  .ka-stat{font-size:12px;opacity:.7;margin-left:8px}
  mark.ka{padding:0 .1em;border-radius:2px;background:rgba(191,152,73,.25)}
  `;
  const style = document.createElement("style"); style.textContent = css;
  document.head.appendChild(style);

  /* ============== GLOBAL ERROR BANNER ============== */
  function showBannerError(msg){
    let c = document.getElementById("ka-toperr");
    if(!c){ c = document.createElement("div"); c.id="ka-toperr"; c.className="koha-assist-toperr"; document.body.appendChild(c); }
    c.innerHTML = `<div class="koha-assist-error">${String(msg||"Unknown error")}</div>`;
  }
  window.addEventListener("error", e => showBannerError("Catalog Assistant error: " + (e.message || e)));
  window.addEventListener("unhandledrejection", e => showBannerError("Catalog Assistant promise error: " + (e.reason?.message || e.reason)));

  /* ================== UI MOUNT ================== */
  const fab = document.createElement("button");
  fab.className = "koha-assist-fab"; fab.title = "Catalog Assistant (Ctrl/Cmd+K)"; fab.textContent = "💬";
  const box = document.createElement("div");
  box.className = "koha-assist-box";
  box.innerHTML = `
    <div class="koha-assist-head">
      <div>Catalog Assistant
        <span id="ka-stat" class="ka-stat"></span>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <input id="ka-author" type="text" placeholder='author:"name"' style="width:180px;padding:6px 8px;border-radius:8px;border:1px solid #e5e9ef'">
        <input id="ka-year"   type="text" placeholder="year:2021" style="width:90px;padding:6px 8px;border-radius:8px;border:1px solid #e5e9ef'">
        <button id="ka-x" title="Close" style="background:none;border:none;color:#fff;font-size:18px;cursor:pointer;line-height:1">×</button>
      </div>
    </div>
    <div class="koha-assist-body" id="ka-body">
      <div class="koha-assist-row" id="ka-status">Loading catalog…</div>
      <div class="koha-assist-row">Type title, author, year — أو اكتب كلمات عربية من العنوان/الملخص/المحتوى.
        <div class="koha-assist-muted" style="margin-top:6px">Filters: <code>author:"name"</code> <code>year:2021</code> • Hotkey: <b>Ctrl/Cmd+K</b></div>
      </div>
    </div>
    <div class="koha-assist-input">
      <input id="ka-q" type="text" placeholder="Search English or Arabic / ابحث بالعربية أو الإنجليزية" dir="auto">
      <button id="ka-go">Search</button>
    </div>
  `;
  document.body.appendChild(fab);
  document.body.appendChild(box);

  const B   = box.querySelector("#ka-body");
  const Q   = box.querySelector("#ka-q");
  const GO  = box.querySelector("#ka-go");
  const X   = box.querySelector("#ka-x");
  const STAT= box.querySelector("#ka-stat");
  const F_A = box.querySelector("#ka-author");
  const F_Y = box.querySelector("#ka-year");

  function setOpenState(open){
    box.style.display = open ? "flex" : "none";
    fab.style.display = "block";
    if (CFG.REMEMBER_STATE) localStorage.setItem("ka-open", open ? "1" : "0");
    if (open) setTimeout(()=>Q.focus(), 50);
  }
  setOpenState((CFG.REMEMBER_STATE && localStorage.getItem("ka-open")==="1") || true);
  fab.onclick = ()=> setOpenState(box.style.display!=="flex");
  X.onclick   = ()=> setOpenState(false);

  if (CFG.OPEN_HOTKEY){
    document.addEventListener("keydown", (e)=>{
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k"){
        e.preventDefault(); setOpenState(true);
      } else if (e.key === "Escape" && box.style.display==="flex"){
        setOpenState(false);
      }
    });
  }

  /* ============= Arabic helpers (robust) ============= */
  const AR_ANY=/[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]/;
  function isArabic(s){ return AR_ANY.test(String(s||"")); }
  function normalizeArabicForms(str){
    if(!str) return "";
    const map={'ﺍ':'ا','ﺎ':'ا','ﺃ':'ا','ﺄ':'ا','ﺇ':'ا','ﺈ':'ا','ٱ':'ا','ﺏ':'ب','ﺐ':'ب','ﺑ':'ب','ﺒ':'ب','ﺕ':'ت','ﺖ':'ت','ﺗ':'ت','ﺘ':'ت','ﺙ':'ث','ﺚ':'ث','ﺛ':'ث','ﺜ':'ث',
      'ﺝ':'ج','ﺞ':'ج','ﺟ':'ج','ﺠ':'ج','ﺡ':'ح','ﺢ':'ح','ﺣ':'ح','ﺤ':'ح','ﺥ':'خ','ﺦ':'خ','ﺧ':'خ','ﺨ':'خ','ﺩ':'د','ﺪ':'د','ﺫ':'ذ','ﺬ':'ذ','ﺭ':'ر','ﺮ':'ر','ﺯ':'ز','ﺰ':'ز',
      'ﺱ':'س','ﺲ':'س','ﺳ':'س','ﺴ':'س','ﺵ':'ش','ﺶ':'ش','ﺷ':'ش','ﺸ':'ش','ﺹ':'ص','ﺺ':'ص','ﺻ':'ص','ﺼ':'ص','ﺽ':'ض','ﺾ':'ض','ﺿ':'ض','ﻀ':'ض','ﻁ':'ط','ﻂ':'ط','ﻃ':'ط','ﻄ':'ط',
      'ﻅ':'ظ','ﻆ':'ظ','ﻇ':'ظ','ﻈ':'ظ','ﻉ':'ع','ﻊ':'ع','ﻋ':'ع','ﻌ':'ع','ﻍ':'غ','ﻎ':'غ','ﻏ':'غ','ﻐ':'غ','ﻑ':'ف','ﻒ':'ف','ﻓ':'ف','ﻔ':'ف','ﻕ':'ق','ﻖ':'ق','ﻗ':'ق','ﻘ':'ق',
      'ﻙ':'ك','ﻚ':'ك','ﻛ':'ك','ﻜ':'ك','ﻝ':'ل','ﻞ':'ل','ﻟ':'ل','ﻠ':'ل','ﻡ':'م','ﻢ':'م','ﻣ':'م','ﻤ':'م','ﻥ':'ن','ﻦ':'ن','ﻧ':'ن','ﻨ':'ن','ﻩ':'ه','ﻪ':'ه','ﻫ':'ه','ﻬ':'ه',
      'ﻭ':'و','ﻮ':'و','ﻱ':'ي','ﻲ':'ي','ﻳ':'ي','ﻴ':'ي','ﻰ':'ى','ﻻ':'لا','ﻼ':'لا'};
    return str.replace(/[\uFE70-\uFEFF\uFB50-\uFDFF]/g, ch=>map[ch]||ch);
  }
  function stripLatinDiacritics(s){ return s.replace(/[\u0300-\u036f]/g,""); }
  function foldDigits(s){ return s.replace(/[\u0660-\u0669]/g,d=>d.charCodeAt(0)-0x0660).replace(/[\u06F0-\u06F9]/g,d=>d.charCodeAt(0)-0x06F0); }
  function norm(s){
    if(!s) return "";
    let t=String(s).toLowerCase();
    try{t=t.normalize("NFKD");}catch(e){}
    t=stripLatinDiacritics(t);
    t=normalizeArabicForms(t);
    t=foldDigits(t);
    return t
      .replace(/[\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06ED\u0640]/g,"")   // tashkīl + tatweel
      .replace(/[\u061C\u200B-\u200F\u202A-\u202E\u2066-\u2069\u00A0\u202F]/g,"") // bidi/zero-width
      .replace(/[إأآٱ]/g,"ا").replace(/[ىی]/g,"ي").replace(/ک/g,"ك");
  }
  const AR_LETTER_ONLY=/[ء-ي]/g;
  function arLettersOnly(s){ const n=norm(s).replace(/ة/g,"ه").replace(/ى/g,"ي"); let out="",m; while((m=AR_LETTER_ONLY.exec(n))!==null) out+=m[0]; return out; }
  function subseq(hay,needle){ if(!needle) return false; let i=0,j=0; while(i<hay.length&&j<needle.length){ if(hay.charCodeAt(i)===needle.charCodeAt(j)) j++; i++; } return j===needle.length; }

  /* ============== TSV loader ============== */
  function setStatus(msg, isErr){
    let el=document.getElementById("ka-status");
    if(!el){ el=document.createElement("div"); el.id="ka-status"; el.className="koha-assist-row"; B.prepend(el); }
    el.className = isErr? "koha-assist-row koha-assist-error" : "koha-assist-row";
    el.textContent = msg;
    if (isErr) showBannerError(msg);
  }
  function parseTSV(text){
    const CONTROL=/[\u061C\u200B-\u200F\u202A-\u202E\u2066-\u2069\u00A0\u202F]/g;
    const lines = text.replace(/\r\n?/g,"\n").split("\n").filter(l=>l.length>0);
    if(!lines.length) return [];
    const headers = lines[0].split("\t").map(h=>String(h).trim().toLowerCase());
    const rows=[];
    for(let i=1;i<lines.length;i++){
      const cols = lines[i].split("\t");
      const obj={};
      for(let c=0;c<headers.length;c++){
        obj[headers[c]] = (cols[c]==null? "": String(cols[c])).replace(CONTROL,"");
      }
      rows.push(obj);
    }
    return rows;
  }
  function mapRecord(k){
    const title   = k["full title"]||k["العنوان"]||k.title||k["ti"]||"";
    const author  = k["author"]||k["المؤلف"]||k["المؤلفون"]||k["au"]||"";
    const summary = k["abstract"]||k["الملخص"]||k["summary"]||"";
    const content = k["content"]||k["المحتوى"]||"";
    const pubdat  = k["publications data"]||k["بيانات النشر"]||k["pub"]||"";
    const url     = k["book_url"]||k["book url"]||k["رابط_الكتاب"]||k["url"]||"";
    const ym = String(pubdat).match(/(\d{4})/);
    const year = ym? ym[1] : "";
    const publisher = String(pubdat||"").replace(/\b\d{4}\b/g,"").replace(/\s*[.,;|-]\s*$/,"").trim();
    return {title,author,summary,content,publisher,year,url};
  }
  function kohaURL(title){
    return location.origin + "/cgi-bin/koha/opac-search.pl?q=" + encodeURIComponent('ti="'+title+'"');
  }
  function highlight(text, terms){
    if (!text) return "";
    let safe = String(text).replace(/</g,"&lt;");
    for(const t of terms){
      if(!t) continue;
      try{
        const re = new RegExp("("+t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+")","gi");
        safe = safe.replace(re, "<mark class='ka'>$1</mark>");
      }catch(_){}
    }
    return safe;
  }
  function render(items, terms){
    const list=document.createElement("div");
    if(!items.length){ list.innerHTML='<div class="koha-assist-row">No results found.</div>'; return list; }
    for(const it of items){
      const r=it.raw;
      const url = (r.url && /^https?:\/\//i.test(r.url)) ? r.url : kohaURL(r.title||"");
      const pub = [r.publisher, r.year].filter(Boolean).join(" • ");
      const div=document.createElement("div"); div.className="koha-assist-row";
      div.dir = isArabic((r.title||"")+(r.summary||"")+(r.content||"")+(r.author||"")) ? "rtl" : "ltr";
      div.innerHTML =
        '<div style="display:flex;justify-content:space-between;gap:8px;align-items:center;">' +
          '<b style="font-size:15px;line-height:1.3">'+ highlight((r.title||""), terms) +'</b>' +
          '<a class="koha-assist-btn" href="'+url+'" target="_blank" rel="noopener">Open record</a>' +
        '</div>' +
        (r.author? '<div class="koha-assist-meta">'+(isArabic(r.author)?'المؤلف: ':'Author: ')+ highlight(r.author, terms) +'</div>' : '') +
        (pub? '<div class="koha-assist-meta">'+pub+'</div>' : '') +
        (r.summary? '<div style="margin-top:6px">'+ highlight(r.summary.length>360? r.summary.slice(0,357)+'…' : r.summary, terms) +'</div>' : '') +
        (r.content? '<div style="margin-top:6px;opacity:.9">'+ highlight(r.content.length>360? r.content.slice(0,357)+'…' : r.content, terms) +'</div>' : '');
      list.appendChild(div);
    }
    return list;
  }

  /* ============== SEARCH PIPELINE ============== */
  function parseFilters(q, authorBox, yearBox){
    // priority to visible inputs; fallback to inline filters in query
    let aIn = (authorBox.value||"").trim();
    let yIn = (yearBox.value||"").trim();
    const aMatch = q.match(/author:\s*"([^"]+)"/i) || q.match(/author:\s*([^\s]+)/i);
    const yMatch = q.match(/year:\s*(\d{4})/i);
    const author = aIn || (aMatch ? aMatch[1] : "");
    const year   = yIn || (yMatch ? yMatch[1] : "");
    const cleaned = q.replace(/author:\s*".*?"/ig,"").replace(/author:\s*[^\s]+/ig,"").replace(/year:\s*\d{4}/ig,"").trim();
    return {author, year, cleaned};
  }
  function search(idx, q, authorBox, yearBox, limit){
    q = (q||"").trim();
    if (q.length < CFG.MIN_QUERY_LEN && !(authorBox.value||yearBox.value)) return [];
    const F = parseFilters(q, authorBox, yearBox);

    const terms = F.cleaned.split(/\s+/).filter(Boolean);
    const nTerms = terms.map(norm);
    const aQuery = arLettersOnly(F.cleaned);

    // Stage 1: ranked scoring (normalized)
    const out = [];
    for (const rec of idx){
      if (F.author && norm(rec.raw.author).indexOf(norm(F.author)) === -1) continue;
      if (F.year && String(rec.raw.year||"") !== String(F.year)) continue;

      let sc = 0, matched = false;
      for (const qt of nTerms){
        if (!qt) continue;
        if (rec.nTitle.indexOf(qt)   !== -1) { sc += 5; matched = true; }
        if (rec.nSummary.indexOf(qt) !== -1) { sc += 2; matched = true; }
        if (rec.nContent.indexOf(qt) !== -1) { sc += 2; matched = true; }
      }
      if (!terms.length && (F.author || F.year)) { sc += 1; matched = true; }
      if (matched) out.push({sc, raw:rec.raw});
    }
    out.sort((a,b)=>b.sc-a.sc);
    if (out.length) return out.slice(0, limit||CFG.MAX_RESULTS);

    // Stage 2: Arabic letters-only (contiguous or subsequence)
    if (aQuery){
      const hits = [];
      for (const r of idx){
        if (F.author && norm(r.raw.author).indexOf(norm(F.author)) === -1) continue;
        if (F.year && String(r.raw.year||"") !== String(F.year)) continue;
        const aAll = r.aAll; if (!aAll) continue;
        if (aAll.indexOf(aQuery) !== -1 ||
            subseq(aAll, aQuery) ||
            subseq(aAll, aQuery.replace(/ه/g,"ة")) ||
            subseq(aAll, aQuery.replace(/ي/g,"ى"))) {
          hits.push({sc:0.7, raw:r.raw});
        }
      }
      if (hits.length) return hits.slice(0, limit||CFG.MAX_RESULTS);
    }

    // Stage 3: simple regex tolerant to gaps
    const letters = (norm(F.cleaned).replace(/\s+/g,"").match(/[ء-ي]/g))||[];
    if (letters.length){
      const pattern = letters.join("[\\s\\S]{0,40}?");
      const re = new RegExp(pattern, "u");
      const hits = [];
      for (const r of idx){
        const hay = normalizeArabicForms(r.rawAll||"");
        if (re.test(hay)) hits.push({sc:0.6, raw:r.raw});
      }
      if (hits.length) return hits.slice(0, limit||CFG.MAX_RESULTS);
    }
    return [];
  }

  /* ============== LOAD + INDEX ============== */
  let INDEX = [];
  let RAW_COUNT = 0, AR_COUNT = 0;
  let lastSearchTs = 0;

  function doRender(res, terms, ms){
    // clear (keep first info rows)
    while (B.children.length > 1) B.removeChild(B.lastChild);
    B.appendChild(render(res, terms));
    STAT.textContent = `Loaded: ${RAW_COUNT} (AR: ${AR_COUNT}) • Results: ${res.length} • ${ms} ms`;
  }

  function runSearch(){
    const t0 = performance.now();
    const q = Q.value.trim();
    const res = search(INDEX, q, F_A, F_Y, CFG.MAX_RESULTS);
    const terms = q.split(/\s+/).filter(Boolean);
    const t1 = performance.now();
    doRender(res, terms, Math.round(t1 - t0));
  }

  // Debounce
  let timer = null;
  function scheduleSearch(){
    clearTimeout(timer);
    timer = setTimeout(runSearch, 160);
  }

  Q.addEventListener("input", scheduleSearch);
  Q.addEventListener("keydown", (e)=>{ if(e.key==="Enter") runSearch(); });
  GO.onclick = runSearch;

  // Load TSV
  fetch(CFG.DATA_URL, {cache:"reload"})
    .then(r=>{ if(!r.ok) throw new Error("HTTP "+r.status); return r.text(); })
    .then(text=>{
      window.__lastTSV__ = text; // for optional auto-reload extensions
      const rows = parseTSV(text);
      if(!rows.length) throw new Error("Empty .tab file");
      const records = rows.map(mapRecord);

      INDEX = records.map((r,i)=>{
        const rawAll=(r.title+" "+r.author+" "+r.summary+" "+r.content+" "+r.publisher+" "+r.year).trim();
        return {
          id:i, raw:r,
          rawAll,
          nTitle:norm(r.title), nSummary:norm(r.summary), nContent:norm(r.content),
          aAll:arLettersOnly(rawAll)
        };
      });

      RAW_COUNT = records.length;
      AR_COUNT  = records.filter(r => AR_ANY.test((r.title||"")+(r.author||"")+(r.summary||"")+(r.content||""))).length;
      setStatus(`Catalog loaded • ${RAW_COUNT} records (Arabic rows: ${AR_COUNT}) • Ready`);

      // sample on load
      const sample = records.slice(0,3).map(r=>({raw:r,sc:1}));
      B.appendChild(render(sample, [], 0));
    })
    .catch(err=>{
      console.error(err);
      setStatus("Catalog Assistant init failed: "+(err?.message||err), true);
    });

})();
