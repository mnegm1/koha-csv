<!DOCTYPE html>
<html lang="ar" dir="auto">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Koha TSV Search — ECSSR AI Assistant (Full)</title>
<style>
  :root{
    --brand:#BF9849; --brandText:#fff;
    --logo-url:url("https://assets.almanhal.com/platform/shared/Product/ECSSR/middlelogo.png");
    --logo-size:130%; --fab-size:56px;
    --box-width:520px; --box-max-h:72vh;
  }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#F3EFED;margin:0;padding:2rem}
  .fab-wrap{position:fixed; right:18px; bottom:18px; z-index:9999; width:var(--fab-size); height:calc(var(--fab-size)+36px)}
  .fab-label{position:absolute; left:50%; bottom:calc(var(--fab-size)+4px); transform:translateX(-50%);
    width:calc(var(--fab-size)+36px); height:34px; pointer-events:none;
    filter:drop-shadow(0 1px 0 rgba(255,255,255,.65))}
  .fab-label text{ fill:var(--brand); font-weight:700; font-size:12px; letter-spacing:.5px }
  .fab{position:absolute; left:0; bottom:0; width:var(--fab-size); height:var(--fab-size);
    background:#fff var(--logo-url) center/var(--logo-size) no-repeat; border:4px solid #BF9849;
    border-radius:50%; cursor:pointer; box-shadow:0 8px 20px rgba(0,0,0,.25)}
  .box{position:fixed; right:18px; bottom:calc(18px + var(--fab-size) + 12px);
    width:min(var(--box-width),94vw); max-height:var(--box-max-h);
    background:#fff; border-radius:14px; border:1px solid #e8eef3;
    box-shadow:0 16px 40px rgba(0,0,0,.25); display:none; flex-direction:column; overflow:hidden; z-index:9999}
  .head{background:#BF9849;color:#fff;padding:10px 14px;font-weight:600;display:flex;justify-content:space-between;align-items:center}
  .status{font-size:12px;opacity:.85;padding:8px 12px;background:#fafafa;border-bottom:1px solid #e8eef3}
  .body{padding:10px;overflow:auto;max-height:calc(var(--box-max-h) - 172px);font-size:14px}
  .row{background:#f6f9fc;border:1px solid #e7edf4;border-radius:12px;padding:12px;margin:10px 0}
  .meta{opacity:.85;font-size:12px;margin-top:6px}
  .input{display:flex;gap:8px;padding:10px;background:#fafafa;border-top:1px solid #e8eef3}
  .input input{flex:1;padding:10px;border-radius:10px;border:1px solid #cfd9e3}
  .input button{background:#BF9849;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:600}
  .btn{flex:0 0 auto;background:#BF9849;color:#fff;padding:6px 10px;border-radius:8px;text-decoration:none;font-weight:600}
  .btn[disabled]{opacity:.5; cursor:not-allowed}
  .more-row{display:flex;justify-content:center;margin-top:6px}
  .more-row button{background:#BF9849;color:#fff;border:none;border-radius:10px;padding:8px 14px;font-weight:700;cursor:pointer}
  .error{background:#fff0f0;border:1px solid #f5b5b5;color:#900;padding:10px}
  .busybar{display:none; align-items:center; gap:10px; padding:8px 12px; background:#fff; border-bottom:1px solid #e8eef3}
  .box.busy .busybar{display:flex}
  .spinner{
    width:32px;height:32px;border-radius:50%;
    background:#fff var(--logo-url) center/90% no-repeat;
    border:3px solid rgba(0,0,0,.06); box-shadow:0 2px 8px rgba(0,0,0,.12);
    animation:ka-spin 1s linear infinite
  }
  @keyframes ka-spin{to{transform:rotate(360deg)}}
  .busytext{font-weight:600;color:#555}
</style>
</head>
<body>
  <div class="fab-wrap">
    <svg class="fab-label" viewBox="0 0 120 40"><defs><path id="ka-arc" d="M 10,34 A 50,50 0 0 1 110,34"/></defs>
      <text text-anchor="middle"><textPath href="#ka-arc" startOffset="50%">AI Assist</textPath></text>
    </svg>
    <button class="fab" aria-label="AI Assistant" id="fab"></button>
  </div>

  <div class="box" id="box">
    <div class="head">
      <div>AI Assistant</div>
      <button id="x" style="background:none;border:none;color:#fff;font-size:18px;cursor:pointer" title="Close">×</button>
    </div>

    <div class="busybar" id="busybar" aria-live="polite">
      <div class="spinner" title="Working…"></div>
      <div class="busytext" id="busytext">Loading…</div>
    </div>

    <div class="status" id="status">Loading…</div>
    <div class="body" id="body"></div>
    <div class="input">
      <input id="q" type="text" placeholder="اكتب: اسم مؤلف / عنوان / موضوع / سنة (مثال: 2019)" dir="auto">
      <button id="go">Search</button>
    </div>
  </div>

<script>
/* ====== CONFIG ====== */
const DRIVE_ID = "1ctz6U5HphC3fCl00TTWWNclIRTEl1hNf";
const DATA_URLS = [
  `https://drive.usercontent.google.com/download?id=${DRIVE_ID}&delim=tab`,
  `https://drive.google.com/uc?export=download&id=${DRIVE_ID}&delim=tab`
];
const PAGE_SIZE = 12;

/* ====== Fetch fallback ====== */
async function fetchFirstWorking(urls){
  let lastErr;
  for(const u of urls){
    try{
      const r = await fetch(u + `&v=${Date.now()}`, {cache:"no-store"});
      if(!r.ok) throw new Error(`${r.status} ${r.statusText}`);
      return await r.arrayBuffer();
    }catch(e){ lastErr = e; }
  }
  throw lastErr || new Error("All sources failed");
}

/* ====== Busy indicator ====== */
function setBusy(on, label){
  const bar=document.getElementById('busybar');
  const txt=document.getElementById('busytext');
  const btn=document.getElementById('go');
  const Q=document.getElementById('q');
  if(label) txt.textContent=label;
  if(on){box.classList.add('busy');bar.style.display='flex';btn.disabled=Q.disabled=true;}
  else{box.classList.remove('busy');bar.style.display='none';btn.disabled=Q.disabled=false;}
}

/* ====== Banner ====== */
function banner(msg){
  let el=document.getElementById("top-error");
  if(!el){el=document.createElement("div");el.id="top-error";el.className="error";document.body.prepend(el);}
  el.textContent=String(msg||"Unknown error");
}

/* ====== Arabic helpers ====== */
function stripBidi(s){return String(s||"").replace(/[\u200E\u200F\u202A-\u202E]/g,"");}
function clean(s){return stripBidi(String(s||"").replace(/^\uFEFF/,""));}
function norm(s){
  if(!s)return"";s=clean(s).toLowerCase();
  s=s.replace(/[إأآٱ]/g,"ا").replace(/[ىی]/g,"ي").replace(/ة/g,"ه").replace(/ک/g,"ك")
     .replace(/\bعبد\s+ال/g,"عبدال")
     .replace(/[\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06ED\u0640]/g,"")
     .replace(/[\u0660-\u0669]/g,d=>d.charCodeAt(0)-0x0660)
     .replace(/[\u06F0-\u06F9]/g,d=>d.charCodeAt(0)-0x06F0)
     .replace(/[^\p{L}\p{N}\s]/gu," ").replace(/\s+/g," ").trim();
  return s;
}
function normForPhrase(s){return norm(s).replace(/[،,;]/g," ").replace(/\s+/g," ").trim();}
function isArabic(s){return /[\u0600-\u06FF]/.test(s||"");}

/* ====== Loader ====== */
let INDEX=[];
async function ensureLoaded(){
  if(INDEX.length) return;
  setBusy(true,"Loading records…");
  try{
    const buf=await fetchFirstWorking(DATA_URLS);
    const text=new TextDecoder("utf-8").decode(buf);
    const lines=text.split(/\r?\n/);
    const headers=lines[0].split("\t").map(h=>h.trim().toLowerCase());
    INDEX=lines.slice(1).map(l=>{
      const cols=l.split("\t");const o={};
      headers.forEach((h,i)=>o[h]=cols[i]||"");return o;
    });
    STATUS.textContent=`Loaded ${INDEX.length} records`;
  }catch(e){banner("Load error: "+e.message);STATUS.textContent="Load error";}
  finally{setBusy(false);}
}

/* ====== Search ====== */
function search(q){
  const nq=norm(q);
  if(!nq) return [];
  return INDEX.filter(r=>Object.values(r).some(v=>norm(v).includes(nq)))
              .map(r=>({raw:r}));
}

/* ====== Render ====== */
const B=document.getElementById("body");
function clearResults(){while(B.firstChild)B.removeChild(B.firstChild);}
function renderChunk(items){
  const frag=document.createDocumentFragment();
  for(const it of items){
    const r=it.raw,div=document.createElement("div");
    div.className="row";
    const title=r["full title"]||r.title||"(بدون عنوان)";
    const author=r.author||r["المؤلف"]||"";
    const abstract=r.abstract||r["الملخص"]||"";
    div.innerHTML=`<b>${title}</b>${author?`<div class='meta'>${author}</div>`:""}<div>${abstract}</div>`;
    frag.appendChild(div);
  }
  B.appendChild(frag);
}

/* ====== Show more ====== */
let LAST={items:[],shown:0};
function addShowMoreIfNeeded(){
  const old=document.getElementById("ka-more");if(old)old.remove();
  if(LAST.shown>=LAST.items.length)return;
  const row=document.createElement("div");row.id="ka-more";row.className="more-row";
  const btn=document.createElement("button");
  const remaining=LAST.items.length-LAST.shown;
  btn.textContent=remaining>PAGE_SIZE?"Show more":"Show all";
  btn.onclick=()=>{
    const next=Math.min(LAST.shown+PAGE_SIZE,LAST.items.length);
    renderChunk(LAST.items.slice(LAST.shown,next));
    LAST.shown=next;addShowMoreIfNeeded();
  };
  row.appendChild(btn);B.appendChild(row);
}

function renderAll(list){
  clearResults();
  if(!list.length){B.textContent="No results.";return;}
  LAST.items=list;LAST.shown=Math.min(PAGE_SIZE,list.length);
  renderChunk(list.slice(0,LAST.shown));
  addShowMoreIfNeeded();
}

/* ====== Run ====== */
async function run(){
  setBusy(true,"Searching…");
  try{
    await ensureLoaded();
    const raw=document.getElementById("q").value.trim();
    if(!raw){setBusy(false);return;}
    const res=search(raw);
    renderAll(res);
  }finally{setBusy(false);}
}

/* ====== UI ====== */
const fab=document.getElementById("fab");
const box=document.getElementById("box");
const closeBtn=document.getElementById("x");
const Q=document.getElementById("q");
fab.onclick=()=>{
  box.style.display=(box.style.display==="flex"?"none":"flex");
  if(box.style.display==="flex"){setBusy(true,"Initializing…");ensureLoaded().then(()=>setBusy(false));setTimeout(()=>Q.focus(),50);}
};
closeBtn.onclick=()=>{box.style.display="none";};
document.getElementById("go").onclick=run;
Q.addEventListener("keydown",e=>{if(e.key==="Enter")run();});
ensureLoaded();
</script>
</body>
</html>
