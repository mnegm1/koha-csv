<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Koha ODS Chatbot â€” Arabic solid</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#F3EFED;padding:2rem}
    .fab{position:fixed;right:18px;bottom:18px;background:#3EA3DC;color:#fff;border:none;border-radius:50%;
         width:56px;height:56px;font-size:24px;cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,.25);z-index:9999}
    .box{position:fixed;right:18px;bottom:86px;width:min(520px,92vw);max-height:70vh;background:#fff;border-radius:14px;
         border:1px solid #e8eef3;box-shadow:0 16px 40px rgba(0,0,0,.25);display:flex;flex-direction:column;overflow:hidden;z-index:9999}
    .head{background:#BF9849;color:#fff;padding:10px 14px;font-weight:600;display:flex;justify-content:space-between}
    .body{padding:10px;overflow:auto;max-height:56vh;font-size:14px}
    .row{background:#f6f9fc;border:1px solid #e7edf4;border-radius:12px;padding:12px;margin:10px 0}
    .meta{opacity:.85;font-size:12px;margin-top:6px}
    .input{display:flex;gap:8px;padding:10px;background:#fafafa;border-top:1px solid #e8eef3}
    .input input{flex:1;padding:10px;border-radius:10px;border:1px solid #cfd9e3}
    .input button{background:#3EA3DC;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:600}
    .error{background:#fff0f0;border:1px solid #f5b5b5;color:#900;padding:10px}
    .btn{flex:0 0 auto;background:#3EA3DC;color:#fff;padding:6px 10px;border-radius:8px;text-decoration:none;font-weight:600}
  </style>

  <!-- SheetJS loader (tries local then CDNs) -->
  <script>
  (function loadSheetJS(){
    var sources = [
      "/koha-csv/xlsx.full.min.js",
      "https://mnegm1.github.io/koha-csv/xlsx.full.min.js",
      "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.20.3/xlsx.full.min.js",
      "https://cdn.jsdelivr.net/npm/xlsx@0.20.3/dist/xlsx.full.min.js",
      "https://unpkg.com/xlsx@0.20.3/dist/xlsx.full.min.js"
    ];
    var i = 0;
    function tryNext(){
      if (i >= sources.length) { window.__XLSX_LOAD_ERROR__ = "All sources failed"; return; }
      var s = document.createElement("script");
      s.src = sources[i++]; s.async = true;
      s.onload  = function(){ window.__XLSX_READY__ = true; };
      s.onerror = tryNext;
      document.head.appendChild(s);
    }
    tryNext();
  })();
  </script>
</head>
<body>
  <h2>Koha ODS Chatbot</h2>
  <p>This page loads the ODS catalog and adds the chat bubble ğŸ’¬ automatically.</p>

  <script>
  (function startWhenReady(){
    if (window.__XLSX_LOAD_ERROR__) {
      var pre = document.createElement("div");
      pre.className = "error";
      pre.textContent = "Failed to load XLSX library.";
      document.body.appendChild(pre);
      return;
    }
    if (!window.__XLSX_READY__) { setTimeout(startWhenReady, 150); return; }

    /* ===== CONFIG ===== */
    var BOT_CFG = {
      DATA_URL: "https://raw.githubusercontent.com/mnegm1/koha-csv/main/opac-catalog.ods",
      MAX_RESULTS: 12,
      MIN_QUERY_LEN: 1,
      KOHA_OPAC_BASE: location.origin
    };

    /* ===== UI ===== */
    var fab=document.createElement("button"); fab.className="fab"; fab.textContent="ğŸ’¬";
    var box=document.createElement("div"); box.className="box";
    box.innerHTML='' +
      '<div class="head">' +
        '<div>Catalog Assistant</div>' +
        '<button id="x" style="background:none;border:none;color:#fff;font-size:18px;cursor:pointer">Ã—</button>' +
      '</div>' +
      '<div class="body" id="body">' +
        '<div class="row" id="status">Loading catalogâ€¦</div>' +
        '<div class="row">Type title, author, year â€” Ø£Ùˆ Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø§Øª Ø¹Ø±Ø¨ÙŠØ© Ù…Ù† Ø§Ù„Ø¹Ù†ÙˆØ§Ù†/Ø§Ù„Ù…Ù„Ø®Øµ/Ø§Ù„Ù…Ø­ØªÙˆÙ‰. ÙÙ„Ø§ØªØ±: author:"name"  year:2021</div>' +
      '</div>' +
      '<div class="input">' +
        '<input id="q" type="text" placeholder="Search / Ø§Ø¨Ø­Ø«" dir="auto">' +
        '<button id="go">Search</button>' +
      '</div>';
    document.body.appendChild(fab); document.body.appendChild(box);
    var B = box.querySelector("#body"), Q = box.querySelector("#q"), GO = box.querySelector("#go");
    var closeBtn = box.querySelector("#x");
    fab.onclick = function(){ box.style.display = (box.style.display==="flex" ? "none" : "flex"); };
    closeBtn.onclick = function(){ box.style.display = "none"; };
    box.style.display = "flex"; Q.focus();

    /* ===== Arabic helpers ===== */
    var AR_ANY = /[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]/;
    function isArabic(s){ return AR_ANY.test(String(s||"")); }

    function normalizeArabicForms(str){
      if(!str) return "";
      var map = {
        'ïº':'Ø§','ïº':'Ø§','ïºƒ':'Ø§','ïº„':'Ø§','ïº‡':'Ø§','ïºˆ':'Ø§','Ù±':'Ø§',
        'ï»·':'Ù„Ø§','ï»¹':'Ù„Ø§','ï»µ':'Ù„Ø§','ï»»':'Ù„Ø§','ï»¼':'Ù„Ø§',
        'ïº':'Ø¨','ïº':'Ø¨','ïº‘':'Ø¨','ïº’':'Ø¨','ïº•':'Øª','ïº–':'Øª','ïº—':'Øª','ïº˜':'Øª',
        'ïº™':'Ø«','ïºš':'Ø«','ïº›':'Ø«','ïºœ':'Ø«','ïº':'Ø¬','ïº':'Ø¬','ïºŸ':'Ø¬','ïº ':'Ø¬',
        'ïº¡':'Ø­','ïº¢':'Ø­','ïº£':'Ø­','ïº¤':'Ø­','ïº¥':'Ø®','ïº¦':'Ø®','ïº§':'Ø®','ïº¨':'Ø®',
        'ïº©':'Ø¯','ïº«':'Ø°','ïº­':'Ø±','ïº¯':'Ø²','ïº±':'Ø³','ïº²':'Ø³','ïº³':'Ø³','ïº´':'Ø³',
        'ïºµ':'Ø´','ïº¶':'Ø´','ïº·':'Ø´','ïº¸':'Ø´','ïº¹':'Øµ','ïºº':'Øµ','ïº»':'Øµ','ïº¼':'Øµ',
        'ïº½':'Ø¶','ïº¾':'Ø¶','ïº¿':'Ø¶','ï»€':'Ø¶','ï»':'Ø·','ï»‚':'Ø·','ï»ƒ':'Ø·','ï»„':'Ø·',
        'ï»…':'Ø¸','ï»†':'Ø¸','ï»‡':'Ø¸','ï»ˆ':'Ø¸','ï»‰':'Ø¹','ï»Š':'Ø¹','ï»‹':'Ø¹','ï»Œ':'Ø¹',
        'ï»':'Øº','ï»':'Øº','ï»':'Øº','ï»':'Øº','ï»‘':'Ù','ï»’':'Ù','ï»“':'Ù','ï»”':'Ù',
        'ï»•':'Ù‚','ï»–':'Ù‚','ï»—':'Ù‚','ï»˜':'Ù‚','ï»™':'Ùƒ','ï»š':'Ùƒ','ï»›':'Ùƒ','ï»œ':'Ùƒ',
        'ï»':'Ù„','ï»':'Ù„','ï»Ÿ':'Ù„','ï» ':'Ù„','ï»¡':'Ù…','ï»¢':'Ù…','ï»£':'Ù…','ï»¤':'Ù…',
        'ï»¥':'Ù†','ï»¦':'Ù†','ï»§':'Ù†','ï»¨':'Ù†','ï»©':'Ù‡','ï»ª':'Ù‡','ï»«':'Ù‡','ï»¬':'Ù‡',
        'ï»­':'Ùˆ','ï»®':'Ùˆ','ï»±':'ÙŠ','ï»²':'ÙŠ','ï»³':'ÙŠ','ï»´':'ÙŠ','ï»°':'Ù‰'
      };
      return str.replace(/[\uFE70-\uFEFF\uFB50-\uFDFF]/g, function(ch){ return map[ch] || ch; });
    }
    function stripLatinDiacritics(s){ return s.replace(/[\u0300-\u036f]/g,""); }
    function foldDigits(s){
      return s
        .replace(/[\u0660-\u0669]/g, d => d.charCodeAt(0) - 0x0660)
        .replace(/[\u06F0-\u06F9]/g, d => d.charCodeAt(0) - 0x06F0);
    }

    // Strong normalizer (safe for both EN + AR)
    function norm(s){
      if (!s) return "";
      var t = String(s);
      try { t = t.normalize("NFKC"); } catch(e){}
      t = t.toLowerCase();
      t = stripLatinDiacritics(t);
      t = normalizeArabicForms(t);
      t = foldDigits(t);
      t = t
        // tashkÄ«l + tatweel
        .replace(/[\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06ED\u0640]/g,"")
        // zero-width / bidi / NBSPs
        .replace(/[\u061C\u2000-\u200F\u202A-\u202E\u2066-\u2069\u00A0\u202F]/g,"")
        // unify base letters
        .replace(/[Ø¥Ø£Ø¢Ù±]/g,"Ø§").replace(/[Ù‰ÛŒ]/g,"ÙŠ").replace(/Ú©/g,"Ùƒ").replace(/Ø¤|Ø¦/g,"Ùˆ");
      return t.trim();
    }

    var AR_LETTER_ONLY = /[Ø¡-ÙŠ]/g;
    function arLettersOnly(s){
      var n = norm(s).replace(/Ø©/g,"Ù‡").replace(/Ù‰/g,"ÙŠ");
      var out = "", m;
      while ((m = AR_LETTER_ONLY.exec(n)) !== null) out += m[0];
      return out;
    }

    function subseq(hay, needle){
      if (!needle) return false;
      var i=0, j=0;
      while (i<hay.length && j<needle.length){
        if (hay.charCodeAt(i) === needle.charCodeAt(j)) j++;
        i++;
      }
      return j === needle.length;
    }

    function reEscape(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
    function arAltClass(ch){
      if (ch === 'Ù‡' || ch === 'Ø©') return '(?:Ù‡|Ø©)';
      if (ch === 'ÙŠ' || ch === 'Ù‰' || ch === 'ÛŒ') return '(?:ÙŠ|Ù‰|ÛŒ)';
      if (ch === 'Ùƒ' || ch === 'Ú©') return '(?:Ùƒ|Ú©)';
      if ('Ø§Ø£Ø¥Ø¢Ù±'.includes(ch)) return '(?:Ø§|Ø£|Ø¥|Ø¢|Ù±)';
      return reEscape(ch);
    }
    function makeArabicLooseRegex(q){
      var qn = normalizeArabicForms(String(q||''))
                .replace(/[\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06ED\u0640]/g,'')
                .replace(/[\u061C\u2000-\u200F\u202A-\u202E\u2066-\u2069\u00A0\u202F]/g,'')
                .replace(/\s+/g,'')
                .trim();
      if (!qn) return null;
      var letters = qn.match(/[\u0621-\u064A\u066E\u066F\u0671-\u06D3\u06FA-\u06FF]/g) || qn.split('');
      var parts = [];
      for (var i=0;i<letters.length;i++) parts.push(arAltClass(letters[i]));
      var pattern = parts.join('[\\s\\S]{0,60}?'); // allow up to 60 chars between letters
      try { return new RegExp(pattern, 'iu'); } catch(e) { return null; }
    }
    function arabicRegexSweep(idx, q, limit){
      var re = makeArabicLooseRegex(q);
      if (!re) return [];
      var out = [];
      for (var i=0;i<idx.length;i++){
        var r = idx[i];
        if (re.test(r.nAll) || re.test(r.rawAll)) {
          out.push({sc:0.6, raw:r.raw});
          if (out.length >= (limit||12)) break;
        }
      }
      return out;
    }

    function setStatus(msg, err){
      var el=document.getElementById("status");
      if(!el) return; el.className = err ? "row error" : "row"; el.textContent = msg;
    }

    function kohaURL(title){
      if (!BOT_CFG.KOHA_OPAC_BASE) return "#";
      return BOT_CFG.KOHA_OPAC_BASE + "/cgi-bin/koha/opac-search.pl?q=" + encodeURIComponent('ti="'+title+'"');
    }

    function render(items){
      var list=document.createElement("div");
      if(!items.length){ list.innerHTML='<div class="row">No results found.</div>'; return list; }
      for(var i=0;i<items.length;i++){
        var r=items[i].raw;
        var url = (r.url && /^https?:\/\//i.test(r.url)) ? r.url : kohaURL(r.title||"");
        var pub = [r.publisher, r.year].filter(Boolean).join(" â€¢ ");
        var div=document.createElement("div"); div.className="row";
        div.dir = isArabic((r.title||"")+(r.summary||"")+(r.content||"")+(r.author||"")) ? "rtl" : "ltr";
        div.innerHTML =
          '<div style="display:flex;justify-content:space-between;gap:8px;align-items:center;">' +
            '<b style="font-size:15px;line-height:1.3">'+ String(r.title||"").replace(/</g,"&lt;") +'</b>' +
            '<a class="btn" href="'+url+'" target="_blank" rel="noopener">Open record</a>' +
          '</div>' +
          (r.author? '<div class="meta">'+(isArabic(r.author)?'Ø§Ù„Ù…Ø¤Ù„Ù: ':'Author: ')+r.author+'</div>' : '') +
          (pub? '<div class="meta">'+pub+'</div>' : '') +
          (r.summary? '<div style="margin-top:6px">'+ (r.summary.length>360? r.summary.slice(0,357)+'â€¦' : r.summary) +'</div>' : '') +
          (r.content? '<div style="margin-top:6px;opacity:.9">'+ (r.content.length>360? r.content.slice(0,357)+'â€¦' : r.content) +'</div>' : '');
        list.appendChild(div);
      }
      return list;
    }

    /* ===== Load ODS, coerce RichText â†’ clean strings ===== */
    var INDEX=[];
    fetch(BOT_CFG.DATA_URL,{cache:"reload"})
      .then(function(r){ if(!r.ok) throw new Error("HTTP "+r.status); return r.arrayBuffer(); })
      .then(function(buf){
        var wb = XLSX.read(buf,{type:"array"});
        var ws = wb.Sheets["catalog"] || wb.Sheets[wb.SheetNames[0]];
        if(!ws) throw new Error("No sheets in ODS");

        var raw = XLSX.utils.sheet_to_json(ws,{defval:"", raw:true});

        function cellStr(v){
          if (v == null) return "";
          if (typeof v === "string") return v;
          if (typeof v === "number" || typeof v === "boolean") return String(v);
          if (Array.isArray(v)) return v.map(cellStr).join(" ");
          if (typeof v === "object") {
            if (v.richText && Array.isArray(v.richText)) return v.richText.map(rt => (rt && (rt.text||rt.t||""))).join("");
            if (v.text != null) return String(v.text);
            if (v.w    != null) return String(v.w);
            if (v.v    != null) return String(v.v);
            if (v.t    != null) return String(v.t);
          }
          try { return String(v); } catch(e){ return ""; }
        }
        function cleanSpaces(s){
          return String(s).replace(/\u00A0|\u202F|\u2007/g,' ').replace(/\s+/g,' ').trim();
        }

        var rows = raw.map(function(row){
          var k = {};
          for (var key in row) if (Object.prototype.hasOwnProperty.call(row,key)){
            k[String(key).trim().toLowerCase()] = cleanSpaces(cellStr(row[key]));
          }
          return k;
        });

        var records = rows.map(function(k){
          var title   = k["full title"] || k["Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"] || k.title || "";
          var author  = k["author"] || k["Ø§Ù„Ù…Ø¤Ù„Ù"] || k["Ø§Ù„Ù…Ø¤Ù„ÙÙˆÙ†"] || "";
          var summary = k["abstract"] || k["Ø§Ù„Ù…Ù„Ø®Øµ"] || "";
          var content = k["content"] || k["Ø§Ù„Ù…Ø­ØªÙˆÙ‰"] || "";
          var pubdat  = k["publications data"] || k["Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø±"] || "";
          var url     = k["book_url"] || k["book url"] || k["Ø±Ø§Ø¨Ø·_Ø§Ù„ÙƒØªØ§Ø¨"] || k.url || "";

          var ym = String(pubdat).match(/(\d{4})/);
          var year  = ym ? ym[1] : "";
          var publisher = String(pubdat||"").replace(/\b\d{4}\b/g,"").replace(/\s*[.,;|-]\s*$/,"").trim();

          return { title:title, author:author, summary:summary, content:content, publisher:publisher, year:year, url:url };
        });

        INDEX = records.map(function(r, i){
          var rawAll = (r.title+" "+r.author+" "+r.summary+" "+r.content+" "+r.publisher+" "+r.year).trim();
          var nAll   = norm(rawAll);
          return {
            id:i,
            raw:r,
            rawAll: rawAll,
            nAll:   nAll,
            aAll:   arLettersOnly(rawAll),
            nTitle: norm(r.title),
            nSummary: norm(r.summary),
            nContent: norm(r.content),
            aTitle: arLettersOnly(r.title),
            aSummary: arLettersOnly(r.summary),
            aContent: arLettersOnly(r.content)
          };
        });

        var arabicCount = records.filter(function(r){
          return AR_ANY.test((r.title||"")+(r.author||"")+(r.summary||"")+(r.content||""));
        }).length;

        setStatus("Loaded "+records.length+" records (Arabic rows: "+arabicCount+")");

        var sample = render(records.slice(0,3).map(function(r){ return {raw:r,sc:1}; }));
        B.appendChild(sample);
      })
      .catch(function(err){ console.error(err); setStatus("Chatbot init failed: "+err.message, true); });

    /* ===== Search pipeline ===== */
    function parseFilters(q){
      var aMatch = q.match(/author:\s*"([^"]+)"/i) || q.match(/author:\s*([^\s]+)/i);
      var yMatch = q.match(/year:\s*(\d{4})/i);
      var a = aMatch ? aMatch[1] : "";
      var y = yMatch ? yMatch[1] : "";
      var cleaned = q.replace(/author:\s*".*?"/ig,"").replace(/author:\s*[^\s]+/ig,"").replace(/year:\s*\d{4}/ig,"").trim();
      return {author:a, year:y, cleaned:cleaned};
    }

    function icuTokens(s){
      try{
        var seg = new Intl.Segmenter('ar',{granularity:'word'});
        var out=[]; for (const it of seg.segment(norm(s))) if (it.isWordLike) out.push(it.segment);
        return out;
      }catch(e){ return norm(s).split(/\s+/).filter(Boolean); }
    }

    function search(idx, q, limit){
      q = (q||"").trim();
      if (q.length < BOT_CFG.MIN_QUERY_LEN) return [];
      var F = parseFilters(q);

      var cleaned = F.cleaned;
      var nq = norm(cleaned);
      var terms = nq.split(/\s+/).filter(Boolean);
      var aQuery = arLettersOnly(cleaned); // Arabic letters-only query

      // Stage 0: FILTERS pre-normalized
      var out = [];
      for (var i=0;i<idx.length;i++){
        var rec = idx[i];
        if (F.author && rec.nAll.indexOf(norm(F.author)) === -1) continue;
        if (F.year && String(rec.raw.year||"") !== String(F.year)) continue;

        // Stage 1: ranked scoring over title/summary/content + WHOLE ROW (nAll)
        var sc = 0, matched = false;
        for (var t=0;t<terms.length;t++){
          var qt = terms[t]; if (!qt) continue;
          if (rec.nTitle.indexOf(qt)   !== -1) { sc += 5; matched = true; }
          if (rec.nSummary.indexOf(qt) !== -1) { sc += 2; matched = true; }
          if (rec.nContent.indexOf(qt) !== -1) { sc += 2; matched = true; }
          if (rec.nAll.indexOf(qt)     !== -1) { sc += 1; matched = true; } // NEW: whole row fallback
        }
        // Exact year bonus
        var yTerm = nq.match(/\b(\d{4})\b/);
        if (yTerm && String(rec.raw.year) === yTerm[1]) { sc += 6; matched = true; }

        if (matched) out.push({sc:sc, raw:rec.raw});
      }
      out.sort(function(a,b){ return b.sc - a.sc; });
      if (out.length) return out.slice(0, limit||BOT_CFG.MAX_RESULTS);

      // Stage 2: ICU Arabic token containment on nAll
      if (isArabic(cleaned)){
       
